<!DOCTYPE html>

<html lang="ru" style="overflow-y: scroll !important; touch-action: pan-y !important;">

<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">
  <meta name="description" content="Хозтовары и мелочи оптом в Кара-Суу. Доставка, низкие цены.">
  <meta name="google-site-verification" content="KwaNctZFk2BMTScsvlO77JIV6KN4daZPJXP9XRcin9Q" />
  
  <!-- PWA и мобильное приложение -->
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Кербен">
  <meta name="theme-color" content="#4CAF50">
  
  <!-- Иконки для iOS (iPhone/iPad) -->
  <link rel="apple-touch-icon" href="icon-kerben.jpg">
  <link rel="apple-touch-icon" sizes="180x180" href="icon-kerben.jpg">
  <link rel="apple-touch-icon" sizes="152x152" href="icon-kerben.jpg">
  <link rel="apple-touch-icon" sizes="120x120" href="icon-kerben.jpg">
  
  <!-- Favicon с логотипом Кербен -->
  <link rel="icon" type="image/jpeg" href="icon-kerben.jpg">
  <title>Кербен - B2B Market</title>
  <style>
    /* КРИТИЧНЫЙ ФИКС: Принудительная прокрутка */
    html, body {
      overflow-y: scroll !important;
      overflow-x: hidden !important;
      position: static !important;
      height: auto !important;
      min-height: 100% !important;
      -webkit-overflow-scrolling: touch !important;
      touch-action: pan-y !important;
    }
    
    /* Блокировка прокрутки при открытии модального окна */
    html.modal-open, body.modal-open {
      overflow: hidden !important;
      touch-action: none !important;
      -webkit-overflow-scrolling: auto !important;
    }
    
    /* Отключение задержки 300мс на iOS */
    html {
      touch-action: pan-y !important;
      -webkit-touch-callout: none;
    }
    
    /* ========== ОПТИМИЗАЦИЯ ДЛЯ iOS ========== */
    @supports (-webkit-touch-callout: none) {
      input, textarea, select {
        font-size: 16px !important;
        -webkit-appearance: none !important;
        appearance: none !important;
        -webkit-tap-highlight-color: transparent !important;
      }
    }
    
    /* Форма добавления товара - МАКСИМАЛЬНАЯ ОПТИМИЗАЦИЯ */
    #addProductWindow {
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
      will-change: transform;
      contain: layout style paint;
      isolation: isolate;
    }
    
    /* Внутренний контейнер формы - изолирован от остального документа */
    #addProductWindow > div {
      contain: layout style paint;
      -webkit-overflow-scrolling: auto !important;
    }
    
    #addProductWindow input,
    #addProductWindow textarea,
    #addProductWindow select {
      border: 1px solid #ccc !important;
      border-radius: 6px !important;
      touch-action: manipulation !important;
      -webkit-tap-highlight-color: transparent !important;
      cursor: text !important;
      transition: none !important;
      -webkit-transition: none !important;
      animation: none !important;
      -webkit-animation: none !important;
    }
    
    #addProductWindow input:focus,
    #addProductWindow textarea:focus,
    #addProductWindow select:focus {
      border-color: #007bff !important;
      outline: none !important;
    }
    
    /* Оптимизация для мобильных */
    @media (hover: none) and (pointer: coarse) {
      /* КРИТИЧНО: Разрешаем вертикальную прокрутку на html и body */
      html, body {
        touch-action: pan-y !important;
      }
      
      /* Для остальных элементов - manipulation (но НЕ для html/body) */
      input, textarea, select, button, a {
        touch-action: manipulation !important;
        -webkit-tap-highlight-color: transparent !important;
      }
      
      input, textarea, select, button {
        min-height: 44px;
      }
      
      /* КРИТИЧЕСКАЯ ОПТИМИЗАЦИЯ: Отключаем все эффекты в форме на мобильных */
      #addProductWindow * {
        transition: none !important;
        animation: none !important;
        box-shadow: none !important;
        text-shadow: none !important;
        filter: none !important;
        backdrop-filter: none !important;
      }
      
      /* Увеличиваем область касания для карточек товаров */
      .card-qty-input {
        min-height: 48px !important;
        padding: 12px 8px !important;
      }
      
      .card-actions button {
        min-height: 48px !important;
        padding: 12px 16px !important;
      }
      
      .pack-btn {
        min-width: 48px !important;
        min-height: 48px !important;
      }
    }
    
    /* Фиксируем проблему со смещением при открытии клавиатуры на iOS */
    @supports (-webkit-touch-callout: none) {
      body.keyboard-open {
        position: fixed;
        width: 100%;
      }
    }
    
    /* Z-INDEX ИЕРАРХИЯ ДЛЯ ВСЕХ ОКОН 
     * ================================
     * 99999 - SweetAlert2 (поверх всего)
     * 9999  - Bottom navigation (ВСЕГДА ВИДИМО)
     * 9800  - Превью изображений (previewBlock)
     * 9750  - Вложенные модалки агентов (agentClientsListModal, clientsForAgentsModal)
     * 9700  - Вторичные модалки (editOrderModal, addItemToOrderModal, addExpenseModal, agentAuthModal)
     * 9650  - Админ-окна (ordersManagementWindow, addProductWindow, profitReportWindow, partnersOrdersWindow, agentProfitModal, agentsManagementModal)
     * 9550  - ordersFullscreenModal
     * 9500  - Основные окна (profileFullscreenModal, chatWindow, cartPage, favoritesPage, complaintWindow, suggestionWindow, becomeSellerWindow)
     * 9200  - adminChatWindow
     * 9000  - editProductModal
     * 
     * ВАЖНО: Все админ-окна должны иметь bottom:56px, чтобы не перекрывать нижнее меню
     */
    /* SweetAlert2 должен быть ВСЕГДА ПОВЕРХ ВСЕГО */
    .swal2-container {
      z-index: 99999 !important;
    }
    .swal2-backdrop-show {
      z-index: 99998 !important;
    }
    
    /* Стили для всех модальных окон - предотвращение прокрутки фона */
    #ordersManagementWindow,
    #addProductWindow,
    #profitReportWindow,
    #partnersOrdersWindow,
    #editOrderModal,
    #editProductModal,
    #agentProfitModal,
    #agentsManagementModal,
    #agentAuthModal,
    #agentClientsListModal,
    #clientsForAgentsModal,
    #chatWindow,
    #complaintWindow,
    #suggestionWindow,
    #becomeSellerWindow,
    #cartPage,
    #favoritesPage,
    #profileFullscreenModal,
    #ordersFullscreenModal,
    #adminChatWindow,
    #previewBlock {
      overscroll-behavior: contain !important;
      -webkit-overflow-scrolling: touch !important;
    }
    
    /* Сетка карточек: более компактная, чтобы помещалось больше товаров */
    .product-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:8px; padding:6px; }
  .product-card { background:#fff; border-radius:6px; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 1px 6px rgba(0,0,0,0.06); transition:transform .14s, box-shadow .14s; }
  .product-card:hover { transform: translateY(-6px); box-shadow:0 8px 24px rgba(0,0,0,0.12); }
  /* Более компактные фото: чуть меньше по высоте, центрируем содержимое */
  .product-card .card-image { width:100%; aspect-ratio:4/3; max-height:140px; overflow:hidden; background:#f8f8f8; display:flex; align-items:center; justify-content:center; padding:6px; position:relative; }
  .product-card .card-image img { width:100%; height:100%; object-fit:contain; display:block; }
  
  /* Оптимизация загрузки изображений */
  .product-card .card-image img {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    opacity: 0;
    transition: opacity 0.3s ease-in;
  }
  .product-card .card-image img[src] {
    background: none;
    animation: none;
  }
  .product-card .card-image img.loaded {
    opacity: 1;
  }
  
  @keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
  .product-card .card-body { padding:6px; display:flex; flex-direction:column; gap:6px; }
  .card-title { font-size:13px; color:#222; min-height:36px; }
  .card-price { font-size:16px; color:#e53935; font-weight:700; }
  .card-oldprice { font-size:13px; color:#888; text-decoration:line-through; margin-left:8px; }
  .card-actions { display:flex; gap:8px; align-items:center; }
  .card-actions button { background:linear-gradient(90deg,#ff7a00,#ff3b00); color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
  .card-actions button:disabled { background:#6c757d !important; cursor:not-allowed !important; opacity:0.7 !important; }
  .card-stock { font-size:12px; color:#333; margin-top:2px; }
  .card-stock.out { color:#dc3545; font-weight:700; }
  /* Стили для кнопок +/- управления пачками */
  .pack-controls { display:flex; gap:4px; align-items:center; justify-content:center; }
  .pack-btn { background:linear-gradient(90deg,#ff7a00,#ff3b00); color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:16px; font-weight:700; transition:all .2s; min-width:36px; }
  .pack-btn:hover { transform:scale(1.05); box-shadow:0 4px 12px rgba(255,87,34,0.4); }
  .pack-btn:active { transform:scale(0.95); }
  .pack-btn:disabled { background:#ccc !important; cursor:not-allowed !important; opacity:0.5 !important; }
  
  /* Анимация добавления в корзину для кнопок +/- */
  .pack-btn.adding { 
    animation: packBtnPulse 0.4s ease-out; 
    background: linear-gradient(90deg, #4caf50, #2e7d32) !important;
  }
  
  /* Стили для избранных товаров - как в Instagram */
  .favorite-btn {
    position: absolute;
    top: 4px;
    left: 4px;
    width: 36px;
    height: 36px;
    padding: 0;
    margin: 0;
    background: none !important;
    border: none !important;
    box-shadow: none !important;
    cursor: pointer;
    font-size: 24px;
    z-index: 10;
    transition: transform 0.1s ease;
    filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
    line-height: 36px;
    text-align: center;
    -webkit-tap-highlight-color: transparent;
  }
  .favorite-btn:active {
    transform: scale(0.8);
  }
  .favorite-btn.active {
    filter: drop-shadow(0 1px 4px rgba(233,30,99,0.5));
  }
  @keyframes heartPop {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
  }
  .favorite-btn.animate {
    animation: heartPop 0.3s ease;
  }
  @keyframes packBtnPulse {
    0% { transform: scale(1); }
    30% { transform: scale(1.3); }
    60% { transform: scale(0.9); }
    100% { transform: scale(1); }
  }
  
  /* Улучшенные стили для полей ввода количества в карточках */
  .card-qty-input {
    touch-action: manipulation !important;
    -webkit-tap-highlight-color: transparent !important;
    position: relative;
    z-index: 5;
  }
  
  .pack-qty-display { background:#fff; color:#333; padding:10px 8px; border-radius:8px; font-size:18px; font-weight:700; min-width:60px; text-align:center; border:2px solid #ce93d8; -webkit-user-select:text; user-select:text; -webkit-appearance:none; appearance:none; }
  .pack-qty-display:focus { outline:3px solid #7b1fa2; border-color:#7b1fa2; background:#fce4ec; }
  @media (max-width:700px){
  /* На маленьких экранах — две колонки и компактные фото */
  .product-grid{grid-template-columns: repeat(2,1fr); gap:6px;}
  .product-card .card-image{max-height:90px; aspect-ratio:1/1;}
    .card-actions .card-qty-input { padding:10px !important; font-size:16px !important; width:70px !important; align-self:center !important; min-height:44px !important; }
    .card-actions .card-qty-input::-webkit-outer-spin-button, .card-actions .card-qty-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .admin-product-btn { font-size:1.12rem; padding:12px 10px; border-radius:12px; width:auto; }
  }


  @media (max-width:420px){
    /* Очень узкие телефоны: делаем так, чтобы поле количества и кнопка были в одной строке */
    .product-grid{grid-template-columns: repeat(2,1fr); gap:6px;}
    .card-actions { flex-direction: row; gap:8px; align-items:center; justify-content:space-between; }
    .card-actions .card-qty-input { padding:12px !important; font-size:16px !important; width:60px !important; min-height:48px !important; }
    .card-actions button { padding:14px 16px !important; font-size:16px !important; border-radius:10px !important; width:auto !important; display:inline-block !important; min-height:48px !important; }
    .admin-product-btn { width:100% !important; }
    
    /* Увеличенные области касания для предотвращения неправильных нажатий */
    .pack-btn { min-width:50px !important; min-height:50px !important; }
  }

  /* ВРЕМЕННО ОТКЛЮЧЕНО - блокировка скролла
  body.modal-open {
    overflow: hidden !important;
    position: fixed !important;
    width: 100% !important;
    height: 100% !important;
    touch-action: none;
  }
  */

  /* Стили для checkbox чтобы галочка показывалась на мобильных */
  input[type="checkbox"] {
    -webkit-appearance: checkbox !important;
    -moz-appearance: checkbox !important;
    appearance: checkbox !important;
    width: 18px !important;
    height: 18px !important;
    min-width: 18px !important;
    min-height: 18px !important;
    cursor: pointer;
    accent-color: #4caf50;
  }
  
  /* Увеличенные checkbox в карточках товаров для удобства на телефонах */
  .product-card input[type="checkbox"],
  .card input[type="checkbox"] {
    width: 22px !important;
    height: 22px !important;
    min-width: 22px !important;
    min-height: 22px !important;
  }

  </style>

  <!-- Firebase SDKs: app first, then compat modules -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <!-- jsPDF для генерации PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <!-- SheetJS (XLSX) для экспорта в Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- EXIF.js для чтения ориентации изображений -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>

  <style>
@media (max-width: 600px) {
  .admin-product-input {
    font-size: 1.1rem;
    padding: 12px 10px;
    width: 100% !important;
    min-width: 0;
    margin: 6px 0;
    border-radius: 12px;
  }
  .admin-product-btn {
    font-size: 1.1rem;
    padding: 14px 0;
    width: 100%;
    margin: 6px 0;
    border-radius: 12px;
    min-width: 0;
    display: block;
  }
  .admin-product-row {
    display: flex;
    flex-direction: column;
    gap: 6px;
    border-radius: 14px;
    box-shadow: 0 2px 12px #007bff22;
    padding: 8px 0;
  }
  td, th {
    font-size: 1rem;
    padding: 8px 4px;
  }
}

/* Карточки товаров в заказе (в модалке «Показать товары») */
.order-items-cards {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.order-item-card {
  background: #fff;
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 4px rgba(0,0,0,0.06);
}
.order-item-card-title {
  padding: 12px 14px;
  font-weight: 800;
  color: #222;
  background: #f0f7ff;
  overflow-wrap: anywhere;
  word-break: break-word;
}
.order-item-card-body {
  padding: 12px 14px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px 12px;
}
.order-item-field {
  display: flex;
  justify-content: space-between;
  gap: 12px;
  align-items: center;
  min-width: 0;
}
.order-item-field .label {
  font-weight: 700;
  color: #666;
  flex: 0 0 auto;
}
.order-item-field .value {
  text-align: right;
  overflow-wrap: anywhere;
  word-break: break-word;
}
.order-item-actions {
  grid-column: 1 / -1;
  display: flex;
  justify-content: flex-end;
}
@media (max-width: 600px) {
  .order-item-card-body {
    grid-template-columns: 1fr;
  }
  .order-item-field {
    align-items: flex-start;
  }
}
/* --- Красивый редактор товаров для админа --- */
.admin-product-input {
  border: 2px solid #90bfff;
  border-radius: 8px;
  background: #fafdff;
  padding: 7px 10px;
  font-size: 16px !important;
  margin: 2px 0;
  box-shadow: 0 1px 6px #007bff11;
  /* iOS оптимизация */
  -webkit-appearance: none;
  appearance: none;
  transform: translateZ(0);
  -webkit-transform: translateZ(0);
  touch-action: manipulation;
  min-height: 44px;
}
/* На мобильных убираем transition для скорости */
@media (hover: none) and (pointer: coarse) {
  .admin-product-input {
    transition: none !important;
  }
}
@media (hover: hover) {
  .admin-product-input {
    transition: border 0.2s, box-shadow 0.2s;
  }
}
.admin-product-input:focus {
  border: 2px solid #007bff;
  box-shadow: 0 2px 12px #007bff33;
  background: #eaf4ff;
}
.admin-product-btn {
  background: linear-gradient(90deg,#007bff 60%,#00c6ff 100%);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 18px;
  font-size: 1rem;
  margin: 2px 2px;
  cursor: pointer;
  box-shadow: 0 2px 8px #007bff22;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}
/* Transition только для устройств с мышью */
@media (hover: hover) {
  .admin-product-btn {
    transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
  }
}
.admin-product-btn:hover {
  background: linear-gradient(90deg,#0056b3 60%,#00aaff 100%);
  box-shadow: 0 4px 16px #007bff33;
  transform: scale(1.04);
}
.admin-product-row {
  background: #f0f7ff;
  border-radius: 10px;
  box-shadow: 0 2px 8px #007bff11;
}
.order-form #cartList {
  background: #fafdff;
  border: 2px solid #90bfff;
  border-radius: 12px;
  box-shadow: 0 2px 8px #007bff11;
  padding: 8px 0 8px 0;
  position: relative;
}
.cart-scroll-hint {
  text-align: center;
  color: #007bff;
  font-size: 13px;
  margin-bottom: 4px;
  font-style: italic;
  letter-spacing: 0.5px;
}
/* Анимация удаления товара из корзины */
.cart-item-removing {
  opacity: 0;
  max-height: 0 !important;
  margin: 0 !important;
  padding: 0 !important;
  transition: opacity 0.3s, max-height 0.3s, margin 0.3s, padding 0.3s;
  overflow: hidden;
}

/* Стили для кнопок +/- в корзине */
.cart-page-item button:hover {
  transform: scale(1.05);
}
.cart-page-item button:active {
  transform: scale(0.95);
}

/* Адаптивные стили для корзины на мобильных */
@media (max-width: 600px) {
  .cart-page-item {
    padding: 10px !important;
    gap: 10px !important;
  }
  .cart-page-item img {
    width: 50px !important;
    height: 50px !important;
  }
  .cart-page-item .item-title {
    font-size: 13px !important;
  }
  .cart-page-item .item-price {
    font-size: 15px !important;
  }
}

/* Значок блокировки товара */
.blocked-badge {
  position: absolute;
  top: 5px;
  right: 5px;
  background: linear-gradient(135deg, #ff4444, #cc0000);
  color: white;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  font-size: 18px;
  z-index: 10;
  box-shadow: 0 2px 8px rgba(255, 0, 0, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  animation: pulseBlock 2s infinite;
}

/* Значок NEW для новых товаров */
.new-badge {
  position: absolute;
  bottom: 5px;
  left: 5px;
  background: linear-gradient(135deg, #00c853, #00e676);
  color: white;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: bold;
  z-index: 10;
  box-shadow: 0 2px 8px rgba(0, 200, 83, 0.4);
  animation: newBadgeGlow 2s infinite;
}

/* Значок ПАЧКА для товаров продающихся только пачками */
.pack-badge {
  position: absolute;
  top: 40px;
  right: 5px;
  background: linear-gradient(135deg, #9c27b0, #7b1fa2);
  color: white;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 10px;
  font-weight: bold;
  z-index: 9;
  box-shadow: 0 2px 8px rgba(156, 39, 176, 0.4);
  animation: packBadgePulse 2s infinite;
}

@keyframes packBadgePulse {
  0%, 100% {
    box-shadow: 0 2px 8px rgba(156, 39, 176, 0.4);
  }
  50% {
    box-shadow: 0 4px 12px rgba(156, 39, 176, 0.7);
  }
}

/* Стили для галереи фото товара */
.product-gallery-badge {
  position: absolute;
  bottom: 5px;
  right: 5px;
  background: linear-gradient(135deg, #2196f3, #1976d2);
  color: white;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 10px;
  font-weight: bold;
  z-index: 9;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(33, 150, 243, 0.4);
}

.product-gallery-badge:hover {
  transform: scale(1.1);
}

@keyframes newBadgeGlow {
  0%, 100% {
    box-shadow: 0 2px 8px rgba(0, 200, 83, 0.4);
  }
  50% {
    box-shadow: 0 4px 16px rgba(0, 230, 118, 0.8);
  }
}

@keyframes pulseBlock {
  0%, 100% {
    transform: scale(1);
    box-shadow: 0 2px 8px rgba(255, 0, 0, 0.4);
  }
  50% {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(255, 0, 0, 0.6);
  }
}

.order-form #cartList {
  max-height: 220px;
  overflow-y: auto;
  margin-bottom: 10px;
}
@media (max-width: 600px) {
  .order-form #cartList {
    max-height: 320px;
  }
}
.cart-item .delete-item {
  background: #dc3545 !important;
  color: #fff !important;
  border: none;
  font-size: 20px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  margin-left: 8px;
  transition: background 0.2s;
}
.cart-item .delete-item:hover {
  background: #b71c1c !important;
}
@media (max-width: 600px) {
  .cart-item .delete-item {
    display: block;
    width: 100% !important;
    height: 44px !important;
    font-size: 2rem;
    margin: 8px 0 0 0;
    border-radius: 12px;
  }
}


.search-sort-row {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  width: 100%;
  max-width: 600px;
}

/* Расширенный поиск с фильтрами */
.search-container {
  max-width: 800px;
  margin: 0 auto 15px;
  padding: 0 10px;
}

.search-main {
  display: flex;
  gap: 8px;
  margin-bottom: 10px;
}

.search-main input {
  flex: 1;
  padding: 12px 15px;
  border: 2px solid #e0e0e0;
  border-radius: 25px;
  font-size: 15px;
  outline: none;
  transition: border-color 0.2s;
}

.search-main input:focus {
  border-color: #ff6b35;
}

.search-main .search-btn {
  padding: 12px 20px;
  background: #ff6b35;
  color: white;
  border: none;
  border-radius: 25px;
  cursor: pointer;
  font-size: 15px;
  display: flex;
  align-items: center;
  gap: 5px;
}

/* Кнопка голосового поиска */
.search-main .voice-search-btn {
  padding: 12px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  font-size: 18px;
  width: 46px;
  height: 46px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.search-main .voice-search-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
}

.search-main .filter-toggle-btn {
  padding: 12px 15px;
  background: #f0f0f0;
  color: #333;
  border: none;
  border-radius: 25px;
  cursor: pointer;
  
}

.search-main .filter-toggle-btn.active {
  background: #ff6b35;
  color: white;
}

.search-filters {
  display: none;
  background: #f9f9f9;
  border-radius: 12px;
  padding: 15px;
  margin-top: 10px;
  animation: slideDown 0.2s ease-out;
}

.search-filters.show {
  display: block;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.filter-row {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
}

.filter-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.filter-group label {
  font-size: 12px;
  color: #666;
  font-weight: 600;
}

.filter-group input, .filter-group select {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  
  min-width: 100px;
}

.filter-group input[type="number"] {
  width: 90px;
}

.price-range {
  display: flex;
  align-items: center;
  gap: 8px;
}

.filter-actions {
  display: flex;
  gap: 8px;
  margin-left: auto;
}

.filter-apply-btn {
  padding: 8px 16px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
}

.filter-reset-btn {
  padding: 8px 16px;
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
}

.search-results-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 15px;
  background: #fff3e0;
  border-radius: 8px;
  margin-bottom: 10px;
  
}

.search-results-info .clear-search {
  color: #ff6b35;
  cursor: pointer;
  text-decoration: underline;
}

.search-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 10px;
}

.search-tag {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  background: #e3f2fd;
  border-radius: 15px;
  font-size: 12px;
  color: #1976d2;
}

.search-tag .remove-tag {
  cursor: pointer;
  font-weight: bold;
}

@media (max-width: 600px) {
  .filter-row {
    flex-direction: column;
    align-items: stretch;
  }
  .filter-group {
    width: 100%;
  }
  .filter-group input, .filter-group select {
    width: 100%;
  }
  .filter-actions {
    margin-left: 0;
    margin-top: 10px;
  }
  .search-main {
    flex-wrap: wrap;
  }
  .search-main input {
    width: 100%;
    flex: none;
  }
  .search-main .search-btn, .search-main .filter-toggle-btn {
    flex: 1;
  }
  
  /* Адаптация кнопки голосового поиска */
  .search-main .voice-search-btn {
    width: 42px;
    height: 42px;
    font-size: 16px;
    flex: none;
  }
}

/* Стили для категорий */
.category-tabs {
  display: flex;
  gap: 10px;
  margin: 10px auto 15px;
  max-width: 1200px;
  padding: 0 8px;
  flex-wrap: wrap;
  justify-content: center;
}
.category-btn {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  transition: all 0.3s ease;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.category-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}
.category-btn.active {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  box-shadow: 0 6px 12px rgba(245,87,108,0.4);
}
/* Стили для контейнера других категорий */
#otherCategoriesContainer {
  display: none;
  flex-wrap: wrap;
  gap: 10px;
  width: 100%;
}
#otherCategoriesContainer.visible {
  display: flex;
}

@media (max-width: 600px) {
  .category-tabs {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    column-gap: 6px;
    row-gap: 0px;
    padding: 0 8px;
    margin: 8px auto 12px;
  }
  .category-btn {
    padding: 10px 8px;
    
    width: 100%;
    min-width: 0;
    margin: 0;
  }
  #otherCategoriesContainer {
    grid-column: 1 / -1;
  }
  #otherCategoriesContainer.visible {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    column-gap: 6px;
    row-gap: 0px;
  }
}
/* --- Адаптивные стили как на https://kara-ssyy-oomat.github.io/meloch/ --- */
* { box-sizing: border-box; margin: 0; padding: 0; }
* {
  -webkit-tap-highlight-color: transparent;
}

html {
  overflow-x: hidden;
  overflow-y: scroll !important;
  -webkit-overflow-scrolling: touch;
  height: auto !important;
  min-height: 100%;
  touch-action: pan-y !important;
  position: static !important;
}

body {
  font-family: 'Arial', sans-serif;
  background: #FFF9E5;
  color: #333;
  overflow-x: hidden;
  overflow-y: auto !important;
  -webkit-overflow-scrolling: touch;
  min-height: 100vh;
  position: static !important;
  margin: 0;
  padding: 0;
  padding-bottom: 80px;
  touch-action: pan-y !important;
}

/* Предотвращение зума на iOS при фокусе на input */
input, select, textarea {
  font-size: 16px !important;
  -webkit-text-size-adjust: 100%;
  /* GPU ускорение для быстрого ввода на iOS */
  transform: translateZ(0);
  -webkit-transform: translateZ(0);
}

/* Специальная оптимизация для формы добавления товара на iPhone */
#addProductWindow input,
#addProductWindow textarea,
#addProductWindow select {
  font-size: 16px !important;
  -webkit-appearance: none;
  appearance: none;
  touch-action: manipulation;
  transform: translateZ(0);
  -webkit-transform: translateZ(0);
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  /* ПОЛНОЕ ОТКЛЮЧЕНИЕ transition - главная причина лагов */
  transition: none !important;
  -webkit-transition: none !important;
  animation: none !important;
  -webkit-animation: none !important;
  /* Минимальный размер для touch targets */
  min-height: 48px;
  padding: 14px !important;
  /* Изоляция элементов - предотвращает проблемы с касаниями */
  position: relative;
  z-index: 1;
  margin-top: 4px;
  margin-bottom: 4px;
  /* Отключаем тени и фильтры */
  box-shadow: none !important;
  filter: none !important;
  -webkit-filter: none !important;
  /* Оптимизация рендеринга */
  will-change: auto;
  contain: layout style;
}

/* Полное отключение анимаций внутри формы */
#addProductWindow,
#addProductWindow * {
  animation: none !important;
  -webkit-animation: none !important;
}

/* Увеличенные отступы между полями в форме */
#addProductWindow > div > div > div {
  gap: 18px !important;
}

/* Быстрая прокрутка без инерции внутри формы */
#addProductWindow > div {
  -webkit-overflow-scrolling: auto !important;
}

/* Кнопки в форме добавления товара */
#addProductWindow button {
  min-height: 48px;
  position: relative;
  z-index: 1;
  transition: none !important;
}

/* Дополнительное правило для всех вводимых полей с атрибутами */
input[type="text"],
input[type="number"],
input[type="tel"],
input[type="email"],
input[type="password"],
input[type="search"],
input[type="date"],
input[type="file"],
textarea,
select {
  font-size: 16px !important;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
}

/* Блокировка зума на всей странице */
* {
  -webkit-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
  text-size-adjust: 100%;
}

/* ВРЕМЕННО ОТКЛЮЧЕНО - блокировка скролла
body.modal-open {
  overflow: hidden !important;
  position: fixed !important;
  width: 100% !important;
  height: 100% !important;
  touch-action: none !important;
  -webkit-overflow-scrolling: none !important;
}
*/
h1, h2 {
  text-align: center;
  margin-bottom: 20px;
  animation: fadeIn 1s ease forwards;
  color: #fff;
}
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 8px;
}
.search-sort-row {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  width: 100%;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
}
.search-sort-row input,
.search-sort-row select,
.search-sort-row .other-site-btn {
  flex: 1 1 0;
  width: 100%;
  max-width: none;
  box-sizing: border-box;
  margin: 10px auto;
}
.other-site-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  background: #007bff;
  color: #fff !important;
  text-align: center;
  padding: 10px 0;
  border-radius: 5px;
  text-decoration: none;
  transition: background 0.2s;
  font-weight: bold;
  height: 100%;
}
.other-site-btn:hover {
  background: #0056b3;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
  background: white;
  box-shadow: 0 0 10px #ccc;
  overflow-x: auto;
  display: block;
  border-radius: 12px;
}
thead th {
  position: sticky;
  top: 0;
  background: #00fff7;
  z-index: 2;
}
th, td {
  padding: 10px;
  border: 1px solid #ddd;
  text-align: center;
  font-size: 15px;
}
th:nth-child(5), td:nth-child(5) {
  min-width: 90px;
  width: 80px;
}
.product-img {
  max-width: 60px;
  height: auto;
  transition: transform 0.2s, box-shadow 0.2s;
  border-radius: 8px;
}
.product-img:hover {
  transform: scale(1.08);
  box-shadow: 0 4px 16px #0002;
}
.cart-item {
  display: flex;
  align-items: center;
  gap: 0;
  margin-bottom: 8px;
  padding: 4px 0;
  border-bottom: 1px solid #f0f0f0;
}
.cart-item-compact {
  gap: 0;
  padding: 2px 0;
  min-height: 40px;
  align-items: center;
}
.cart-mini-img {
  width: 24px;
  height: 24px;
  object-fit: cover;
  border-radius: 6px;
  margin-right: 8px;
  flex-shrink: 0;
  background: #f8f8f8;
  box-shadow: 0 1px 4px #0001;
  display: block;
}
.cart-title {
  flex: 1 1 auto;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.cart-qty, .cart-price, .cart-sum {
  margin: 0 8px;
  white-space: nowrap;
}
.cart-sum {
  font-weight: bold;
}
.cart-item-compact {
  gap: 0;
  padding: 2px 0;
  min-height: 36px;
}
.cart-mini-img {
  width: 32px;
  height: 32px;
  object-fit: cover;
  border-radius: 6px;
  margin-right: 8px;
  flex-shrink: 0;
  background: #f8f8f8;
  box-shadow: 0 1px 4px #0001;
}
.cart-title {
  flex: 1 1 auto;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.cart-qty, .cart-price, .cart-sum {
  margin: 0 8px;
  white-space: nowrap;
}
.cart-sum {
  font-weight: bold;
}
.order-form, #orderHistory {
  background: #cce4ff;
  padding: 22px 18px 22px 18px;
  border-radius: 16px;
  box-shadow: 0 4px 24px #007bff22, 0 1.5px 0 #007bff inset;
  margin-top: 20px;
}
input, select, button, textarea {
  font-size: 1rem;
  padding: 10px;
  margin: 10px auto;
  width: 100%;
  max-width: 400px;
  display: block;
  border-radius: 5px;
  border: 1px solid #ccc;
}
button, .other-site-btn {
  border-radius: 8px;
  box-shadow: 0 2px 8px #0001;
  transition: background 0.2s, color 0.2s;
}
button:active {
  transform: scale(0.97);
}
button {

  background: #28a745;
  color: white;
  border: none;
  cursor: pointer;
  transition: 0.3s;
}

  button:hover { background: #218838; }
.delete-order {
  background: #dc3545;
  color: white;
  border: none;
  padding: 8px 12px;
  margin-bottom: 6px;
  margin-top: 10px;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.3s ease;
}
  /* Исправлено: всё ниже обёрнуто в .cart-mini-img */

.cart-mini-img {
  border-radius: 6px;
  margin-right: 8px;
  flex-shrink: 0;
  background: #fff;
  box-shadow: 0 1px 4px #007bff33;
  display: block;
  border: 2px solid #007bff;
}

button.delete-item:hover {
  color: #c82333;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes addToCart {
  0% { transform: scale(1); background-color: #28a745; }
  50% { transform: scale(1.2); background-color: #218838; }
  100% { transform: scale(1); background-color: #28a745; }
}
@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.1); opacity: 0.8; }
}
@keyframes slideInRight {
  from { transform: translateX(400px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOutRight {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(400px); opacity: 0; }
}
.animate-add {
  animation: addToCart 0.5s ease;
}
@media (max-width: 600px) {
  body {
    font-size: 1.05rem;
    padding-bottom: 60px;
  }
  .container {
    max-width: 100vw;
    padding: 0 2vw;
  }
  .order-form, #orderHistory {
    padding: 10px 2vw;
    margin-top: 10px;
    box-shadow: 0 2px 8px #0001;
    border-radius: 10px;
  }
  .order-form input, .order-form button {
    width: 100%;
    min-height: 44px;
    font-size: 1rem;
    margin-bottom: 10px;
  }
  .search-sort-row {
    flex-direction: column;
    gap: 0;
    max-width: 100vw;
    padding: 0 2vw;
  }
  .other-site-btn {
    font-size: 1rem;
    padding: 12px 0;
    margin-top: 8px;
    border-radius: 8px;
  }
  table {
    display: block;
    width: 100vw;
    overflow-x: auto;
    border-radius: 10px;
    box-shadow: 0 2px 8px #0001;
  }
  thead, tbody, tr {
    display: table;
    width: 100%;
    table-layout: fixed;
  }
  th, td {
    font-size: 13px;
    padding: 7px 4px;
    min-width: 70px;
    word-break: break-word;
  }
  th:nth-child(2), td:nth-child(2) {
    min-width: 60px;
    max-width: 70px;
  }
  .product-img {
    max-width: 70px;
    min-width: 44px;
    width: 100%;
    height: auto;
    display: block;
    margin: 0 auto 6px auto;
    border-radius: 8px;
    box-shadow: 0 2px 8px #007bff22;
    background: #fff;
    object-fit: contain;
  }
  .cart-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
    font-size: 0.98rem;
  }
  .cart-summary {
    font-size: 1.1rem;
    margin: 8px 0;
  }
  #cartList div {
    font-size: 0.98rem;
    padding: 4px 0;
  }
  button, .order-form button, .other-site-btn {
    min-height: 44px;
    font-size: 1rem;
    padding: 10px 0;
  }
  .scroll-buttons {
    right: 10px;
    bottom: 10px;
    gap: 6px;
  }
  .scroll-buttons button {
    font-size: 18px;
    padding: 10px 14px;
    border-radius: 12px;
  }
  #previewInner {
    width: 96vw !important;
    left: 2vw !important;
    transform: none !important;
    padding: 6vw 2vw !important;
  }
  #previewImg {
    max-width: 92vw !important;
    max-height: 60vh !important;
  }
  #toggleHistory, #logoutUser {
    width: 100%;
    min-height: 44px;
    font-size: 1rem;
    margin: 8px 0;
  }
  #orderHistory h2 {
    font-size: 1.1rem;
    margin-bottom: 10px;
  }
  #historyList li {
  font-size: 0.98rem;
  margin-bottom: 10px;
  padding: 8px 4px;
  border-radius: 8px;
  box-shadow: 0 1px 4px #0001;
}
}

@keyframes addToCart {
  0% { transform: scale(1); background-color: #28a745; }
  50% { transform: scale(1.2); background-color: #218838; }
  100% { transform: scale(1); background-color: #28a745; }
}

    .animate-add {

      animation: addToCart 0.5s ease;

    }



    @media (max-width: 600px) {

      th, td { font-size: 12px; padding: 6px; }

      input, select, button, textarea { font-size: 0.9rem; padding: 8px; }

      .cart-summary { font-size: 1.2rem; }

      #cartList div { font-size: 0.9rem; }

      .order-form input, .order-form button { width: 90%; }

    }
    @media (max-width: 600px) {
  button.delete-item {
    width: 20px; /* Устанавливаем фиксированную ширину */
    height: 20px; /* Устанавливаем фиксированную высоту */
    font-size: 12px; /* Уменьшаем размер текста */
    padding: 0; /* Убираем лишние отступы */
  }
}

    @media (max-width: 600px) {
  th, td { font-size: 12px; padding: 6px; }
  input, select, button, textarea { font-size: 0.9rem; padding: 8px; }
  .cart-summary { font-size: 1.2rem; }
  #cartList div { font-size: 0.9rem; }
  .order-form input, .order-form button { width: 90%; }
  button.delete-item {
    width: 20px;
    height: 20px;
    font-size: 12px;
    padding: 0;
  }
}

/* ===== Админ: Заказы клиентов / Товары в заказе (адаптив) ===== */
@media (max-width: 600px) {
  /* Админские окна на весь экран для телефона - оставляем место для нижнего меню */
  #ordersManagementWindow > div,
  #addItemToOrderModal > div {
    width: 100% !important;
    height: 100% !important;
    max-height: 100% !important;
    margin: 0 !important;
    border-radius: 0 !important;
  }
  
  /* Окно товаров заказа - занимает всё доступное пространство */
  #orderItemsDetailModal > div {
    width: 100% !important;
    height: 100% !important;
    max-height: 100% !important;
    margin: 0 !important;
    border-radius: 0 !important;
  }
  
  #ordersManagementWindow .orders-filters {
    gap: 6px !important;
  }
  #ordersManagementWindow .orders-filters input,
  #ordersManagementWindow .orders-filters select {
    padding: 8px !important;
    font-size: 13px !important;
  }
  #orderItemsDetailContent {
    padding: 12px !important;
  }
  /* Карточки заказов */
  .order-card {
    margin-bottom: 10px !important;
  }
}

/* Адаптивная таблица «Товары в заказе»: на телефоне строки становятся карточками */
@media (max-width: 600px) {
  .order-items-table {
    width: 100% !important;
    border-collapse: collapse !important;
  }
  .order-items-table thead {
    display: none !important;
  }
  .order-items-table,
  .order-items-table tbody,
  .order-items-table tr,
  .order-items-table td {
    display: block !important;
    width: 100% !important;
  }
  .order-items-table tr {
    border: 1px solid #e0e0e0 !important;
    border-radius: 12px !important;
    margin-bottom: 12px !important;
    overflow: hidden !important;
    background: #fff !important;
  }
  .order-items-table td {
    display: flex !important;
    justify-content: space-between !important;
    align-items: flex-start !important;
    gap: 12px !important;
    padding: 10px 12px !important;
    border-bottom: 1px solid #f0f0f0 !important;
    text-align: left !important;
    flex-wrap: wrap !important;
    min-width: 0 !important;
  }
  .order-items-table td:last-child {
    border-bottom: none !important;
  }
  .order-items-table td::before {
    content: attr(data-label);
    font-weight: 700;
    color: #666;
    flex: 0 0 auto;
  }
  .order-items-table .cell-value {
    flex: 1 1 auto;
    min-width: 0;
    overflow-wrap: anywhere;
    word-break: break-word;
    white-space: normal;
    text-align: right;
  }
  .order-items-table .cell-value-left {
    text-align: left;
  }
  .order-items-table .cell-actions {
    justify-content: flex-end !important;
  }

  /* Название товара: на всю ширину экрана без "пустого места справа" */
  .order-items-table td.cell-title {
    display: block !important;
    width: 100% !important;
    padding: 12px !important;
    text-align: left !important;
    font-size: 15px !important;
    font-weight: 600 !important;
    background: #f0f7ff !important;
    border-bottom: 1px solid #e0e0e0 !important;
  }
  .order-items-table td.cell-title::before {
    display: none !important;
  }
  .order-items-table td.cell-title .cell-value,
  .order-items-table td.cell-title .cell-value-left {
    display: block !important;
    width: 100% !important;
    text-align: left !important;
    white-space: normal !important;
    overflow: visible !important;
    overflow-wrap: anywhere !important;
    word-break: break-word !important;
  }
}

/* Стиль для названия товара на десктопе */
.product-name-cell {
  padding: 12px;
  
  font-weight: 600;
}

/* --- Мобильная адаптация окна «Отчет по прибыли» --- */
@media (max-width: 600px) {
  #profitReportWindow {
    padding: 0 !important;
  }
  #profitReportWindow > div {
    width: 100% !important;
    max-width: 100% !important;
    height: calc(100vh - 56px) !important;
    height: calc(100dvh - 56px) !important;
    margin: 0 !important;
    border-radius: 0 !important;
    display: flex !important;
    flex-direction: column !important;
    padding-bottom: 56px !important;
  }

  #profitReportWindow .profit-header {
    padding: 14px !important;
    flex-shrink: 0;
  }
  #profitReportWindow .profit-header h2 {
    font-size: 18px !important;
  }
  #profitReportWindow .profit-header p {
    font-size: 11px !important;
  }
  #profitReportWindow .profit-header button {
    width: 36px !important;
    height: 36px !important;
    font-size: 26px !important;
  }

  #profitReportWindow .profit-filters {
    padding: 10px !important;
    flex-shrink: 0;
    max-height: 45vh;
    overflow-y: auto;
  }

  #profitReportWindow .profit-tabs {
    flex-wrap: wrap !important;
    gap: 6px !important;
    margin-bottom: 10px !important;
  }
  #profitReportWindow .profit-tabs button {
    flex: 1 1 30% !important;
    padding: 10px 8px !important;
    font-size: 12px !important;
  }

  /* Сводка - горизонтальный скролл */
  #profitReportWindow .profit-filters > div > div[style*="grid"] {
    display: flex !important;
    flex-wrap: nowrap !important;
    overflow-x: auto !important;
    gap: 10px !important;
    padding-bottom: 8px !important;
    -webkit-overflow-scrolling: touch;
  }
  #profitReportWindow .profit-filters > div > div[style*="grid"] > div {
    flex: 0 0 auto !important;
    min-width: 120px !important;
    padding: 10px !important;
  }
  #profitReportWindow .profit-filters > div > div[style*="grid"] > div > div:first-child {
    font-size: 10px !important;
  }
  #profitReportWindow .profit-filters > div > div[style*="grid"] > div > div:last-child {
    font-size: 18px !important;
  }

  #profitReportWindow .profit-controls {
    flex-direction: column !important;
    align-items: stretch !important;
    gap: 8px !important;
  }
  #profitReportWindow .profit-controls > * {
    width: 100% !important;
  }
  #profitReportWindow .profit-controls select {
    padding: 10px !important;
    font-size: 14px !important;
  }
  #profitReportWindow .profit-controls button {
    white-space: normal !important;
    padding: 12px !important;
  }

  /* Таблицы - область прокрутки */
  #profitReportWindow .profit-table-wrap {
    padding: 8px !important;
    flex: 1 !important;
    min-height: 0 !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    -webkit-overflow-scrolling: touch;
  }

  /* Карточный вид таблиц */
  #profitReportWindow .profit-table-cards table,
  #profitReportWindow .profit-table-cards thead,
  #profitReportWindow .profit-table-cards tbody,
  #profitReportWindow .profit-table-cards th,
  #profitReportWindow .profit-table-cards tr,
  #profitReportWindow .profit-table-cards td {
    display: block !important;
    width: 100% !important;
  }
  #profitReportWindow .profit-table-cards thead {
    display: none !important;
  }
  #profitReportWindow .profit-table-cards tbody {
    display: flex !important;
    flex-direction: column !important;
    gap: 10px !important;
  }
  #profitReportWindow .profit-table-cards tr {
    background: white !important;
    border: 1px solid #e0e0e0 !important;
    border-radius: 12px !important;
    overflow: hidden !important;
    margin-bottom: 0 !important;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08) !important;
  }
  #profitReportWindow .profit-table-cards td {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    gap: 10px !important;
    padding: 10px 14px !important;
    border-bottom: 1px solid #f0f0f0 !important;
    text-align: right !important;
    font-size: 14px !important;
  }
  #profitReportWindow .profit-table-cards td:last-child {
    border-bottom: none !important;
  }
  #profitReportWindow .profit-table-cards td::before {
    content: attr(data-label);
    font-weight: 600;
    color: #555;
    text-align: left;
    flex-shrink: 0;
    font-size: 13px;
  }
  
  /* Название товара - ЗАГОЛОВОК карточки на ВСЮ ШИРИНУ */
  #profitReportWindow .profit-table-cards td[data-label="Товар"],
  #profitReportWindow .profit-table-cards td.product-name-cell {
    display: block !important;
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
    text-align: center !important;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    font-size: 16px !important;
    font-weight: 700 !important;
    padding: 14px 10px !important;
    border-bottom: none !important;
  }
  #profitReportWindow .profit-table-cards td[data-label="Товар"]::before,
  #profitReportWindow .profit-table-cards td.product-name-cell::before {
    content: none !important;
    display: none !important;
  }
  
  /* Скрыть номер строки на мобильных */
  #profitReportWindow .profit-table-cards td[data-label="#"] {
    display: none !important;
  }
  
  #profitReportWindow .profit-table-cards td[colspan] {
    display: block !important;
    text-align: left !important;
    padding: 14px !important;
  }
  #profitReportWindow .profit-table-cards td[colspan]::before {
    display: none !important;
  }
  
  /* Скрытые строки заказов на мобильных тоже в карточном виде */
  #profitReportWindow .profit-table-cards tr[class^="client-"] td {
    padding: 8px 12px !important;
    font-size: 13px !important;
  }
  #profitReportWindow .profit-table-cards tr[class^="client-"] td[colspan] {
    padding: 10px 12px !important;
  }
  
  /* === Модальное окно деталей заказов клиента === */
  #clientOrdersDetailModal > div {
    width: 100% !important;
    max-width: 100% !important;
    height: calc(100vh - 56px) !important;
    height: calc(100dvh - 56px) !important;
    max-height: calc(100vh - 56px) !important;
    margin: 0 !important;
    border-radius: 0 !important;
    padding-bottom: 56px !important;
  }
  
  #clientOrdersDetailModal > div > div:first-child {
    padding: 14px !important;
  }
  #clientOrdersDetailModal > div > div:first-child h2 {
    font-size: 18px !important;
  }
  #clientOrdersDetailModal > div > div:first-child p {
    font-size: 12px !important;
  }
  
  /* Сводка в модальном окне */
  #clientOrdersDetailModal > div > div:nth-child(2) {
    padding: 10px !important;
  }
  #clientOrdersDetailModal > div > div:nth-child(2) > div {
    display: flex !important;
    flex-wrap: nowrap !important;
    overflow-x: auto !important;
    gap: 8px !important;
    -webkit-overflow-scrolling: touch;
  }
  #clientOrdersDetailModal > div > div:nth-child(2) > div > div {
    flex: 0 0 auto !important;
    min-width: 100px !important;
    padding: 10px !important;
  }
  #clientOrdersDetailModal > div > div:nth-child(2) > div > div > div:first-child {
    font-size: 10px !important;
  }
  #clientOrdersDetailModal > div > div:nth-child(2) > div > div > div:last-child {
    font-size: 18px !important;
  }
  
  /* Список заказов */
  #clientOrdersDetailList {
    padding: 10px !important;
  }
  #clientOrdersDetailList > div {
    padding: 12px !important;
    margin-bottom: 12px !important;
  }
  
  /* Таблицы товаров в заказах клиента - карточный вид */
  #clientOrdersDetailList table {
    display: block !important;
    width: 100% !important;
  }
  #clientOrdersDetailList thead {
    display: none !important;
  }
  #clientOrdersDetailList tbody {
    display: flex !important;
    flex-direction: column !important;
    gap: 8px !important;
  }
  #clientOrdersDetailList tbody tr {
    display: flex !important;
    flex-wrap: wrap !important;
    background: white !important;
    border: 1px solid #e0e0e0 !important;
    border-radius: 10px !important;
    padding: 10px !important;
    gap: 6px !important;
  }
  #clientOrdersDetailList tbody tr td {
    padding: 4px 8px !important;
    font-size: 13px !important;
    border: none !important;
  }
  /* Название товара - на всю ширину */
  #clientOrdersDetailList tbody tr td:nth-child(2) {
    width: 100% !important;
    font-size: 15px !important;
    font-weight: 700 !important;
    color: #333 !important;
    background: #f0f0f0 !important;
    border-radius: 6px !important;
    padding: 8px !important;
    order: -1 !important;
  }
  /* Скрыть номер */
  #clientOrdersDetailList tbody tr td:first-child {
    display: none !important;
  }
  /* Итого строка */
  #clientOrdersDetailList > div > div:last-child {
    flex-direction: column !important;
    gap: 8px !important;
    align-items: flex-start !important;
  }
  #clientOrdersDetailList > div > div:last-child > div {
    font-size: 14px !important;
  }
  
  /* === Модальное окно товаров заказа === */
  #orderItemsDetailModal > div {
    width: 100% !important;
    max-width: 100% !important;
    height: 100% !important;
    max-height: 100% !important;
    margin: 0 !important;
    border-radius: 0 !important;
  }
  
  /* === Окно прибыли агента - адаптация === */
  #agentProfitModal .grid {
    grid-template-columns: 1fr !important;
  }
  #agentPeriodFilter, #agentStatusFilter {
    width: 100% !important;
  }
}
  </style>
      



  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- Chart.js для графиков -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
    // КРИТИЧНО: Принудительно разблокируем прокрутку при загрузке
    (function() {
      // Сразу убираем блокирующие классы и стили
      document.addEventListener('DOMContentLoaded', function() {
        document.body.classList.remove('modal-open');
        document.body.classList.remove('scroll-locked');
        document.body.style.overflow = '';
        document.body.style.position = '';
        document.body.style.top = '';
        document.body.style.width = '';
        document.body.style.height = '';
        document.documentElement.style.overflow = '';
        document.documentElement.classList.remove('modal-open');
        console.log('✓ Прокрутка разблокирована при загрузке');
      });
    })();
  </script>

</head>

<body style="overflow-y: scroll !important; position: static !important; height: auto !important; touch-action: pan-y !important;">
  <!-- Кнопка корзины -->
  <button id="cartFloatBtn" style="position:fixed;left:20px;bottom:20px;z-index:9500;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;border-radius:16px;width:auto;min-width:60px;height:56px;padding:0 16px;box-shadow:0 4px 20px rgba(102,126,234,0.4);display:flex;align-items:center;justify-content:center;gap:8px;font-size:22px;cursor:pointer;transition:all 0.3s;">
    <span style="font-size:24px;">🛒</span>
    <span id="cartFloatCount" style="background:#fff;color:#764ba2;border-radius:12px;padding:4px 10px;font-size:15px;font-weight:bold;min-width:24px;text-align:center;">0</span>
  </button>

  <!-- Блок для просмотра фото -->
  <div id="previewBlock" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:9800; pointer-events:auto; background: rgba(0,0,0,0.85);">
    <div id="previewInner" style="position:relative; background:white; padding:12px; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,0.5); max-width:95vw; max-height:95vh; display:flex; flex-direction:column; align-items:center;">
      <span id="closePreview" style="position:absolute; top:8px; right:8px; cursor:pointer; font-size:28px; background:#eee; width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:50%; z-index:10;">&times;</span>
      <div style="text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%;">
        <img id="previewImg" src="" alt="Просмотр" style="max-width:90vw; max-height:80vh; display:block; object-fit:contain;">
        <div id="previewCaption" style="margin-top:12px;  color:#333; font-weight:500;"></div>
      </div>
    </div>
  </div>

  <!-- Модальное окно редактирования товара -->
  <div id="editProductModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; width:100%; height:100%; z-index:9000; background:rgba(0,0,0,0.7); overflow-y:auto; overscroll-behavior:contain; -webkit-overflow-scrolling:touch;">
    <div style="max-width:500px; margin:20px auto; background:white; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,0.3); overflow:hidden;">
      <!-- Шапка -->
      <div style="background:linear-gradient(135deg,#007bff,#0056b3); color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:10;">
        <h3 style="margin:0; font-size:18px;">✏️ Редактирование товара</h3>
        <button onclick="closeEditProductModal()" style="background:rgba(255,255,255,0.2); border:none; color:white; width:36px; height:36px; border-radius:50%; cursor:pointer; font-size:20px;">✕</button>
      </div>
      <!-- Содержимое -->
      <div id="editProductContent" style="padding:20px;"></div>
    </div>
  </div>

  <!-- Окно чата (открывается из меню) -->
  <div id="chatWindow" style="display:none; position:fixed; top:0; left:0; right:0; bottom:44px; background:#f5f5f5; z-index:9500; flex-direction:column; overflow:hidden;">
    
    <!-- Сообщения -->
    <div id="chatMessages" style="flex:1; overflow-y:auto; padding:16px; background:#f5f5f5; display:flex; flex-direction:column; gap:12px;">
      <div style="background:white; padding:12px; border-radius:12px 12px 12px 4px; max-width:80%; align-self:flex-start; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <div style=" color:#333;">Здравствуйте! Чем могу помочь?</div>
        <div style="font-size:11px; color:#999; margin-top:4px;">Продавец • только что</div>
      </div>
    </div>
    
    <!-- Поле ввода -->
    <div style="padding:16px; background:white; border-top:1px solid #e0e0e0; display:flex; gap:12px; box-shadow:0 -2px 8px rgba(0,0,0,0.05);">
      <input id="chatInput" type="text" placeholder="Введите сообщение..." style="flex:1; padding:14px 18px; border:1px solid #ddd; border-radius:24px; outline:none; font-size:16px;" onkeypress="if(event.key==='Enter') sendChatMessage()">
      <button onclick="sendChatMessage()" style="background:#333; color:white; border:none; border-radius:50%; width:50px; height:50px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </div>

  <!-- Модальное окно жалобы -->
  <div id="complaintWindow" style="display:none; position:fixed; top:0; left:0; right:0; bottom:44px; background:#f5f5f5; z-index:9500;">
    <div style="height:100%; display:flex; flex-direction:column;">
      
      <!-- Шапка -->
      <div style="background:#fff; padding:15px 20px; border-bottom:1px solid #e0e0e0; display:flex; justify-content:space-between; align-items:center; flex-shrink:0;">
        <div style="font-size:17px; font-weight:600; color:#333;">Жалоба</div>
        <button onclick="closeComplaintWindow()" style="background:none; border:none; color:#666; font-size:24px; cursor:pointer;">✕</button>
      </div>

      <!-- Форма -->
      <div style="flex:1; overflow-y:auto; padding:20px; background:#fff;">
        <div style="display:flex; flex-direction:column; gap:15px;">
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Ваше имя:</label>
            <input type="text" id="complaintName" placeholder="Введите ваше имя" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Телефон:</label>
            <input type="tel" id="complaintPhone" placeholder="+996 XXX XXX XXX" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Тема жалобы:</label>
            <select id="complaintCategory" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
              <option value="">Выберите категорию</option>
              <option value="quality">Качество товара</option>
              <option value="delivery">Проблемы с доставкой</option>
              <option value="service">Обслуживание</option>
              <option value="price">Неверная цена</option>
              <option value="other">Другое</option>
            </select>
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Описание проблемы:</label>
            <textarea id="complaintText" placeholder="Подробно опишите вашу проблему..." style="width:100%; min-height:120px; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box; resize:vertical;"></textarea>
          </div>
        </div>
      </div>

      <!-- Кнопка отправки -->
      <div style="padding:15px 20px; background:#fff; border-top:1px solid #e0e0e0; flex-shrink:0;">
        <button onclick="sendComplaint()" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:15px;">Отправить жалобу</button>
      </div>
    </div>
  </div>

  <!-- Окно предложения товара -->
  <div id="suggestionWindow" style="display:none; position:fixed; top:0; left:0; right:0; bottom:44px; background:#f5f5f5; z-index:9500;">
    <div style="height:100%; display:flex; flex-direction:column; position:relative;">
      <!-- Заголовок -->
      <div style="background:#fff; padding:15px 20px; border-bottom:1px solid #e0e0e0; display:flex; justify-content:space-between; align-items:center; flex-shrink:0;">
        <div style="font-size:17px; font-weight:600; color:#333;">Предложить товар</div>
        <button onclick="closeSuggestionWindow()" style="background:none; border:none; color:#666; font-size:24px; cursor:pointer;">✕</button>
      </div>

      <!-- Форма -->
      <div style="flex:1; overflow-y:auto; padding:20px; background:#fff;">
        <div style="display:flex; flex-direction:column; gap:15px;">
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Ваше имя:</label>
            <input type="text" id="suggestionName" placeholder="Введите ваше имя" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Телефон:</label>
            <input type="tel" id="suggestionPhone" placeholder="+996 XXX XXX XXX" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Название товара:</label>
            <input type="text" id="suggestionProductName" placeholder="Какой товар вы хотите видеть?" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">За сколько сейчас покупаете:</label>
            <input type="number" id="suggestionCurrentPrice" placeholder="Текущая цена у другого продавца" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Желаемая цена:</label>
            <input type="number" id="suggestionPrice" placeholder="За сколько вы готовы купить?" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Описание:</label>
            <textarea id="suggestionDescription" placeholder="Опишите подробности..." style="width:100%; min-height:100px; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box; resize:vertical;"></textarea>
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Фото товара (необязательно):</label>
            <input type="file" id="suggestionPhoto" accept="image/*" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box; background:white;">
          </div>
        </div>
      </div>

      <!-- Кнопка отправки -->
      <div style="padding:15px 20px; background:#fff; border-top:1px solid #e0e0e0; flex-shrink:0;">
        <button id="suggestionSubmitBtn" onclick="sendSuggestion()" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:15px;">Отправить предложение</button>
      </div>
      
      <!-- Индикатор загрузки -->
      <div id="suggestionLoader" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:10; justify-content:center; align-items:center; flex-direction:column;">
        <div style="width:50px; height:50px; border:5px solid #e0e0e0; border-top:5px solid #333; border-radius:50%; animation:spin 1s linear infinite;"></div>
        <p style="margin-top:20px; color:#333; font-size:16px; font-weight:600;">Отправка...</p>
      </div>
    </div>
  </div>

  <!-- Окно "Стать продавцом" -->
  <div id="becomeSellerWindow" style="display:none; position:fixed; top:0; left:0; right:0; bottom:44px; background:#f5f5f5; z-index:9500;">
    <div style="height:100%; display:flex; flex-direction:column; position:relative;">
      <!-- Заголовок -->
      <div style="background:#fff; padding:15px 20px; border-bottom:1px solid #e0e0e0; display:flex; justify-content:space-between; align-items:center; flex-shrink:0;">
        <div style="font-size:17px; font-weight:600; color:#333;">Стать продавцом</div>
        <button onclick="closeBecomeSellerWindow()" style="background:none; border:none; color:#666; font-size:24px; cursor:pointer;">✕</button>
      </div>

      <!-- Переключатель вкладок -->
      <div style="display:flex; border-bottom:1px solid #e0e0e0; background:#fff; flex-shrink:0;">
        <button id="sellerTabRegister" onclick="switchSellerTab('register')" style="flex:1; padding:12px; background:#333; color:white; border:none; cursor:pointer; font-weight:600;">Регистрация</button>
        <button id="sellerTabLogin" onclick="switchSellerTab('login')" style="flex:1; padding:12px; background:#f5f5f5; color:#333; border:none; cursor:pointer; font-weight:600;">Вход</button>
      </div>

      <!-- Форма регистрации -->
      <div id="sellerRegisterForm" style="flex:1; overflow-y:auto; padding:20px; background:#fff;">
        <div style="display:flex; flex-direction:column; gap:15px;">
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">ФИО / Название компании:</label>
            <input type="text" id="sellerName" placeholder="Введите ваше имя или название компании" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Телефон (для входа):</label>
            <input type="tel" id="sellerPhone" placeholder="+996 XXX XXX XXX" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Пароль:</label>
            <input type="password" id="sellerPassword" placeholder="Придумайте пароль (мин. 4 символа)" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Город/Регион:</label>
            <input type="text" id="sellerCity" placeholder="Например: Бишкек, Ош" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Какие товары хотите продавать:</label>
            <input type="text" id="sellerProducts" placeholder="Категории товаров" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Telegram ID:</label>
            <input type="text" id="sellerTelegramId" placeholder="Например: 123456789" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
            <p style="margin:5px 0 0; font-size:11px; color:#888;">Узнайте ID у @userinfobot в Telegram</p>
          </div>
        </div>
        
        <!-- Кнопка регистрации -->
        <div style="margin-top:20px;">
          <button id="sellerSubmitBtn" onclick="registerSeller()" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:15px;">Зарегистрироваться</button>
        </div>
      </div>

      <!-- Форма входа -->
      <div id="sellerLoginForm" style="display:none; flex:1; overflow-y:auto; padding:20px; background:#fff;">
        <div style="display:flex; flex-direction:column; gap:15px;">
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Телефон:</label>
            <input type="tel" id="sellerLoginPhone" placeholder="+996 XXX XXX XXX" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Пароль:</label>
            <input type="password" id="sellerLoginPassword" placeholder="Введите пароль" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;" onkeypress="if(event.key==='Enter') loginSeller()">
          </div>
        </div>
        
        <!-- Кнопка входа -->
        <div style="margin-top:20px;">
          <button onclick="loginSeller()" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:15px;">Войти</button>
        </div>
      </div>
      
      <!-- Индикатор загрузки -->
      <div id="sellerLoader" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:10; justify-content:center; align-items:center; flex-direction:column;">
        <div style="width:50px; height:50px; border:5px solid #e0e0e0; border-top:5px solid #333; border-radius:50%; animation:spin 1s linear infinite;"></div>
        <p style="margin-top:20px; color:#333; font-size:16px; font-weight:600;">Загрузка...</p>
      </div>
    </div>
  </div>

  <!-- Полноэкранное окно админского чата -->
  <div id="adminChatWindow" style="display:none; position:fixed; top:0; left:0; width:100vw; height:calc(100vh - 56px); background:white; z-index:9200; flex-direction:column; overflow:hidden;">
    <!-- Заголовок админского чата -->
    <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:16px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,0.15);">
      <div>
        <div style="font-weight:bold; font-size:18px;">💬 Чат с клиентами</div>
        <div style="font-size:12px; opacity:0.9;">Управление всеми диалогами</div>
      </div>
      <button onclick="closeAdminChatWindow()" style="background:rgba(255,255,255,0.2); border:none; color:white; font-size:28px; cursor:pointer; padding:8px 12px; border-radius:8px; width:45px; height:45px; display:flex; align-items:center; justify-content:center;">&times;</button>
    </div>
    
    <!-- Контейнер для списка клиентов и сообщений -->
    <div id="adminFullChatMessages" style="flex:1; overflow:hidden; background:#f8f9fa;">
      <div style="text-align:center; color:#999; padding:40px;">Загрузка...</div>
    </div>
    
    <!-- Поле ввода для админа -->
    <div style="padding:16px; background:white; border-top:1px solid #e0e0e0; display:flex; gap:12px; box-shadow:0 -2px 8px rgba(0,0,0,0.05);">
      <input id="adminFullChatInput" type="text" placeholder="Сначала выберите клиента..." style="flex:1; padding:14px 18px; border:1px solid #ddd; border-radius:24px; outline:none; font-size:16px;" onkeypress="if(event.key==='Enter') sendAdminFullChatMessage()">
      <button onclick="sendAdminFullChatMessage()" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:50%; width:50px; height:50px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; box-shadow:0 2px 8px rgba(102,126,234,0.4);">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </div>

  <!-- Название сайта -->
  <div style="text-align:center; margin:20px 0 10px;">
    <h1 style="font-size:2.5rem; color:#007bff; margin:0; font-weight:900; text-shadow:2px 2px 4px rgba(0,0,0,0.1);">B2B Market</h1>
    <p style="font-size:0.9rem; color:#666; margin:5px 0 0;">Оптовые товары по выгодным ценам</p>
  </div>

  <!-- Модальное окно входа/регистрации агента -->
  <div id="agentAuthModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:44px; background:rgba(0,0,0,0.7); z-index:9700; justify-content:center; align-items:center;">
    <div style="background:white; width:90%; max-width:400px; border-radius:16px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
      <div style="background:linear-gradient(135deg, #9c27b0, #7b1fa2); color:white; padding:20px; text-align:center;">
        <h2 style="margin:0; font-size:22px;">🤝 Агентская программа</h2>
        <p style="margin:8px 0 0; opacity:0.9; font-size:14px;">Получайте 2% от заказов ваших клиентов</p>
      </div>
      <div style="padding:20px;">
        <div id="agentAuthTabs" style="display:flex; gap:10px; margin-bottom:20px;">
          <button onclick="switchAgentTab('login')" id="agentTabLogin" style="flex:1; padding:12px; background:#9c27b0; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600;">Вход</button>
          <button onclick="switchAgentTab('register')" id="agentTabRegister" style="flex:1; padding:12px; background:#e0e0e0; color:#333; border:none; border-radius:8px; cursor:pointer; font-weight:600;">Регистрация</button>
        </div>
        
        <!-- Форма входа -->
        <div id="agentLoginForm">
          <input type="tel" id="agentLoginPhone" placeholder="📱 Ваш телефон" style="width:100%; padding:14px; border:2px solid #e0e0e0; border-radius:10px; margin-bottom:12px; font-size:16px; box-sizing:border-box;">
          <input type="password" id="agentLoginPassword" placeholder="🔒 Пароль" style="width:100%; padding:14px; border:2px solid #e0e0e0; border-radius:10px; margin-bottom:16px; font-size:16px; box-sizing:border-box;">
          <button onclick="loginAgent()" style="width:100%; padding:14px; background:linear-gradient(135deg, #9c27b0, #7b1fa2); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600; font-size:16px;">Войти</button>
        </div>
        
        <!-- Форма регистрации -->
        <div id="agentRegisterForm" style="display:none;">
          <input type="text" id="agentRegName" placeholder="👤 Ваше имя" style="width:100%; padding:14px; border:2px solid #e0e0e0; border-radius:10px; margin-bottom:12px; font-size:16px; box-sizing:border-box;">
          <input type="tel" id="agentRegPhone" placeholder="📱 Ваш телефон" style="width:100%; padding:14px; border:2px solid #e0e0e0; border-radius:10px; margin-bottom:12px; font-size:16px; box-sizing:border-box;">
          <input type="password" id="agentRegPassword" placeholder="🔒 Придумайте пароль" style="width:100%; padding:14px; border:2px solid #e0e0e0; border-radius:10px; margin-bottom:12px; font-size:16px; box-sizing:border-box;">
          <input type="password" id="agentRegPassword2" placeholder="🔒 Повторите пароль" style="width:100%; padding:14px; border:2px solid #e0e0e0; border-radius:10px; margin-bottom:16px; font-size:16px; box-sizing:border-box;">
          <button onclick="registerAgent()" style="width:100%; padding:14px; background:linear-gradient(135deg, #4caf50, #388e3c); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600; font-size:16px;">Зарегистрироваться</button>
        </div>
      </div>
      <div style="padding:15px; background:#f5f5f5; text-align:center;">
        <button onclick="closeAgentAuthModal()" style="padding:10px 30px; background:#e0e0e0; color:#333; border:none; border-radius:8px; cursor:pointer;">Закрыть</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно прибыли агента (ПОЛНОЭКРАННЫЙ РЕЖИМ) -->
  <div id="agentProfitModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:56px; background:#f5f5f5; z-index:9650;">
    <div style="width:100%; height:100%; display:flex; flex-direction:column;">
      <!-- Шапка (компактная) -->
      <div style="background:linear-gradient(135deg, #9c27b0, #7b1fa2); color:white; padding:10px 15px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,0.15);">
        <div style="display:flex; align-items:center; gap:10px;">
          <button onclick="window.closeAllAgentModals()" style="background:rgba(255,255,255,0.25); color:white; border:none; font-size:14px; padding:6px 12px; border-radius:6px; cursor:pointer;">🏠 На главную</button>
          <h2 style="margin:0; font-size:18px; font-weight:600;">💰 Моя прибыль</h2>
          <span id="agentProfitName" style="opacity:0.85; font-size:13px;">• Агент: ---</span>
        </div>
        <button onclick="closeAgentProfitModal()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:24px; width:36px; height:36px; border-radius:50%; cursor:pointer; transition:background 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">&times;</button>
      </div>
      
      <!-- Основной контент -->
      <div style="flex:1; overflow-y:auto; padding:20px;">
        <!-- Фильтры: Период + Статус в одном поле -->
        <div style="background:white; padding:12px 15px; border-radius:12px; margin-bottom:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
          <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;">
            <!-- Период и Статус в одном поле -->
            <div style="display:flex; align-items:center; gap:5px; background:#f5f5f5; padding:6px 10px; border-radius:10px; border:1px solid #e0e0e0;">
              <select id="agentPeriodFilter" onchange="filterAgentOrders()" style="padding:6px 8px; border:none; background:transparent; font-size:13px; cursor:pointer; color:#333; outline:none;">
                <option value="all">📅 Все время</option>
                <option value="today">📅 Сегодня</option>
                <option value="week">📅 Неделя</option>
                <option value="month" selected>📅 Месяц</option>
                <option value="year">📅 Год</option>
              </select>
              <span style="color:#ccc; font-size:16px;">|</span>
              <select id="agentStatusFilter" onchange="filterAgentOrders()" style="padding:6px 8px; border:none; background:transparent; font-size:13px; cursor:pointer; color:#333; outline:none;">
                <option value="all">🏷️ Все</option>
                <option value="Новый">🆕 Новый</option>
                <option value="В обработке">⏳ В обработке</option>
                <option value="Доставляется">🚚 Доставляется</option>
                <option value="Доставлен">✅ Доставлен</option>
                <option value="Отменён">❌ Отменён</option>
              </select>
            </div>
            
            <!-- Кнопки -->
            <div style="display:flex; gap:8px;">
              <button onclick="exportAgentReport()" style="padding:8px 14px; background:#ff9800; color:white; border:none; border-radius:8px; cursor:pointer; font-size:13px; display:flex; align-items:center; gap:4px;">
                📊 Экспорт
              </button>
              <button onclick="loadAgentOrders()" style="padding:8px 14px; background:#2196f3; color:white; border:none; border-radius:8px; cursor:pointer; font-size:13px; display:flex; align-items:center; gap:4px;">
                🔄
              </button>
            </div>
          </div>
        </div>
        
        <!-- Сводка прибыли (4 блока в строку) -->
        <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-bottom:10px;">
          <div style="background:linear-gradient(135deg, #9c27b0, #7b1fa2); padding:10px; border-radius:10px; color:white; box-shadow:0 3px 10px rgba(156,39,176,0.3);">
            <div style="font-size:10px; opacity:0.9; margin-bottom:2px;">📦 Заказов</div>
            <div id="agentTotalOrders" style="font-size:20px; font-weight:700;">0</div>
          </div>
          
          <div style="background:linear-gradient(135deg, #2196f3, #1976d2); padding:10px; border-radius:10px; color:white; box-shadow:0 3px 10px rgba(33,150,243,0.3);">
            <div style="font-size:10px; opacity:0.9; margin-bottom:2px;">💵 Сумма</div>
            <div id="agentTotalSum" style="font-size:20px; font-weight:700;">0</div>
          </div>
          
          <div onclick="showAgentClientsList()" style="background:linear-gradient(135deg, #ff9800, #f57c00); padding:10px; border-radius:10px; color:white; box-shadow:0 3px 10px rgba(255,152,0,0.3); cursor:pointer; transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
            <div style="font-size:10px; opacity:0.9; margin-bottom:2px;">👥 Клиентов</div>
            <div id="agentTotalClients" style="font-size:20px; font-weight:700;">0</div>
          </div>
        </div>
        
        <!-- Блок прибыли и выплат -->
        <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-bottom:20px;">
          <div style="background:linear-gradient(135deg, #4caf50, #388e3c); padding:10px; border-radius:10px; color:white; box-shadow:0 3px 10px rgba(76,175,80,0.3);">
            <div style="font-size:10px; opacity:0.9; margin-bottom:2px;">💰 Прибыль (2%)</div>
            <div id="agentTotalProfit" style="font-size:20px; font-weight:700;">0</div>
          </div>
          
          <div style="background:linear-gradient(135deg, #e91e63, #c2185b); padding:10px; border-radius:10px; color:white; box-shadow:0 3px 10px rgba(233,30,99,0.3);">
            <div style="font-size:10px; opacity:0.9; margin-bottom:2px;">💸 Выплачено</div>
            <div id="agentTotalPaid" style="font-size:20px; font-weight:700;">0</div>
          </div>
          
          <div style="background:linear-gradient(135deg, #00bcd4, #0097a7); padding:10px; border-radius:10px; color:white; box-shadow:0 3px 10px rgba(0,188,212,0.3);">
            <div style="font-size:10px; opacity:0.9; margin-bottom:2px;">💎 К получению</div>
            <div id="agentBalance" style="font-size:20px; font-weight:700;">0</div>
          </div>
        </div>
        
        <!-- График роста прибыли -->
        <div style="background:white; padding:15px; border-radius:12px; margin-bottom:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
          <h3 style="margin:0 0 10px; color:#333; font-size:16px;">📈 Динамика прибыли</h3>
          <div id="agentProfitChart" style="height:180px; position:relative;">
            <canvas id="agentChartCanvas" style="width:100%; height:100%;"></canvas>
          </div>
        </div>
        
        <!-- Список заказов клиентов -->
        <div style="background:white; padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; color:#333; font-size:18px;">📋 Заказы моих клиентов</h3>
            <span id="agentFilteredCount" style="font-size:14px; color:#666;"></span>
          </div>
          <div id="agentOrdersList" style="display:flex; flex-direction:column; gap:12px;">
            <div style="text-align:center; color:#999; padding:40px;">Загрузка...</div>
          </div>
        </div>
      </div>
      
      <!-- Нижняя панель -->
      <div style="background:white; padding:15px 20px; border-top:1px solid #e0e0e0; display:flex; justify-content:space-between; align-items:center; box-shadow:0 -2px 10px rgba(0,0,0,0.05);">
        <button onclick="logoutAgent()" style="padding:12px 24px; background:#f44336; color:white; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:500;">🚪 Выйти из аккаунта</button>
        <button onclick="closeAgentProfitModal()" style="padding:12px 32px; background:#9c27b0; color:white; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:500;">✖ Закрыть</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно списка клиентов агента -->
  <div id="agentClientsListModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:44px; background:rgba(0,0,0,0.7); z-index:9750; justify-content:center; align-items:center;">
    <div style="background:white; width:95%; max-width:500px; max-height:85vh; border-radius:16px; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
      <div style="background:linear-gradient(135deg, #ff9800, #f57c00); color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; font-size:18px;">👥 Мои клиенты</h3>
        <button onclick="closeAgentClientsList()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:24px; width:36px; height:36px; border-radius:50%; cursor:pointer;">&times;</button>
      </div>
      <div id="agentClientsListContent" style="flex:1; overflow-y:auto; padding:15px;">
        <div style="text-align:center; color:#999; padding:30px;">Загрузка...</div>
      </div>
    </div>
  </div>

  <!-- Модальное окно управления агентами (для админа) -->
  <div id="agentsManagementModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:56px; background:rgba(0,0,0,0.7); z-index:9650; justify-content:center; align-items:center;">
    <div style="background:white; width:95%; max-width:900px; max-height:90vh; border-radius:16px; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
      <div style="background:linear-gradient(135deg, #9c27b0, #7b1fa2); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:22px;">🤝 Управление агентами</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:14px;">Просмотр и управление агентской программой</p>
        </div>
        <button onclick="closeAgentsManagement()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer;">&times;</button>
      </div>
      
      <!-- Сводка -->
      <div style="padding:15px 20px; background:linear-gradient(135deg, #e1bee7, #f3e5f5); display:flex; flex-wrap:wrap; gap:15px; justify-content:center;">
        <div style="background:white; padding:12px 20px; border-radius:10px; text-align:center; min-width:120px;">
          <div style="font-size:13px; color:#666;">Всего агентов</div>
          <div id="adminTotalAgents" style="font-size:24px; font-weight:700; color:#9c27b0;">0</div>
        </div>
        <div style="background:white; padding:12px 20px; border-radius:10px; text-align:center; min-width:120px;">
          <div style="font-size:13px; color:#666;">Активных</div>
          <div id="adminActiveAgents" style="font-size:24px; font-weight:700; color:#4caf50;">0</div>
        </div>
        <div style="background:white; padding:12px 20px; border-radius:10px; text-align:center; min-width:120px;">
          <div style="font-size:13px; color:#666;">Всего заказов</div>
          <div id="adminAgentsTotalOrders" style="font-size:24px; font-weight:700; color:#2196f3;">0</div>
        </div>
        <div style="background:white; padding:12px 20px; border-radius:10px; text-align:center; min-width:120px;">
          <div style="font-size:13px; color:#666;">Общая комиссия</div>
          <div id="adminAgentsTotalCommission" style="font-size:24px; font-weight:700; color:#ff9800;">0</div>
        </div>
      </div>
      
      <!-- Список агентов -->
      <div style="flex:1; overflow-y:auto; padding:15px;">
        <div id="agentsManagementList" style="display:flex; flex-direction:column; gap:12px;">
          <div style="text-align:center; color:#999; padding:30px;">Загрузка...</div>
        </div>
      </div>
      
      <!-- Кнопки -->
      <div style="padding:15px; background:#f5f5f5; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button onclick="refreshAgentsManagement()" style="padding:10px 20px; background:#2196f3; color:white; border:none; border-radius:8px; cursor:pointer;">🔄 Обновить</button>
          <button onclick="openClientsForAgents()" style="padding:10px 20px; background:#ff9800; color:white; border:none; border-radius:8px; cursor:pointer;">👥 Назначить клиентов</button>
        </div>
        <button onclick="closeAgentsManagement()" style="padding:10px 30px; background:#e0e0e0; color:#333; border:none; border-radius:8px; cursor:pointer;">Закрыть</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно назначения клиентов агентам -->
  <div id="clientsForAgentsModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:44px; background:rgba(0,0,0,0.7); z-index:9750; justify-content:center; align-items:center;">
    <div style="background:white; width:95%; max-width:900px; max-height:90vh; border-radius:16px; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
      <div style="background:linear-gradient(135deg, #ff9800, #f57c00); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:22px;">👥 Назначение клиентов агентам</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:14px;">Привяжите клиентов к агентам для начисления комиссии</p>
        </div>
        <button onclick="closeClientsForAgents()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer;">&times;</button>
      </div>
      
      <!-- Фильтр -->
      <div style="padding:15px; background:#f5f5f5; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <input type="text" id="clientsSearchInput" placeholder="🔍 Поиск по имени/телефону..." oninput="filterClientsForAgents()" style="flex:1; min-width:200px; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
        <select id="clientsAgentFilter" onchange="filterClientsForAgents()" style="padding:10px; border:1px solid #ddd; border-radius:8px;">
          <option value="all">Все клиенты</option>
          <option value="no-agent">Без агента</option>
          <option value="has-agent">С агентом</option>
        </select>
      </div>
      
      <!-- Список клиентов -->
      <div style="flex:1; overflow-y:auto; padding:15px;">
        <div id="clientsForAgentsList" style="display:flex; flex-direction:column; gap:10px;">
          <div style="text-align:center; color:#999; padding:30px;">Загрузка...</div>
        </div>
      </div>
      
      <!-- Кнопки -->
      <div style="padding:15px; background:#f5f5f5; text-align:right;">
        <button onclick="closeClientsForAgents()" style="padding:10px 30px; background:#e0e0e0; color:#333; border:none; border-radius:8px; cursor:pointer;">Закрыть</button>
      </div>
    </div>
  </div>

  <!-- Кнопка установки PWA приложения -->
  <div id="installPwaContainer" style="display:none; padding:10px; background:linear-gradient(135deg, #667eea, #764ba2); margin:0 10px 10px; border-radius:12px; box-shadow:0 4px 15px rgba(102,126,234,0.3);">
    <div style="display:flex; align-items:center; justify-content:space-between; color:white;">
      <div style="flex:1;">
        <div style="font-size:16px; font-weight:700; margin-bottom:4px;">📱 Установить приложение Кербен</div>
        <div style="font-size:13px; opacity:0.9;">Быстрый доступ с главного экрана</div>
      </div>
      <button id="installPwaBtn" style="background:white; color:#667eea; border:none; padding:10px 20px; border-radius:8px; font-weight:700; cursor:pointer; font-size:14px; margin-left:10px;">Установить</button>
      <button onclick="document.getElementById('installPwaContainer').style.display='none'" style="background:rgba(255,255,255,0.2); color:white; border:none; width:30px; height:30px; border-radius:50%; cursor:pointer; margin-left:8px; font-size:18px;">×</button>
    </div>
  </div>

  <!-- Верхний промо-слайдер: две рекламные карточки (swipe) -->
  <!-- Категории товаров -->
  <div class="category-tabs">
    <button class="category-btn active" onclick="filterByCategory('все')" data-category="все">Все товары</button>
    <button class="category-btn" onclick="toggleOtherCategories()" id="otherCategoriesBtn" style="background:linear-gradient(90deg, #6c757d, #495057);">📂 Другие категории ▼</button>
    <div id="otherCategoriesContainer">
      <button class="category-btn" onclick="filterByCategory('ножницы')" data-category="ножницы">✂️ Ножницы</button>
      <button class="category-btn" onclick="filterByCategory('скотч')" data-category="скотч">Скотч</button>
      <button class="category-btn" onclick="filterByCategory('нож')" data-category="нож">🔪 Нож</button>
      <button class="category-btn" onclick="filterByCategory('корейские')" data-category="корейские">Корейские товары</button>
      <button class="category-btn" onclick="filterByCategory('часы')" data-category="часы">⌚ Часы</button>
      <button class="category-btn" onclick="filterByCategory('электроника')" data-category="электроника">🔌 Электроника</button>
      <button class="category-btn" onclick="filterByCategory('бытовые')" data-category="бытовые">Бытовые техники</button>
      <!-- Категории продавцов будут добавлены сюда динамически -->
      <div id="sellerCategoriesContainer" style="display:contents;"></div>
    </div>
  </div>

  <!-- Кнопка редактора (скрыта по умолчанию, видна только админу) -->
  <div id="editorBtnContainer" style="display:none; justify-content:center; padding:8px 10px 0;">
    <button id="editorModeBtn" onclick="toggleEditorMode()" style="padding:10px 20px; background:linear-gradient(135deg,#6c757d,#495057); color:white; border:none; border-radius:20px; cursor:pointer; font-size:14px; font-weight:600; display:flex; align-items:center; gap:6px;">
      ✏️ Редактор
    </button>
  </div>

  <!-- Расширенный поиск с фильтрами -->
  <div class="search-container">
    <div class="search-main" style="flex-wrap: wrap;">
      <button class="search-btn" onclick="applyFilters()">🔍 Найти</button>
      <button class="filter-toggle-btn" id="filterToggleBtn" onclick="toggleFilters()">⚙️ Фильтры</button>
      <button id="voiceSearchBtn" class="voice-search-btn" onclick="startVoiceSearch()" title="Голосовой поиск">🎤</button>
      <input type="text" id="search" placeholder="🔍 Поиск товара..." oninput="scheduleRenderProducts()" autocomplete="off" style="width: 100%; order: 10; margin-top: 8px;" />
    </div>
    
    <div class="search-filters" id="searchFilters">
      <div class="filter-row">
        <div class="filter-group">
          <label>💰 Цена</label>
          <div class="price-range">
            <input type="number" id="priceMin" placeholder="От" min="0" />
            <span>—</span>
            <input type="number" id="priceMax" placeholder="До" min="0" />
          </div>
        </div>
        
        <div class="filter-group">
          <label>📦 Наличие</label>
          <select id="stockFilter">
            <option value="all">Все товары</option>
            <option value="instock">В наличии</option>
            <option value="outofstock">Нет в наличии</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label>📊 Сортировка</label>
          <select id="sort">
            <option value="">По умолчанию</option>
            <option value="asc">Сначала дешёвые</option>
            <option value="desc">Сначала дорогие</option>
            <option value="name_asc">По названию А-Я</option>
            <option value="name_desc">По названию Я-А</option>
            <option value="new">Сначала новые</option>
          </select>
        </div>
        
        <div class="filter-actions">
          <button class="filter-apply-btn" onclick="applyFilters()">✅ Применить</button>
          <button class="filter-reset-btn" onclick="resetFilters()">🔄 Сбросить</button>
        </div>
      </div>
      
      <div class="search-tags" id="activeTags"></div>
    </div>
    
    <div class="search-results-info" id="searchResultsInfo" style="display:none;">
      <span id="resultsText">Найдено: 0 товаров</span>
      <span class="clear-search" onclick="resetFilters()">✖ Очистить поиск</span>
    </div>
  </div>



  <!-- Сетка карточек товаров -->
  <div id="productTable" class="product-grid"></div>



  <div class="order-form">

    <h2>Оформить заказ</h2>

    <div id="cartList"></div>

    <div class="cart-summary">Итого: <span id="totalSum">0</span> сом</div>

    <!-- Кнопка открытия панели корзины перенесена вниз перед очисткой корзины -->
    <div style="display:flex;gap:8px;">
      <button id="openCartBtn" onclick="openCartPage()">Открыть корзину</button>
      <!-- Кнопка очистки корзины будет в панели корзины -->
    </div>

    <input type="text" id="name" placeholder="Ваше имя" required />

    <input type="tel" id="phone" placeholder="Телефон" required />

    <input type="text" id="address" placeholder="Адрес доставки" required />
    
    <input type="text" id="driverName" placeholder="Имя водителя (необязательно)" style="background:#f8f9fa; border:2px solid #e9ecef;" />
    
    <input type="tel" id="driverPhone" placeholder="Номер водителя (необязательно)" style="background:#f8f9fa; border:2px solid #e9ecef;" />
    
    <input type="text" id="referredBy" placeholder="Кто вам порекомендовал? (необязательно)" style="background:#f8f9fa; border:2px solid #e9ecef;" />

    <button id="submitOrder">Отправить заказ</button>
    
    <button type="button" onclick="openTrackOrderModal()" style="width:100%; padding:14px; margin-top:10px; background:linear-gradient(135deg, #17a2b8 0%, #138496 100%); color:white; border:none; border-radius:10px; cursor:pointer; font-size:16px; font-weight:600; display:flex; align-items:center; justify-content:center; gap:10px;">
      📦 Отслеживать мой заказ
    </button>

  </div>

  <button id="logoutUser" style="margin:10px 0;">Выйти из профиля</button>

  <div id="adminProductsBlock"></div>

  <!-- Модальное окно добавления товара - ОПТИМИЗИРОВАНО для быстрого ввода - НА ВЕСЬ ЭКРАН -->
  <div id="addProductWindow" style="display:none; position:fixed; top:0; left:0; right:0; bottom:56px; background:#fff; z-index:9650; contain:strict; isolation:isolate;">
    <div style="background:#fff; width:100%; height:100%; max-width:100%; max-height:100%; margin:0; border-radius:0; overflow:hidden; display:flex; flex-direction:column; contain:content;">
      
      <!-- Шапка -->
      <div style="background:linear-gradient(90deg, #ff6b6b, #ee5a6f); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:24px;">➕ Добавить товар</h2>
          <p style="margin:5px 0 0; opacity:0.9; ">Заполните информацию о товаре</p>
        </div>
        <button onclick="closeAddProductWindow()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:48px; height:48px; min-width:48px; min-height:48px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0;">&times;</button>
      </div>

      <!-- Форма -->
      <div style="flex:1; overflow-y:auto; padding:20px; padding-top:24px;">
        <div style="display:flex; flex-direction:column; gap:18px;">
          
          <!-- Кнопки управления товарами -->
          <div style="display:flex; gap:10px; margin-bottom:6px;">
            <button onclick="expandAllProducts()" style="flex:1; padding:12px; min-height:48px; background:#28a745; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600; font-size:13px;">▼ Развернуть все</button>
            <button onclick="collapseAllProducts()" style="flex:1; padding:12px; min-height:48px; background:#6c757d; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600; font-size:13px;">▲ Свернуть все</button>
          </div>

          <input type="text" id="newTitle" placeholder="Название товара" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:14px; border:1px solid #ddd; border-radius:8px; min-height:48px; font-size:16px;">
          
          <textarea id="newDescription" placeholder="📝 Описание товара (для корейских товаров, часов и электроники)" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:14px; border:1px solid #ddd; border-radius:8px; min-height:70px; resize:vertical; font-size:16px;"></textarea>
          
          <input type="number" id="newCostPrice" placeholder="💵 Цена закупки (необязательно)" step="0.01" inputmode="decimal" autocomplete="off" style="padding:14px; border:1px solid #ddd; border-radius:8px; min-height:48px; font-size:16px;">
          
          <input type="number" id="newPrice" placeholder="💰 Цена продажи (розничная)" step="0.01" inputmode="decimal" autocomplete="off" style="padding:14px; border:1px solid #ddd; border-radius:8px; min-height:48px; font-size:16px;">
          
          <div id="profitDisplay" style="padding: 12px; background: #e8f5e9; border-radius: 8px; display: none; text-align: center;">
            <strong>📊 Наценка:</strong> <span id="profitAmount">0</span> сом (<span id="profitPercent">0</span>%)
          </div>
          
          <div style="display:flex; gap:8px; align-items:center;">
            <select id="newCategory" style="flex:1; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; min-height:48px;">
              <option value="">Выберите категорию</option>
              <option value="все" data-category="все">Все товары</option>
              <option value="ножницы" data-category="ножницы">✂️ Ножницы</option>
              <option value="скотч" data-category="скотч">Скотч</option>
              <option value="нож" data-category="нож">🔪 Нож</option>
              <option value="корейские" data-category="корейские">Корейские товары</option>
              <option value="часы" data-category="часы">⌚ Часы</option>
              <option value="электроника" data-category="электроника">🔌 Электроника</option>
              <option value="бытовые" data-category="бытовые">Бытовые техники</option>
            </select>
            <button type="button" onclick="showNewCategoryInput()" style="width:48px; height:48px; min-width:48px; min-height:48px; flex-shrink:0; background:linear-gradient(135deg, #ff9a56, #ff6b35); color:white; border:none; border-radius:8px; cursor:pointer; font-size:20px; display:flex; align-items:center; justify-content:center;" title="Добавить новую категорию">➕</button>
          </div>
          
          <!-- Поле для новой категории -->
          <div id="newCategoryInputDiv" style="display:none;">
            <div style="display:flex; gap:8px; align-items:center;">
              <input type="text" id="newCategoryInput" placeholder="🆕 Введите название новой категории" style="flex:1; padding:14px; min-height:48px; border:2px solid #ff6b35; border-radius:8px; background:#fff8f5; font-size:16px;">
              <button type="button" onclick="hideNewCategoryInput()" style="width:48px; height:48px; min-width:48px; min-height:48px; flex-shrink:0; background:#dc3545; color:white; border:none; border-radius:8px; cursor:pointer; font-size:18px; display:flex; align-items:center; justify-content:center;">✕</button>
            </div>
            <p style="margin:5px 0 0; font-size:12px; color:#ff6b35;">⚡ Введите название новой категории для вашего товара</p>
          </div>
          
          <input type="number" id="newOptPrice" placeholder="Оптовая цена" inputmode="decimal" autocomplete="off" style="padding:14px; border:1px solid #ddd; border-radius:8px; min-height:48px; font-size:16px;">
          
          <input type="number" id="newOptQty" placeholder="Минимальное количество для опта" inputmode="numeric" autocomplete="off" style="padding:14px; border:1px solid #ddd; border-radius:8px; min-height:48px; font-size:16px;">
          
          <input type="number" id="newMinQty" placeholder="Минимальное количество для покупки" inputmode="numeric" autocomplete="off" style="padding:14px; border:1px solid #ddd; border-radius:8px; min-height:48px; font-size:16px;">

          <input type="number" id="newStock" placeholder="📦 Остаток (если пусто — без лимита)" min="0" step="1" inputmode="numeric" autocomplete="off" style="padding:14px; border:1px solid #ddd; border-radius:8px; min-height:48px; font-size:16px;">
          
          <!-- Редактор вариантов товара -->
          <div id="variantEditorSection"></div>
          
          <!-- Настройка для товаров-пачек -->
          <div style="background:#f3e5f5; border:2px solid #9c27b0; border-radius:8px; padding:14px;">
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
              <input type="checkbox" id="newIsPack" style="width:24px; height:24px; min-width:24px; min-height:24px; cursor:pointer;" onchange="togglePackQtyField()">
              <label for="newIsPack" style="font-weight:600; color:#7b1fa2; cursor:pointer;">📦 Это пачка (продаётся только пачками)</label>
            </div>
            <input type="number" id="newPackQty" placeholder="Сколько штук в 1 пачке (напр. 6)" min="1" step="1" inputmode="numeric" autocomplete="off" style="display:none; width:100%; padding:10px; border:1px solid #ce93d8; border-radius:6px;  background:#fce4ec; margin-bottom:8px;" oninput="updatePackCalculationPreview()">
            <input type="number" id="newPacksPerBox" placeholder="Сколько пачек в 1 коробке (напр. 20)" min="1" step="1" inputmode="numeric" autocomplete="off" style="display:none; width:100%; padding:10px; border:1px solid #ce93d8; border-radius:6px;  background:#fff3e0;" oninput="updatePackCalculationPreview()">
            <div id="packCalculationPreview" style="display:none; margin-top:8px; padding:10px; background:#e8f5e9; border-radius:6px; font-size:13px; color:#2e7d32;"></div>
          </div>
          
          <div style="display: flex; gap: 10px;">
            <input type="file" id="imageFile" accept="image/*" style="flex: 1; padding:12px; min-height:48px; border:1px solid #ddd; border-radius:8px;">
            <input type="file" id="galleryFile" accept="image/*" style="display: none;">
            <button id="openGallery" style="padding:12px 15px; min-height:48px; background:#007bff; color:white; border:none; border-radius:8px; cursor:pointer; white-space:nowrap;" onclick="document.getElementById('galleryFile').click()">📁 Галерея</button>
          </div>
          
          <input type="text" id="newImage" placeholder="URL изображения (опционально)" autocomplete="off" style="padding:14px; border:1px solid #ddd; border-radius:8px; min-height:48px;">
          
          <!-- Дополнительные фото -->
          <div style="background:#e3f2fd; border:2px solid #2196f3; border-radius:8px; padding:14px;">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
              <label style="font-weight:600; color:#1565c0;">📷 Дополнительные фото (до 5 шт)</label>
              <button type="button" onclick="addExtraPhotoField()" style="background:#2196f3; color:white; border:none; padding:10px 14px; min-height:44px; border-radius:6px; cursor:pointer; font-size:13px;">+ Добавить фото</button>
            </div>
            <div id="extraPhotosContainer" style="display:flex; flex-direction:column; gap:10px;"></div>
            <div id="extraPhotosPreview" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;"></div>
          </div>
          
          <button id="previewUrlBtn" style="padding:14px; min-height:48px; background:#6c757d; color:white; border:none; border-radius:8px; cursor:pointer;">👁️ Показать предпросмотр</button>
          
          <div id="imagePreview" style="display: none; text-align:center; padding:10px; background:#f8f9fa; border-radius:8px;">
            <img id="previewImg" src="" alt="Предпросмотр" style="max-width: 100%; max-height: 200px; border-radius:8px;">
          </div>
        </div>
      </div>

      <!-- Кнопки действий -->
      <div style="padding:20px; background:#f8f9fa; border-top:1px solid #e0e0e0; display:flex; gap:10px;">
        <button id="addProductBtn" style="flex:1; padding:16px; min-height:52px; background:linear-gradient(90deg, #28a745, #20c997); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:16px;">✅ Добавить товар</button>
      </div>
    </div>
  </div>

  <!-- Окно управления заказами -->
  <div id="ordersManagementWindow" style="display:none; position:fixed; inset:0; bottom:56px; background:rgba(0,0,0,0.5); z-index:9650;" onclick="if(event.target===this)closeOrdersManagementWindow()">
    <div style="background:#f5f5f5; width:100%; max-width:900px; height:calc(100vh - 56px); margin:0 auto; display:flex; flex-direction:column;">

      <!-- Поиск -->
      <div style="padding:12px 16px 8px; background:#fff;">
        <input type="text" id="ordersSearchClient" placeholder="🔍 Поиск по имени или телефону..." oninput="scheduleOrdersManagementSearch()" style="width:100%; padding:10px 14px; border:1px solid #e0e0e0; border-radius:10px; font-size:15px; background:#f8f8f8; box-sizing:border-box;">
      </div>

      <!-- Фильтры -->
      <div class="orders-filters" style="padding:8px 16px 12px; background:#fff; border-bottom:1px solid #e0e0e0; display:flex; gap:8px; align-items:center;">
        <select id="ordersFilterCombined" onchange="applyOrdersCombinedFilter()" style="width:50%; padding:8px 10px; border:1px solid #e0e0e0; border-radius:8px; font-size:13px; background:#fff;">
          <option value="all|all">Все</option>
          <option value="all|today">Сегодня</option>
          <option value="all|week">Неделя</option>
          <option value="pending|all">🕐 Новые</option>
          <option value="preparing|all">📦 Готовятся</option>
          <option value="logistics|all">🚚 Логистика</option>
          <option value="driver|all">🚗 Доставка</option>
          <option value="completed|all">✓ Готовы</option>
          <option value="cancelled|all">✕ Отменены</option>
        </select>
        <button onclick="openMergeOrdersModal()" style="padding:8px 12px; background:#667eea; color:white; border:none; border-radius:8px; cursor:pointer; font-size:13px;">🔗</button>
      </div>

      <!-- Скрытые фильтры для совместимости -->
      <select id="ordersFilterStatus" style="display:none;"><option value="all" selected></option></select>
      <select id="ordersFilterDate" style="display:none;"><option value="all" selected></option></select>

      <!-- Список заказов -->
      <div id="ordersManagementList" style="flex:1; overflow-y:auto; padding:12px 16px; background:#f5f5f5;">
        <div style="text-align:center; color:#999; padding:40px;">Загрузка...</div>
      </div>
    </div>
  </div>

  <!-- Модальное окно редактирования заказа -->
  <div id="editOrderModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:56px; background:rgba(0,0,0,0.5); z-index:9700; justify-content:center; align-items:center;">
    <div style="background:white; width:95%; max-width:500px; max-height:90vh; border-radius:16px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
      <div style="padding:16px 20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee;">
        <div>
          <h2 style="margin:0; font-size:17px; font-weight:600; color:#1a1a1a;">Редактировать заказ</h2>
          <p style="margin:4px 0 0; font-size:12px; color:#888;" id="editOrderModalInfo">Загрузка...</p>
        </div>
        <button onclick="closeEditOrderModal()" style="background:#f0f0f0; color:#333; border:none; font-size:18px; width:32px; height:32px; border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <div style="flex:1; overflow-y:auto; padding:16px 20px;">
        <div style="display:flex; flex-direction:column; gap:14px;">
          <div>
            <label style="font-size:12px; font-weight:500; color:#555; display:block; margin-bottom:6px;">Имя клиента</label>
            <input id="editOrderName" type="text" placeholder="Введите имя" style="width:100%; padding:10px 12px; border:1px solid #e0e0e0; border-radius:8px; font-size:14px; box-sizing:border-box;" />
          </div>
          <div>
            <label style="font-size:12px; font-weight:500; color:#555; display:block; margin-bottom:6px;">Телефон</label>
            <input id="editOrderPhone" type="tel" placeholder="+996" style="width:100%; padding:10px 12px; border:1px solid #e0e0e0; border-radius:8px; font-size:14px; box-sizing:border-box;" />
          </div>
          <div>
            <label style="font-size:12px; font-weight:500; color:#555; display:block; margin-bottom:6px;">Адрес доставки</label>
            <input id="editOrderAddress" type="text" placeholder="Улица, дом, квартира" style="width:100%; padding:10px 12px; border:1px solid #e0e0e0; border-radius:8px; font-size:14px; box-sizing:border-box;" />
          </div>
          
          <div style="padding-top:10px; border-top:1px solid #eee;">
            <div style="font-size:11px; color:#999; margin-bottom:10px;">ДОПОЛНИТЕЛЬНО</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <div>
                <label style="font-size:11px; color:#777; display:block; margin-bottom:4px;">Водитель</label>
                <input id="editOrderDriverName" type="text" placeholder="Имя" style="width:100%; padding:8px 10px; border:1px solid #e0e0e0; border-radius:6px; font-size:13px; box-sizing:border-box;" />
              </div>
              <div>
                <label style="font-size:11px; color:#777; display:block; margin-bottom:4px;">Тел. водителя</label>
                <input id="editOrderDriverPhone" type="tel" placeholder="Номер" style="width:100%; padding:8px 10px; border:1px solid #e0e0e0; border-radius:6px; font-size:13px; box-sizing:border-box;" />
              </div>
            </div>
          </div>
          
          <div>
            <label style="font-size:11px; color:#777; display:block; margin-bottom:4px;">Кто привёл клиента?</label>
            <input id="editOrderReferredBy" type="text" placeholder="Имя партнёра" style="width:100%; padding:8px 10px; border:1px solid #e0e0e0; border-radius:6px; font-size:13px; box-sizing:border-box;" />
          </div>
        </div>
      </div>

      <div style="padding:12px 20px; background:#fafafa; border-top:1px solid #eee; display:flex; gap:10px;">
        <button onclick="closeEditOrderModal()" style="flex:1; padding:12px; background:#f0f0f0; color:#333; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:500;">Отмена</button>
        <button onclick="saveEditOrder()" style="flex:1; padding:12px; background:#007bff; color:white; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">Сохранить</button>
      </div>
    </div>
  </div>

  <!-- Окно заказов от партнеров -->
  <div id="partnersOrdersWindow" style="display:none; position:fixed; top:0; left:0; right:0; bottom:56px; background:rgba(0,0,0,0.6); z-index:9650;">
    <div style="background:#fff; width:95%; max-width:1200px; height:90vh; margin:3vh auto; border-radius:12px; overflow:hidden; display:flex; flex-direction:column;">
      
      <!-- Шапка -->
      <div style="background:linear-gradient(90deg, #4facfe, #00f2fe); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:24px;">🤝 Заказы от партнеров</h2>
          <p style="margin:5px 0 0; opacity:0.9; ">Статистика и список заказов по партнерам</p>
        </div>
        <button onclick="closePartnersOrdersWindow()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- Фильтры -->
      <div style="padding:15px; background:#f8f9fa; border-bottom:1px solid #e0e0e0; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <select id="partnersFilterDate" onchange="loadPartnersOrders()" style="padding:10px; border:1px solid #ddd; border-radius:6px; ">
          <option value="all">Все время</option>
          <option value="today">Сегодня</option>
          <option value="week">За неделю</option>
          <option value="month">За месяц</option>
        </select>
        
        <select id="partnersFilterPartner" onchange="loadPartnersOrders()" style="padding:10px; border:1px solid #ddd; border-radius:6px; ">
          <option value="all">Все партнеры</option>
        </select>
        
        <button onclick="loadPartnersOrders()" style="padding:10px 20px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">🔄 Обновить</button>
        <button onclick="exportPartnersToExcel()" style="padding:10px 20px; background:#28a745; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">📊 Экспорт в Excel</button>
      </div>

      <!-- Статистика партнеров -->
      <div id="partnersStats" style="padding:15px; background:#fff; border-bottom:2px solid #e0e0e0;">
        <div style="text-align:center; color:#999;">Загрузка статистики...</div>
      </div>

      <!-- Список заказов -->
      <div id="partnersOrdersList" style="flex:1; overflow-y:auto; padding:15px;">
        <div style="text-align:center; color:#999; padding:40px;">Загрузка заказов...</div>
      </div>
    </div>
  </div>

  <!-- Модальное окно для добавления товара в заказ -->
  <div id="addItemToOrderModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:56px; background:rgba(0,0,0,0.7); z-index:9700; justify-content:center; align-items:center;">
    <div style="background:white; width:90%; max-width:600px; max-height:80vh; border-radius:12px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
      <!-- Заголовок -->
      <div style="background:linear-gradient(135deg, #17a2b8 0%, #138496 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:20px;">➕ Добавить товар в заказ</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:13px;">Выберите товар из списка</p>
        </div>
        <button onclick="closeAddItemToOrderModal()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- Поиск товара -->
      <div style="padding:15px; background:#f8f9fa; border-bottom:1px solid #e0e0e0;">
        <input type="text" id="searchProductToAdd" placeholder="🔍 Поиск товара..." oninput="scheduleFilterProductsToAdd()" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; ">
      </div>

      <!-- Список товаров -->
      <div id="productsToAddList" style="flex:1; overflow-y:auto; padding:15px;">
        <div style="text-align:center; color:#999; padding:40px;">Загрузка товаров...</div>
      </div>
    </div>
  </div>

  <!-- Окно отчета по прибыли -->
  <div id="profitReportWindow" style="display:none; position:fixed; top:0; left:0; right:0; bottom:56px; background:rgba(0,0,0,0.6); z-index:9650;">
    <div style="background:#fff; width:95%; max-width:1000px; height:90vh; margin:3vh auto; border-radius:12px; overflow:hidden; display:flex; flex-direction:column;">
      
      <!-- Шапка -->
      <div class="profit-header" style="background:linear-gradient(135deg, #28a745 0%, #20c997 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:24px;">💰 Отчет по прибыли</h2>
          <p style="margin:5px 0 0; opacity:0.9; ">Анализ прибыльности товаров</p>
        </div>
        <button onclick="closeProfitReport()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- Фильтры и сводка -->
      <div class="profit-filters" style="padding:15px; background:#f8f9fa;">
        <!-- Вкладки -->
        <div class="profit-tabs" style="display:flex; gap:10px; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #e0e0e0; flex-wrap:wrap;">
          <button id="tabProducts" onclick="switchProfitTab('products')" style="padding:12px 24px; background:linear-gradient(90deg, #28a745, #20c997); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; box-shadow:0 2px 4px rgba(0,0,0,0.2);">📦 По товарам</button>
          <button id="tabOrders" onclick="switchProfitTab('orders')" style="padding:12px 24px; background:#e9ecef; color:#333; border:none; border-radius:8px; cursor:pointer; font-weight:600; box-shadow:0 2px 4px rgba(0,0,0,0.1);">📋 По заказам</button>
          <button id="tabAgents" onclick="switchProfitTab('agents')" style="padding:12px 24px; background:#e9ecef; color:#333; border:none; border-radius:8px; cursor:pointer; font-weight:600; box-shadow:0 2px 4px rgba(0,0,0,0.1);">🤝 Агенты</button>
          <button id="tabExpenses" onclick="switchProfitTab('expenses')" style="padding:12px 24px; background:#e9ecef; color:#333; border:none; border-radius:8px; cursor:pointer; font-weight:600; box-shadow:0 2px 4px rgba(0,0,0,0.1);">💸 Расходы</button>
        </div>

        <!-- Панель по товарам -->
        <div id="profitProductsPanel">
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:15px;">
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">💰 Общая прибыль</div>
              <div style="font-size:24px; font-weight:700; color:#28a745;" id="totalProfit">0 сом</div>
            </div>
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">📊 Средняя наценка</div>
              <div style="font-size:24px; font-weight:700; color:#007bff;" id="avgMarkup">0%</div>
            </div>
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">📦 Всего товаров</div>
              <div style="font-size:24px; font-weight:700; color:#6c757d;" id="totalProducts">0</div>
            </div>
          </div>
          
          <div class="profit-controls" style="display:flex; gap:10px; align-items:center;">
            <select id="profitCategoryFilter" onchange="filterProfitReport()" style="padding:10px; border:1px solid #ddd; border-radius:8px; flex:1;">
              <option value="">Все категории</option>
              <option value="ножницы">✂️ Ножницы</option>
              <option value="скотч">Скотч</option>
              <option value="нож">🔪 Нож</option>
              <option value="электроника">🔌 Электроника</option>
              <option value="все">Все товары</option>
            </select>
            <select id="profitSortFilter" onchange="filterProfitReport()" style="padding:10px; border:1px solid #ddd; border-radius:8px; flex:1;">
              <option value="profit-desc">По прибыли (↓)</option>
              <option value="profit-asc">По прибыли (↑)</option>
              <option value="markup-desc">По наценке (↓)</option>
              <option value="markup-asc">По наценке (↑)</option>
              <option value="name">По названию</option>
            </select>
            <button onclick="exportProfitToExcel()" style="padding:10px 20px; background:#28a745; color:white; border:none; border-radius:8px; cursor:pointer; white-space:nowrap;">📥 Excel</button>
          </div>
        </div>

        <!-- Панель по заказам -->
        <div id="profitOrdersPanel" style="display:none;">
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:15px;">
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">💰 Прибыль за период</div>
              <div style="font-size:24px; font-weight:700; color:#28a745;" id="totalOrderProfit">0 сом</div>
            </div>
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">📋 Всего заказов</div>
              <div style="font-size:24px; font-weight:700; color:#007bff;" id="totalOrdersCount">0</div>
            </div>
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">👥 Клиентов</div>
              <div style="font-size:24px; font-weight:700; color:#6c757d;" id="totalClientsCount">0</div>
            </div>
          </div>
          
          <div class="profit-controls" style="display:flex; gap:10px; align-items:center;">
            <select id="orderDateFilter" onchange="loadOrderProfitReport()" style="padding:10px; border:1px solid #ddd; border-radius:8px; flex:1;">
              <option value="today">Сегодня</option>
              <option value="yesterday">Вчера</option>
              <option value="week">За неделю</option>
              <option value="month">За месяц</option>
              <option value="all">Все время</option>
            </select>
            <select id="orderSortFilter" onchange="loadOrderProfitReport()" style="padding:10px; border:1px solid #ddd; border-radius:8px; flex:1;">
              <option value="profit-desc">По прибыли (↓)</option>
              <option value="date-desc">По дате (новые)</option>
              <option value="date-asc">По дате (старые)</option>
            </select>
            <button onclick="exportOrderProfitToExcel()" style="padding:10px 20px; background:#28a745; color:white; border:none; border-radius:8px; cursor:pointer; white-space:nowrap;">📥 Excel</button>
            <button onclick="deleteSelectedOrders()" style="padding:10px 20px; background:#dc3545; color:white; border:none; border-radius:8px; cursor:pointer; white-space:nowrap;">🗑️ Удалить</button>
          </div>
        </div>

        <!-- Панель расходов -->
        <div id="profitExpensesPanel" style="display:none;">
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:15px;">
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">💸 Расходы за период</div>
              <div style="font-size:24px; font-weight:700; color:#dc3545;" id="totalExpenses">0 сом</div>
            </div>
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">💰 Прибыль за период</div>
              <div style="font-size:24px; font-weight:700; color:#28a745;" id="expensesPeriodProfit">0 сом</div>
            </div>
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">📊 Чистая прибыль</div>
              <div style="font-size:24px; font-weight:700; color:#007bff;" id="netProfit">0 сом</div>
            </div>
          </div>
          
          <div class="profit-controls" style="display:flex; gap:10px; margin-bottom:15px;">
            <select id="expenseDateFilter" onchange="loadExpensesReport()" style="padding:10px; border:1px solid #ddd; border-radius:8px; flex:1;">
              <option value="today">Сегодня</option>
              <option value="yesterday">Вчера</option>
              <option value="week">За неделю</option>
              <option value="month">За месяц</option>
              <option value="all">Все время</option>
            </select>
            <button onclick="loadExpensesReport()" style="padding:10px 20px; background:#17a2b8; color:white; border:none; border-radius:8px; cursor:pointer; white-space:nowrap;">🔄 Обновить</button>
            <button onclick="openAddExpenseModal()" style="padding:10px 20px; background:#007bff; color:white; border:none; border-radius:8px; cursor:pointer; white-space:nowrap;">➕ Добавить расход</button>
          </div>
        </div>

        <!-- Панель агентов -->
        <div id="profitAgentsPanel" style="display:none;">
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:15px; margin-bottom:15px;">
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">🤝 Всего агентов</div>
              <div style="font-size:24px; font-weight:700; color:#9c27b0;" id="agentsTotalCount">0</div>
            </div>
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">📦 Заказов от агентов</div>
              <div style="font-size:24px; font-weight:700; color:#2196f3;" id="agentsOrdersCount">0</div>
            </div>
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">� Чистая прибыль</div>
              <div style="font-size:24px; font-weight:700; color:#28a745;" id="agentsTotalProfit">0 сом</div>
            </div>
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">💸 Комиссия агентам (2%)</div>
              <div style="font-size:24px; font-weight:700; color:#dc3545;" id="agentsTotalCommission">0 сом</div>
            </div>
          </div>
          
          <div class="profit-controls" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <select id="agentsDateFilter" onchange="loadAgentsProfitReport()" style="padding:10px; border:1px solid #ddd; border-radius:8px; flex:1; min-width:150px;">
              <option value="today">Сегодня</option>
              <option value="yesterday">Вчера</option>
              <option value="week">За неделю</option>
              <option value="month" selected>За месяц</option>
              <option value="all">Все время</option>
            </select>
            <select id="agentsSortFilter" onchange="loadAgentsProfitReport()" style="padding:10px; border:1px solid #ddd; border-radius:8px; flex:1; min-width:150px;">
              <option value="orders-desc">По заказам (↓)</option>
              <option value="sum-desc">По прибыли (↓)</option>
              <option value="commission-desc">По комиссии (↓)</option>
              <option value="name">По имени</option>
            </select>
            <button onclick="loadAgentsProfitReport()" style="padding:10px 20px; background:#17a2b8; color:white; border:none; border-radius:8px; cursor:pointer; white-space:nowrap;">🔄 Обновить</button>
            <button onclick="exportAgentsProfitToExcel()" style="padding:10px 20px; background:#28a745; color:white; border:none; border-radius:8px; cursor:pointer; white-space:nowrap;">📥 Excel</button>
          </div>
        </div>
      </div>

      <!-- Таблица товаров -->
      <div id="profitProductsTable" class="profit-table-wrap profit-table-cards" style="flex:1; overflow-y:auto; padding:15px;">
        <table id="profitReportTable" style="width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
          <thead>
            <tr style="background:#f8f9fa; border-bottom:2px solid #e0e0e0;">
              <th style="padding:12px; text-align:left; font-size:13px; color:#666;">#</th>
              <th style="padding:12px; text-align:left; font-size:13px; color:#666;">Товар</th>
              <th style="padding:12px; text-align:center; font-size:13px; color:#666;">Категория</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">💵 Закупка</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">💰 Продажа</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">📊 Прибыль</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">% Наценка</th>
            </tr>
          </thead>
          <tbody id="profitReportBody">
            <!-- Данные загружаются динамически -->
          </tbody>
        </table>
      </div>

      <!-- Таблица заказов -->
      <div id="profitOrdersTable" class="profit-table-wrap profit-table-cards" style="display:none; flex:1; overflow-y:auto; padding:15px;">
        <table style="width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
          <thead>
            <tr style="background:#f8f9fa; border-bottom:2px solid #e0e0e0;">
              <th style="padding:12px; text-align:left; font-size:13px; color:#666;">#</th>
              <th style="padding:12px; text-align:left; font-size:13px; color:#666;">Дата</th>
              <th style="padding:12px; text-align:left; font-size:13px; color:#666;">👤 Клиент</th>
              <th style="padding:12px; text-align:center; font-size:13px; color:#666;">📦 Товаров</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">💵 Закупка</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">💰 Сумма</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">📊 Прибыль</th>
            </tr>
          </thead>
          <tbody id="orderProfitReportBody">
            <!-- Данные загружаются динамически -->
          </tbody>
        </table>
      </div>

      <!-- Таблица расходов -->
      <div id="profitExpensesTable" class="profit-table-wrap profit-table-cards" style="display:none; flex:1; overflow-y:auto; padding:15px;">
        <table style="width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
          <thead>
            <tr style="background:#f8f9fa; border-bottom:2px solid #e0e0e0;">
              <th style="padding:12px; text-align:left; font-size:13px; color:#666;">#</th>
              <th style="padding:12px; text-align:left; font-size:13px; color:#666;">Дата</th>
              <th style="padding:12px; text-align:left; font-size:13px; color:#666;">💸 Описание</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">💰 Сумма</th>
              <th style="padding:12px; text-align:center; font-size:13px; color:#666;">Действия</th>
            </tr>
          </thead>
          <tbody id="expensesReportBody">
            <!-- Данные загружаются динамически -->
          </tbody>
        </table>
      </div>

      <!-- Таблица агентов -->
      <div id="profitAgentsTable" class="profit-table-wrap profit-table-cards" style="display:none; flex:1; overflow-y:auto; padding:15px;">
        <div id="agentsProfitReportContent">
          <!-- Данные загружаются динамически -->
        </div>
      </div>
    </div>
  </div>


  <!-- Модальное окно добавления расхода -->
  <div id="addExpenseModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:9700; justify-content:center; align-items:center;">
    <div style="background:white; width:90%; max-width:500px; max-height:90vh; border-radius:12px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.3); display:flex; flex-direction:column;">
      <div style="background:linear-gradient(135deg, #dc3545 0%, #c82333 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0; font-size:22px;">💸 Добавить расход</h2>
        <button onclick="closeAddExpenseModal()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>
      
      <div style="padding:20px; overflow-y:auto; flex:1;">
        <div style="margin-bottom:15px;">
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Описание расхода:</label>
          <input type="text" id="expenseDescription" placeholder="Например: Аренда, зарплата, бензин" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
        </div>
        
        <div style="margin-bottom:15px;">
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Сумма (сом):</label>
          <input type="number" id="expenseAmount" placeholder="0" min="0" step="0.01" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
        </div>
        
        <div style="margin-bottom:20px;">
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Дата:</label>
          <input type="date" id="expenseDate" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
        </div>
        
        <div style="margin-bottom:20px; padding:15px; background:#f8f9fa; border-radius:8px; border:2px solid #e0e0e0;">
          <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
            <input type="checkbox" id="expenseIsRecurring" onchange="toggleRecurringOptions()" style="width:20px; height:20px; cursor:pointer;">
            <span style="font-weight:600; color:#333;">🔄 Регулярный расход</span>
          </label>
          
          <div id="recurringOptions" style="display:none; margin-top:15px;">
            <div style="margin-bottom:10px; padding:10px; background:white; border-radius:6px;  color:#666;">
              📌 Выберите дни недели, когда этот расход повторяется:
            </div>
            
            <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px; margin-top:10px;">
              <label style="display:flex; align-items:center; gap:8px; padding:10px; background:white; border-radius:6px; cursor:pointer; border:2px solid #e0e0e0; transition:all 0.2s;">
                <input type="checkbox" class="recurringDay" value="1" style="width:18px; height:18px; cursor:pointer;">
                <span style="font-weight:500;">Понедельник</span>
              </label>
              <label style="display:flex; align-items:center; gap:8px; padding:10px; background:white; border-radius:6px; cursor:pointer; border:2px solid #e0e0e0; transition:all 0.2s;">
                <input type="checkbox" class="recurringDay" value="2" style="width:18px; height:18px; cursor:pointer;">
                <span style="font-weight:500;">Вторник</span>
              </label>
              <label style="display:flex; align-items:center; gap:8px; padding:10px; background:white; border-radius:6px; cursor:pointer; border:2px solid #e0e0e0; transition:all 0.2s;">
                <input type="checkbox" class="recurringDay" value="3" style="width:18px; height:18px; cursor:pointer;">
                <span style="font-weight:500;">Среда</span>
              </label>
              <label style="display:flex; align-items:center; gap:8px; padding:10px; background:white; border-radius:6px; cursor:pointer; border:2px solid #e0e0e0; transition:all 0.2s;">
                <input type="checkbox" class="recurringDay" value="4" style="width:18px; height:18px; cursor:pointer;">
                <span style="font-weight:500;">Четверг</span>
              </label>
              <label style="display:flex; align-items:center; gap:8px; padding:10px; background:white; border-radius:6px; cursor:pointer; border:2px solid #e0e0e0; transition:all 0.2s;">
                <input type="checkbox" class="recurringDay" value="5" style="width:18px; height:18px; cursor:pointer;">
                <span style="font-weight:500;">Пятница</span>
              </label>
              <label style="display:flex; align-items:center; gap:8px; padding:10px; background:white; border-radius:6px; cursor:pointer; border:2px solid #e0e0e0; transition:all 0.2s;">
                <input type="checkbox" class="recurringDay" value="6" style="width:18px; height:18px; cursor:pointer;">
                <span style="font-weight:500;">Суббота</span>
              </label>
              <label style="display:flex; align-items:center; gap:8px; padding:10px; background:white; border-radius:6px; cursor:pointer; border:2px solid #e0e0e0; transition:all 0.2s;">
                <input type="checkbox" class="recurringDay" value="0" style="width:18px; height:18px; cursor:pointer;">
                <span style="font-weight:500;">Воскресенье</span>
              </label>
              <button onclick="selectAllDays()" type="button" style="padding:10px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:500; grid-column:span 2;">✓ Выбрать все дни</button>
            </div>
          </div>
        </div>
        
        <button onclick="saveExpense()" style="width:100%; padding:14px; background:linear-gradient(135deg, #dc3545 0%, #c82333 100%); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:16px;">💾 Сохранить расход</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно детального просмотра заказов клиента -->
  <div id="clientOrdersDetailModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:9700; justify-content:center; align-items:center;">
    <div style="background:white; width:95%; max-width:900px; max-height:90vh; border-radius:12px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
      <!-- Заголовок -->
      <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:22px;" id="clientDetailName">Заказы клиента</h2>
          <p style="margin:5px 0 0; opacity:0.9; " id="clientDetailInfo">Информация о заказах</p>
        </div>
        <button onclick="closeClientOrdersDetailModal()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- Сводка -->
      <div style="padding:15px; background:#f8f9fa; border-bottom:1px solid #e0e0e0;">
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
          <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
            <div style="font-size:12px; color:#666; margin-bottom:5px;">📦 Всего заказов</div>
            <div style="font-size:24px; font-weight:700; color:#007bff;" id="clientDetailTotalOrders">0</div>
          </div>
          <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
            <div style="font-size:12px; color:#666; margin-bottom:5px;">💰 Общая сумма продаж</div>
            <div style="font-size:24px; font-weight:700; color:#6c757d;" id="clientDetailTotalSale">0 сом</div>
          </div>
          <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
            <div style="font-size:12px; color:#666; margin-bottom:5px;">📊 Общая прибыль</div>
            <div style="font-size:24px; font-weight:700; color:#28a745;" id="clientDetailTotalProfit">0 сом</div>
          </div>
        </div>
      </div>

      <!-- Список заказов -->
      <div id="clientOrdersDetailList" style="flex:1; overflow-y:auto; padding:15px;">
        <div style="text-align:center; color:#999; padding:40px;">Загрузка...</div>
      </div>
    </div>
  </div>

  <!-- Модальное окно для просмотра товаров заказа -->
  <div id="orderItemsDetailModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:56px; background:rgba(0,0,0,0.7); z-index:9700;">
    <div style="background:white; width:100%; height:100%; max-width:900px; margin:0 auto; display:flex; flex-direction:column; overflow:hidden;">
      <!-- Заголовок -->
      <div style="background:linear-gradient(135deg, #007bff 0%, #0056b3 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center; flex-shrink:0;">
        <div>
          <h2 style="margin:0; font-size:22px;" id="orderItemsDetailTitle">Товары в заказе</h2>
          <p style="margin:5px 0 0; opacity:0.9; " id="orderItemsDetailInfo">Информация о заказе</p>
        </div>
        <button onclick="closeOrderItemsDetailModal()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- Список товаров -->
      <div id="orderItemsDetailContent" style="flex:1; overflow-y:auto; padding:20px;">
        <div style="text-align:center; color:#999; padding:40px;">Загрузка...</div>
      </div>

      <!-- Кнопки действий - прикреплены внизу -->
      <div style="padding:15px; background:#f8f9fa; border-top:1px solid #e0e0e0; display:flex; gap:10px; justify-content:flex-end; flex-shrink:0;">
        <button id="orderItemsAddBtn" style="padding:10px 20px; background:#17a2b8; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">
          ➕ Добавить товар
        </button>
        <button onclick="closeOrderItemsDetailModal()" style="padding:10px 20px; background:#6c757d; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">
          Закрыть
        </button>
      </div>
    </div>
  </div>

  <!-- Отдельная панель корзины -->
  <div id="cartPage" style="display:none; position:fixed; top:0; left:0; right:0; bottom:56px; background:#f5f5f5; z-index:9500;">
    <div style="height:100%; display:flex; flex-direction:column;">
      <!-- Заголовок корзины -->
      <div style="background:#fff; padding:15px 20px; border-bottom:1px solid #e0e0e0; display:flex; justify-content:space-between; align-items:center; flex-shrink:0;">
        <div style="font-size:17px; font-weight:600; color:#333;">Корзина</div>
        <button onclick="clearCart()" style="background:none; border:none; color:#f44336; font-size:13px; cursor:pointer;">Очистить</button>
      </div>
      
      <!-- Список товаров -->
      <div id="cartPageList" style="flex:1; overflow-y:auto; padding:0; background:#fff;"></div>
      
      <!-- Пустая корзина -->
      <div id="cartEmptyMessage" style="display:none; text-align:center; padding:60px 20px; color:#999; background:#fff; flex:1;">
        <div style="font-size:48px; margin-bottom:15px;">🛒</div>
        <div style="font-size:16px;">Корзина пуста</div>
      </div>
      
      <!-- Нижняя панель с итогом -->
      <div id="cartPageFooter" style="background:#fff; border-top:1px solid #e0e0e0; padding:15px 20px; flex-shrink:0;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <div style="font-size:14px; color:#666;">Итого:</div>
          <div style="font-size:20px; font-weight:600; color:#333;" id="cartPageTotal">0 сом</div>
        </div>
        <div id="cartPageSummary" style="font-size:12px; color:#888; margin-bottom:12px;"></div>
        <button onclick="(function(){ closeCartPage(); document.querySelector('.order-form').scrollIntoView({behavior:'smooth'}); })()" style="width:100%; background:#333; color:white; border:none; padding:15px; border-radius:8px; font-size:15px; font-weight:600; cursor:pointer;">Оформить заказ</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно избранных товаров -->
  <div id="favoritesPage" style="display:none; position:fixed; top:0; left:0; right:0; bottom:56px; background:#f5f5f5; z-index:9500;">
    <div style="height:100%; display:flex; flex-direction:column;">
      <!-- Заголовок избранного -->
      <div style="background:#fff; padding:15px 20px; border-bottom:1px solid #e0e0e0; display:flex; justify-content:space-between; align-items:center; flex-shrink:0;">
        <div style="font-size:17px; font-weight:600; color:#333;">Избранное</div>
        <button onclick="clearFavorites()" style="background:none; border:none; color:#f44336; font-size:13px; cursor:pointer;">Очистить</button>
      </div>
      
      <!-- Список избранных товаров -->
      <div id="favoritesPageItems" style="flex:1; overflow-y:auto; padding:0; background:#fff;">
        <!-- Товары будут добавлены через JS -->
      </div>
      
      <!-- Пустое избранное -->
      <div id="favoritesEmptyMessage" style="display:none; text-align:center; padding:60px 20px; color:#999; background:#fff; flex:1;">
        <div style="font-size:48px; margin-bottom:15px;">❤️</div>
        <div style="font-size:16px;">Избранное пусто</div>
      </div>
      
      <!-- Нижняя панель -->
      <div id="favoritesPageFooter" style="background:#fff; border-top:1px solid #e0e0e0; padding:15px 20px; flex-shrink:0;">
        <div id="favoritesPageSummary" style="font-size:12px; color:#888; margin-bottom:12px;"></div>
        <button onclick="addAllFavoritesToCart()" style="width:100%; background:#333; color:white; border:none; padding:15px; border-radius:8px; font-size:15px; font-weight:600; cursor:pointer;">Добавить все в корзину</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно отслеживания заказа для клиента -->
  <div id="trackOrderModal" onclick="if(event.target === this) closeTrackOrderModal();" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:8000; justify-content:center; align-items:center;">
    <div style="background:white; width:95%; max-width:600px; max-height:90vh; border-radius:16px; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
      <!-- Заголовок -->
      <div style="background:linear-gradient(135deg, #17a2b8 0%, #138496 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:22px;">📦 Отслеживание заказа</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:14px;">Введите ваш номер телефона</p>
        </div>
        <button onclick="closeTrackOrderModal()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:45px; height:45px; border-radius:50%; cursor:pointer;">&times;</button>
      </div>
      
      <!-- Поиск по телефону -->
      <div style="padding:20px; border-bottom:1px solid #e0e0e0;">
        <div style="display:flex; gap:10px;">
          <input type="tel" id="trackPhoneInput" placeholder="Ваш номер телефона" style="flex:3; min-width:0; padding:14px; border:2px solid #17a2b8; border-radius:10px; font-size:16px;">
          <button onclick="searchMyOrders()" style="flex:1; max-width:100px; padding:14px 10px; background:linear-gradient(135deg, #17a2b8, #138496); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600; font-size:14px; white-space:nowrap;">🔍 Найти</button>
        </div>
      </div>
      
      <!-- Список заказов клиента -->
      <div id="trackOrdersList" style="flex:1; overflow-y:auto; padding:20px; min-height:200px;">
        <div style="text-align:center; color:#999; padding:40px;">
          <div style="font-size:48px; margin-bottom:15px;">📱</div>
          <div>Введите номер телефона, указанный при заказе</div>
        </div>
      </div>
    </div>
  </div>

  <script>
// Добавить в НАЧАЛО основного <script> (после открывающего тега):
let searchFiltersActive = false;
let lastSearchResults = 0;

// === ОПТИМИЗАЦИЯ: Debounced renderProducts (переменные объявляем в начале) ===
let _renderProductsTimer = null;
let _renderProductsPending = false;


 let products = [];
 let isAdmin = false;
 let isEditorMode = false; // Режим редактирования товаров
 let cachedSellerCategories = []; // Кэш категорий продавцов
 let boxPurchaseMode = false; // Режим покупки по коробкам
 let productsReady = false; // Флаг готовности товаров (глобальная переменная)

 // ОПТИМИЗАЦИЯ: Debounce для предотвращения частых вызовов
 function debounce(func, wait) {
   let timeout;
   return function executedFunction(...args) {
     const later = () => {
       clearTimeout(timeout);
       func(...args);
     };
     clearTimeout(timeout);
     timeout = setTimeout(later, wait);
   };
 }

 // Функция переключения режима редактирования
 function toggleEditorMode() {
   isEditorMode = !isEditorMode;
   const btn = document.getElementById('editorModeBtn');
   if (btn) {
     if (isEditorMode) {
       btn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
       btn.innerHTML = '✅ Редактор ВКЛ';
     } else {
       btn.style.background = 'linear-gradient(135deg, #6c757d, #495057)';
       btn.innerHTML = '✏️ Редактор';
       
       // ВАЖНО: Принудительная очистка при выходе из режима редактора
       if (globalImageObserver) {
         globalImageObserver.disconnect();
         globalImageObserver = null;
       }
     }
   }
   renderProducts();
 }

 // Функция переключения режима покупки по коробкам
 function toggleBoxPurchaseMode() {
   boxPurchaseMode = !boxPurchaseMode;
   const btn = document.getElementById('boxModeBtn');
   if (btn) {
     const spanEl = btn.querySelector('span');
     if (boxPurchaseMode) {
       btn.classList.add('active');
       if (spanEl) spanEl.textContent = '📦 По коробкам: ВКЛ';
       btn.style.background = 'linear-gradient(135deg, #2e7d32, #4caf50)';
     } else {
       btn.classList.remove('active');
       if (spanEl) spanEl.textContent = '📦 По коробкам: ВЫКЛ';
       btn.style.background = 'linear-gradient(135deg, #757575, #9e9e9e)';
     }
   }
   // Перерисовываем карточки товаров
   renderProducts();
   
   Swal.fire({
     title: boxPurchaseMode ? '📦 Режим коробок ВКЛ' : '📌 Режим коробок ВЫКЛ',
     text: boxPurchaseMode ? 'Теперь каждое нажатие + добавляет целую коробку' : 'Теперь каждое нажатие + добавляет 1 пачку',
     icon: 'info',
     toast: true,
     position: 'top',
     timer: 2500,
     showConfirmButton: false
   });
 }
 

// Функция для генерации опций категорий (включая категории продавцов)
function generateCategoryOptions(currentCategory) {
  const standardOptions = [
    { value: 'все', label: 'Все товары' },
    { value: 'ножницы', label: '✂️ Ножницы' },
    { value: 'скотч', label: 'Скотч' },
    { value: 'нож', label: '🔪 Нож' },
    { value: 'корейские', label: 'Корейские товары' },
    { value: 'часы', label: '⌚ Часы' },
    { value: 'электроника', label: '🔌 Электроника' },
    { value: 'бытовые', label: 'Бытовые техники' }
  ];
  
  let html = '';
  
  // Стандартные категории
  standardOptions.forEach(opt => {
    const selected = (currentCategory || 'все').toLowerCase() === opt.value ? 'selected' : '';
    html += `<option value="${opt.value}" ${selected}>${opt.label}</option>`;
  });
  
  // Категории продавцов (только официальные из seller_categories)
  cachedSellerCategories.forEach(cat => {
    const catLower = cat.toLowerCase();
    if (!standardOptions.find(o => o.value === catLower)) {
      const selected = (currentCategory || '').toLowerCase() === catLower ? 'selected' : '';
      html += `<option value="${catLower}" ${selected}>🏪 ${cat}</option>`;
    }
  });
  
  // НЕ добавляем неизвестные категории из товаров - только официальные
  
  return html;
}

// Функция загрузки категорий продавцов
async function loadSellerCategoriesCache() {
  try {
    const standardCategories = ['все', 'ножницы', 'скотч', 'нож', 'корейские', 'часы', 'электроника', 'бытовые'];
    const categories = new Set();
    
    // Загружаем ТОЛЬКО из коллекции seller_categories (официальные категории)
    const snapshot = await db.collection('seller_categories').get();
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.name && !standardCategories.includes(data.name.toLowerCase())) {
        categories.add(data.name);
      }
    });
    
    // НЕ добавляем категории из товаров - только официальные из seller_categories
    
    cachedSellerCategories = [...categories];
    console.log('Загружено категорий продавцов:', cachedSellerCategories.length);
  } catch (e) {
    console.log('Ошибка загрузки категорий продавцов:', e);
  }
}

// Инициализация Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBRQ6hH7kXq7ApJmqbvTG1EQsXwxWEnaGg",
  authDomain: "svoysayet.firebaseapp.com",
  projectId: "svoysayet",
  storageBucket: "svoysayet.firebasestorage.app",
  messagingSenderId: "450143000217",
  appId: "1:450143000217:web:7495cefaea0b94966e8a08",
  measurementId: "G-Y8VG9E29FY"
};

// Проверка инициализации Firebase — делаем безопасно и ждём загрузки SDK
let db, storage;
function initFirebase() {
  try {
    if (typeof firebase === 'undefined') throw new Error('Firebase SDK не загружен');
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    db = firebase.firestore();
    storage = firebase.storage();
    console.log('Firebase initialized successfully');
  } catch (error) {
    console.error('Firebase initialization error:', error);
    Swal.fire('Ошибка', 'Ошибка инициализации Firebase: ' + error.message, 'error');
  }
}

if (typeof firebase !== 'undefined') {
  initFirebase();
} else {
  // Если SDK ещё не загружен — инициализируем после загрузки страницы
  window.addEventListener('load', initFirebase);
}

// ==================== СИСТЕМА УНИКАЛЬНЫХ ID КЛИЕНТОВ ====================

// Генерация или получение уникального ID клиента
let clientId = localStorage.getItem('chatClientId');
let clientName = localStorage.getItem('chatClientName');

// ==================== СИСТЕМА ПАРТНЕРОВ ====================

// Получаем реферальный код из URL (например: ?ref=partner1)
let partnerRef = null;
const urlParams = new URLSearchParams(window.location.search);

if (urlParams.has('ref')) {
  partnerRef = urlParams.get('ref');
  
  // Сохраняем в sessionStorage + localStorage
  const partnerData = {
    name: partnerRef,
    timestamp: Date.now()
  };
  sessionStorage.setItem('partnerData', JSON.stringify(partnerData));
  try {
    localStorage.setItem('partnerData', JSON.stringify(partnerData));
  } catch(e) {}
  
  // Показываем уведомление о партнере
  setTimeout(() => {
    Swal.fire({
      icon: 'info',
      title: 'Добро пожаловать! 🤝',
      html: `Вы перешли по партнерской ссылке <strong>${partnerRef}</strong>.<br><br>Все ваши заказы будут закреплены за этим партнером!`,
      timer: 5000,
      showConfirmButton: true,
      confirmButtonText: 'Понятно'
    });
  }, 1000);
} else {
  // Проверяем есть ли сохраненный партнер
  let savedData = sessionStorage.getItem('partnerData');
  if (!savedData) {
    try { savedData = localStorage.getItem('partnerData'); } catch(e) {}
  }
  
  if (savedData) {
    try {
      const partnerData = JSON.parse(savedData);
      const daysPassed = (Date.now() - partnerData.timestamp) / (1000 * 60 * 60 * 24);
      
      if (daysPassed <= 30) {
        partnerRef = partnerData.name;
      } else {
        sessionStorage.removeItem('partnerData');
        try { localStorage.removeItem('partnerData'); } catch(e) {}
      }
    } catch (e) {
      sessionStorage.removeItem('partnerData');
      try { localStorage.removeItem('partnerData'); } catch(e) {}
    }
  }
}

// Функция для получения текущего партнера (поддержка агентской системы)
function getCurrentPartner() {
  // Сначала проверяем URL параметр ref (агентская ссылка)
  try {
    const urlParams = new URLSearchParams(window.location.search);
    const ref = urlParams.get('ref');
    if (ref) {
      // Сохраняем в localStorage чтобы не потерять при перезагрузке
      localStorage.setItem('referralPartner', ref);
      return ref;
    }
  } catch(e) {}
  
  // Проверяем сохранённого реферального партнера
  try {
    const savedRef = localStorage.getItem('referralPartner');
    if (savedRef) return savedRef;
  } catch(e) {}
  
  // Старая система партнеров (partnerData)
  let savedData = sessionStorage.getItem('partnerData');
  if (!savedData) {
    try { savedData = localStorage.getItem('partnerData'); } catch(e) {}
  }
  if (!savedData) return null;
  
  try {
    const partnerData = JSON.parse(savedData);
    const daysPassed = (Date.now() - partnerData.timestamp) / (1000 * 60 * 60 * 24);
    
    if (daysPassed <= 30) {
      return partnerData.name;
    } else {
      sessionStorage.removeItem('partnerData');
      try { localStorage.removeItem('partnerData'); } catch(e) {}
      return null;
    }
  } catch (e) {
    sessionStorage.removeItem('partnerData');
    try { localStorage.removeItem('partnerData'); } catch(e) {}
    return null;
  }
}

if (!clientId) {
  // Генерируем уникальный ID для нового клиента
  clientId = 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  localStorage.setItem('chatClientId', clientId);
  console.log('Создан новый clientId:', clientId);
}

// Функция запроса имени клиента при первом открытии чата
async function ensureClientName() {
  // Сначала пробуем взять данные из профиля покупателя
  const savedCustomer = localStorage.getItem('customerData');
  if (savedCustomer) {
    try {
      const customer = JSON.parse(savedCustomer);
      if (customer.name) {
        clientName = customer.name;
        localStorage.setItem('chatClientName', customer.name);
        
        // Сохраняем клиента в базе данных
        try {
          if (typeof db !== 'undefined') {
            await db.collection('chatClients').doc(clientId).set({
              name: clientName,
              phone: customer.phone || '',
              lastActive: firebase.firestore.FieldValue.serverTimestamp(),
              hasUnread: false
            }, { merge: true });
            console.log('Клиент из профиля сохранен в чате:', clientName);
          }
        } catch (error) {
          console.error('Ошибка сохранения клиента:', error);
        }
        
        return clientName;
      }
    } catch (e) {
      console.error('Ошибка чтения профиля:', e);
    }
  }
  
  // Если профиля нет - предлагаем войти или представиться
  if (!clientName) {
    const result = await Swal.fire({
      title: 'Для чата нужно войти',
      text: 'Войдите в профиль или представьтесь',
      icon: 'info',
      showCancelButton: true,
      confirmButtonText: 'Войти в профиль',
      cancelButtonText: 'Продолжить как гость',
      confirmButtonColor: '#333'
    });
    
    if (result.isConfirmed) {
      // Открываем форму входа
      if (typeof showLoginRegisterForm === 'function') {
        showLoginRegisterForm();
      }
      return null;
    } else {
      // Запрашиваем имя гостя
      const { value: name } = await Swal.fire({
        title: 'Представьтесь, пожалуйста',
        input: 'text',
        inputPlaceholder: 'Введите ваше имя',
        showCancelButton: false,
        allowOutsideClick: false,
        confirmButtonText: 'Продолжить',
        confirmButtonColor: '#333',
        inputValidator: (value) => {
          if (!value) {
            return 'Пожалуйста, введите ваше имя!';
          }
        }
      });
      
      if (name) {
        clientName = name;
        localStorage.setItem('chatClientName', name);
        
        // Сохраняем клиента в базе данных
        try {
          if (typeof db !== 'undefined') {
            await db.collection('chatClients').doc(clientId).set({
              name: clientName,
              lastActive: firebase.firestore.FieldValue.serverTimestamp(),
              hasUnread: false
            });
            console.log('Гость сохранен в базе:', clientName);
          }
        } catch (error) {
          console.error('Ошибка сохранения клиента:', error);
        }
      }
    }
  }
  return clientName;
}

// Обновление активности клиента
async function updateClientActivity() {
  if (typeof db !== 'undefined' && clientId) {
    try {
      await db.collection('chatClients').doc(clientId).set({
        name: clientName || 'Клиент',
        lastActive: firebase.firestore.FieldValue.serverTimestamp(),
        hasUnread: true
      }, { merge: true });
    } catch (error) {
      console.error('Ошибка обновления активности:', error);
    }
  }
}

// Пароли
const ADMIN_PASSWORD = "13082007"; // Полный админ (синхронизирован с ADMIN_CUSTOMER_DATA в customer-auth.js)
const KOREAN_PASSWORD = "556655"; // Только корейские товары
const APPLIANCES_PASSWORD = "777888"; // Только бытовые техники

// Роль пользователя
let userRole = 'guest'; // 'guest', 'admin', 'korean', 'appliances'

// Текущая выбранная категория (по умолчанию "все" = показываем только мелочь)
let currentCategory = 'все';

// ОПТИМИЗАЦИЯ: Кэш для товаров
let productsCache = [];
let productsCacheTime = 0;
const CACHE_DURATION = 30000; // 30 секунд кэш

// Загрузка товаров
async function loadProducts() {
  try {
    // Проверяем кэш
    const now = Date.now();
    if (productsCache.length > 0 && (now - productsCacheTime) < CACHE_DURATION) {
      console.log('📦 Загрузка из кэша');
      products = productsCache;
      productsReady = true;
      renderProducts();
      return;
    }
    
    console.log('Loading products...');
    productsReady = false; // Сбрасываем флаг на время загрузки
    let snapshot;
    try {
      snapshot = await db.collection('products').orderBy('order').get();
    } catch (e) {
      // Если нет поля order, загружаем без сортировки
      snapshot = await db.collection('products').get();
    }
    products = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      // Убираем вызов несуществующей функции fixImageUrl
      products.push({ id: doc.id, ...data });
    });
    // Если нет сортировки по order, сортируем по названию
    if (!products.every(p => typeof p.order === 'number')) {
      products.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
    } else {
      products.sort((a, b) => (a.order || 0) - (b.order || 0));
    }
    console.log('Products loaded:', products.length);
    
    // ОПТИМИЗАЦИЯ: Сохраняем в кэш
    productsCache = [...products];
    productsCacheTime = Date.now();
    
    productsReady = true; // Устанавливаем флаг готовности
    
    // Загружаем кэш категорий продавцов
    await loadSellerCategoriesCache();
  } catch (error) {
    console.error('Error loading products:', error);
    productsReady = false;
    Swal.fire('Ошибка', 'Не удалось загрузить товары: ' + error.message, 'error');
  }
}



// Обработчик выбора файлач
// Теперь фото загружается на ImageBB, ссылка подставляется в newImage

document.getElementById('imageFile').addEventListener('change', async function(e) {
  const file = e.target.files[0];
  const addBtn = document.getElementById('addProductBtn');
  if (file) {
    addBtn.disabled = true;
    document.getElementById('newImage').value = '';
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('previewImg').src = e.target.result;
      document.getElementById('imagePreview').style.display = 'block';
    };
    reader.readAsDataURL(file);
    try {
      const url = await uploadToCloudinary(file);
      document.getElementById('newImage').value = url;
      addBtn.disabled = false;
      Swal.fire('Фото загружено на ImageBB!', '', 'success');
      console.log('Image uploaded to ImageBB and url set to newImage input:', url);
    } catch (err) {
      Swal.fire('Ошибка', 'Не удалось загрузить изображение на ImageBB', 'error');
      addBtn.disabled = false;
    }
  }
});

// Обработчик выбора файла из галереи
// Теперь фото из галереи загружается на ImageBB

document.getElementById('galleryFile').addEventListener('change', async function(e) {
  const file = e.target.files[0];
  const addBtn = document.getElementById('addProductBtn');
  if (file) {
    addBtn.disabled = true;
    document.getElementById('newImage').value = '';
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('previewImg').src = e.target.result;
      document.getElementById('imagePreview').style.display = 'block';
    };
    reader.readAsDataURL(file);
    try {
      const url = await uploadToCloudinary(file);
      document.getElementById('newImage').value = url;
      addBtn.disabled = false;
      Swal.fire('Фото загружено на ImageBB!', '', 'success');
      console.log('Image from gallery uploaded to ImageBB and url set to newImage input:', url);
    } catch (err) {
      Swal.fire('Ошибка', 'Не удалось загрузить изображение на ImageBB', 'error');
      addBtn.disabled = false;
    }
  }
});

// Автоматический расчет наценки при вводе цен
function setupProfitCalculator() {
  const costPriceInput = document.getElementById('newCostPrice');
  const salePriceInput = document.getElementById('newPrice');
  const profitDisplay = document.getElementById('profitDisplay');
  const profitAmount = document.getElementById('profitAmount');
  const profitPercent = document.getElementById('profitPercent');
  
  // Определяем iOS
  const isIOSDevice = /iPad|iPhone|iPod/.test(navigator.userAgent);
  
  function calculateProfit() {
    const costPrice = parseFloat(costPriceInput.value) || 0;
    const salePrice = parseFloat(salePriceInput.value) || 0;
    
    if (costPrice > 0 && salePrice > 0) {
      const profit = salePrice - costPrice;
      const profitPercentage = ((profit / costPrice) * 100).toFixed(2);
      
      profitAmount.textContent = profit.toFixed(2);
      profitPercent.textContent = profitPercentage;
      profitDisplay.style.display = 'block';
      
      // Цветовое обозначение
      if (profit > 0) {
        profitDisplay.style.background = '#e8f5e9';
        profitDisplay.style.color = '#2e7d32';
      } else if (profit < 0) {
        profitDisplay.style.background = '#ffebee';
        profitDisplay.style.color = '#c62828';
      } else {
        profitDisplay.style.background = '#fff3e0';
        profitDisplay.style.color = '#ef6c00';
      }
    } else {
      profitDisplay.style.display = 'none';
    }
  }
  
  if (costPriceInput && salePriceInput) {
    if (isIOSDevice) {
      // На iOS - расчёт ТОЛЬКО при потере фокуса (blur), не при вводе!
      // Это полностью убирает тормоза при печати
      costPriceInput.addEventListener('blur', calculateProfit);
      salePriceInput.addEventListener('blur', calculateProfit);
    } else {
      // На других устройствах - обычный debounce
      let profitCalculationTimeout = null;
      function debouncedCalculateProfit() {
        clearTimeout(profitCalculationTimeout);
        profitCalculationTimeout = setTimeout(calculateProfit, 300);
      }
      costPriceInput.addEventListener('input', debouncedCalculateProfit);
      salePriceInput.addEventListener('input', debouncedCalculateProfit);
    }
  }
}

// Обработчик кнопки добавления товара
// Теперь добавлена автоматическая проверка валидности изображения по URL

document.getElementById('addProductBtn').addEventListener('click', async function() {
  try {
    console.log('Add product button clicked');
    const newTitleEl = document.getElementById('newTitle');
    const rawTitle = newTitleEl ? newTitleEl.value : '';
    const title = sanitizeProductTitle(rawTitle);
    if (newTitleEl && title !== rawTitle.trim()) newTitleEl.value = title;
    const costPrice = parseFloat(document.getElementById('newCostPrice').value) || 0;
    const price = +document.getElementById('newPrice').value;
    let category = document.getElementById('newCategory').value;
    
    // Проверяем, есть ли новая категория в поле ввода
    const newCatInput = document.getElementById('newCategoryInput').value.trim();
    if (newCatInput) {
      // Если введена новая категория - используем её
      category = newCatInput.toLowerCase();
    }
    
    // Корейский менеджер может добавлять только корейские товары, часы или электронику
    if (userRole === 'korean' && category !== 'корейские' && category !== 'часы' && category !== 'электроника') {
      category = 'корейские'; // По умолчанию корейские, если выбрана другая категория
    }
    
    // Менеджер бытовых техник может добавлять только бытовые техники
    if (userRole === 'appliances') {
      category = 'бытовые';
    }
    
    const optPrice = +document.getElementById('newOptPrice').value;
    const optQty = +document.getElementById('newOptQty').value;
    const minQty = +document.getElementById('newMinQty').value;
    const stockRaw = (document.getElementById('newStock') && document.getElementById('newStock').value != null)
      ? String(document.getElementById('newStock').value).trim()
      : '';
    let stock = null;
    if (stockRaw !== '') {
      const parsed = parseInt(stockRaw, 10);
      if (isNaN(parsed) || parsed < 0) {
        Swal.fire('Ошибка', 'Остаток должен быть числом 0 или больше', 'warning');
        return;
      }
      stock = parsed;
    }
    const urlInput = document.getElementById('newImage').value.trim();
    let imageUrl = '';
    if (urlInput) {
      imageUrl = urlInput;
      console.log('Using manual url:', imageUrl);
    } else {
      imageUrl = document.getElementById('newImage').value.trim();
      if (!imageUrl) {
        Swal.fire('Ошибка', 'Укажите URL изображения или загрузите файл!', 'warning');
        return;
      }
    }

    // Валидация
    if (!title) {
      Swal.fire('Ошибка', 'Введите название товара', 'warning');
      return;
    }
    if (!price || price <= 0) {
      Swal.fire('Ошибка', 'Введите цену продажи', 'warning');
      return;
    }
    // Проверка на убыток только если цена закупки указана
    if (costPrice > 0 && price <= costPrice) {
      const result = await Swal.fire({
        title: 'Предупреждение!',
        text: 'Цена продажи меньше или равна цене закупки. Продолжить?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Да, продолжить',
        cancelButtonText: 'Отмена'
      });
      if (!result.isConfirmed) return;
    }

    // --- Индикатор проверки изображения ---
    const addBtn = document.getElementById('addProductBtn');
    addBtn.disabled = true;
    addBtn.textContent = 'Проверка изображения...';
    const isValidImage = await checkImage(imageUrl);
    if (!isValidImage) {
      addBtn.disabled = false;
      addBtn.textContent = 'Добавить товар';
      Swal.fire('Ошибка', 'Изображение не загружается! Проверьте ссылку или попробуйте другой файл/URL.', 'error');
      return;
    }
    addBtn.textContent = 'Добавление...';
    // --- конец индикатора ---

    // Находим максимальный order среди товаров
    let maxOrder = 0;
    products.forEach(p => {
      if (typeof p.order === 'number' && p.order > maxOrder) maxOrder = p.order;
    });

    const description = document.getElementById('newDescription').value.trim();
    
    // Проверяем, является ли товар пачкой
    const isPack = document.getElementById('newIsPack').checked;
    const packQty = parseInt(document.getElementById('newPackQty').value) || 6;
    const packsPerBox = parseInt(document.getElementById('newPacksPerBox').value) || 20;
    
    // Собираем дополнительные фото
    const extraImages = extraPhotoUrls.map(p => p.url).filter(url => url && url.trim());
    
    const productData = { 
      title, 
      description: description || '',
      costPrice,
      price,
      category: category || 'все',
      optPrice: optPrice > 0 ? optPrice : null,
      optQty: optQty > 0 ? optQty : null,
      minQty: minQty > 0 ? minQty : 1,
      ...(stock !== null ? { stock } : {}),
      image: imageUrl,
      extraImages: extraImages.length > 0 ? extraImages : [],
      order: maxOrder + 1,
      createdAt: Date.now(),
      // Параметры для товаров-пачек
      isPack: isPack,
      packQty: isPack ? packQty : null,
      packsPerBox: isPack ? packsPerBox : null,
      // Варианты товара (цвет, размер и т.д.)
      variants: typeof getEditingVariants === 'function' ? getEditingVariants() : null,
      // Добавляем ID продавца если это продавец
      ...(userRole === 'seller' && currentSeller ? { sellerId: currentSeller.id, sellerName: currentSeller.name } : {})
    };
    
    console.log('Adding product to Firestore:', productData);
    const docRef = await db.collection('products').add(productData);
    console.log('Product added with ID:', docRef.id);
    
    // Если создана новая категория - сохраняем её (для админа и продавца)
    const newCategoryInputValue = document.getElementById('newCategoryInput').value.trim();
    if (newCategoryInputValue) {
      // Сохраняем новую категорию в Firebase
      await db.collection('seller_categories').add({
        name: newCategoryInputValue,
        sellerId: isAdmin ? 'admin' : (currentSeller ? currentSeller.id : 'unknown'),
        sellerName: isAdmin ? 'Главный администратор' : (currentSeller ? currentSeller.name : 'Неизвестно'),
        createdAt: Date.now(),
        status: isAdmin ? 'approved' : 'pending' // Категории от админа сразу одобрены
      });
      
      // Отправляем уведомление в Telegram (только для продавцов)
      if (userRole === 'seller' && currentSeller) {
        const message = `🆕 *НОВАЯ КАТЕГОРИЯ ОТ ПРОДАВЦА*\n\n` +
          `📁 *Категория:* ${newCategoryInputValue}\n` +
          `👤 *Продавец:* ${currentSeller.name}\n` +
          `📱 *Телефон:* ${currentSeller.phone || 'не указан'}\n` +
          `🏷️ *Товар:* ${productData.title}\n\n` +
          `🕐 *Дата:* ${new Date().toLocaleString('ru-RU')}`;
        
        fetch('https://api.telegram.org/bot7599592948:AAGtc_dGAcJFVQOSYcKVY0W-7GegszY9n8E/sendMessage', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: '5567924440',
            text: message,
            parse_mode: 'Markdown'
          })
        });
      }
    }
    
    // Закрываем окно добавления товара сразу
    document.getElementById('addProductWindow').style.display = 'none';
    unlockPageScroll();
    
    // Показываем сообщение об успехе
    Swal.fire('Товар добавлен!', 'Товар успешно добавлен в каталог', 'success');
    
    // Загружаем товары ОДИН раз и обновляем отображение
    await loadProducts();
    renderProducts();
    loadSellerCategories(); // Обновляем категории продавцов
    
    // Очистка формы
    document.getElementById('newImage').value = '';
    document.getElementById('newTitle').value = '';
    document.getElementById('newDescription').value = '';
    document.getElementById('newCostPrice').value = '';
    document.getElementById('newPrice').value = '';
    document.getElementById('newCategory').value = '';
    document.getElementById('newCategoryInput').value = '';
    document.getElementById('newCategoryInputDiv').style.display = 'none';
    document.getElementById('newOptPrice').value = '';
    document.getElementById('newOptQty').value = '';
    document.getElementById('newMinQty').value = '';
    if (document.getElementById('newStock')) document.getElementById('newStock').value = '';
    // Очистка полей для пачек
    document.getElementById('newIsPack').checked = false;
    document.getElementById('newPackQty').value = '';
    document.getElementById('newPackQty').style.display = 'none';
    document.getElementById('newPacksPerBox').value = '';
    document.getElementById('newPacksPerBox').style.display = 'none';
    document.getElementById('packCalculationPreview').style.display = 'none';
    // Очистка дополнительных фото
    document.getElementById('extraPhotosContainer').innerHTML = '';
    document.getElementById('extraPhotosPreview').innerHTML = '';
    extraPhotoUrls = [];
    // Очистка вариантов товара
    if (typeof clearEditingVariants === 'function') clearEditingVariants();
    document.getElementById('imageFile').value = '';
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('profitDisplay').style.display = 'none';
  } catch (error) {
    console.error('Error details:', error);
    document.getElementById('addProductBtn').disabled = false;
    document.getElementById('addProductBtn').textContent = 'Добавить товар';
    Swal.fire('Ошибка', `Не удалось добавить товар: ${error.message}`, 'error');
  }
});

// Функция переключения видимости поля количества штук в пачке
function togglePackQtyField() {
  const isPackCheckbox = document.getElementById('newIsPack');
  const packQtyInput = document.getElementById('newPackQty');
  const packsPerBoxInput = document.getElementById('newPacksPerBox');
  const calcPreview = document.getElementById('packCalculationPreview');
  
  if (isPackCheckbox.checked) {
    packQtyInput.style.display = 'block';
    packsPerBoxInput.style.display = 'block';
    packQtyInput.placeholder = 'Сколько штук в 1 пачке (напр. 6)';
    if (!packQtyInput.value) packQtyInput.value = 6;
    if (!packsPerBoxInput.value) packsPerBoxInput.value = 20;
    updatePackCalculationPreview();
  } else {
    packQtyInput.style.display = 'none';
    packsPerBoxInput.style.display = 'none';
    calcPreview.style.display = 'none';
    packQtyInput.value = '';
    packsPerBoxInput.value = '';
  }
}

// Переменные для updatePackCalculationPreview
let packCalcPreviewTimeout = null;
const _packCalcIsIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

// Основная функция расчёта пачки
function doPackCalculation() {
  const packQty = parseInt(document.getElementById('newPackQty').value) || 0;
  const packsPerBox = parseInt(document.getElementById('newPacksPerBox').value) || 0;
  const calcPreview = document.getElementById('packCalculationPreview');
  
  if (packQty > 0 && packsPerBox > 0) {
    calcPreview.style.display = 'block';
    calcPreview.innerHTML = `
      <div style="font-weight:700;margin-bottom:4px;">📊 Расчёт для клиента:</div>
      <div>📦 1 пачка = <b>${packQty}</b> шт</div>
      <div style="margin-top:4px;font-size:12px;color:#1565c0;">💡 Клиент введёт кол-во ПАЧЕК, а не штук!</div>
    `;
  } else {
    calcPreview.style.display = 'none';
  }
}

// Функция обновления предпросмотра расчёта пачки/коробки
function updatePackCalculationPreview() {
  if (_packCalcIsIOS) {
    // На iOS - не делаем ничего при input, расчёт будет при blur
    return;
  }
  // На других устройствах - debounce
  clearTimeout(packCalcPreviewTimeout);
  packCalcPreviewTimeout = setTimeout(doPackCalculation, 150);
}

// Для iOS - добавляем обработчики blur при загрузке
if (_packCalcIsIOS) {
  document.addEventListener('DOMContentLoaded', function() {
    const packQtyInput = document.getElementById('newPackQty');
    const packsPerBoxInput = document.getElementById('newPacksPerBox');
    if (packQtyInput) packQtyInput.addEventListener('blur', doPackCalculation);
    if (packsPerBoxInput) packsPerBoxInput.addEventListener('blur', doPackCalculation);
  });
}

// Массив для хранения дополнительных URL фото
let extraPhotoUrls = [];
let extraPhotoCounter = 0;

// Функция добавления поля для дополнительного фото
function addExtraPhotoField() {
  const container = document.getElementById('extraPhotosContainer');
  const currentFields = container.querySelectorAll('.extra-photo-field').length;
  
  if (currentFields >= 5) {
    Swal.fire('Ограничение', 'Можно добавить максимум 5 дополнительных фото', 'warning');
    return;
  }
  
  extraPhotoCounter++;
  const fieldId = extraPhotoCounter;
  
  const fieldDiv = document.createElement('div');
  fieldDiv.className = 'extra-photo-field';
  fieldDiv.id = `extraPhotoField_${fieldId}`;
  fieldDiv.style.cssText = 'display:flex; gap:8px; align-items:center;';
  fieldDiv.innerHTML = `
    <input type="file" accept="image/*" onchange="handleExtraPhotoFile(this, ${fieldId})" style="flex:1; padding:8px; border:1px solid #90caf9; border-radius:6px; font-size:12px;">
    <input type="text" placeholder="или URL фото" id="extraPhotoUrl_${fieldId}" onchange="handleExtraPhotoUrl(this, ${fieldId})" style="flex:1; padding:8px; border:1px solid #90caf9; border-radius:6px; font-size:12px;">
    <button type="button" onclick="removeExtraPhotoField(${fieldId})" style="background:#dc3545; color:white; border:none; width:32px; height:32px; border-radius:6px; cursor:pointer; font-size:16px;">✕</button>
  `;
  
  container.appendChild(fieldDiv);
}

// Обработка загрузки файла дополнительного фото (на Cloudinary)
async function handleExtraPhotoFile(input, fieldId) {
  const file = input.files[0];
  if (!file) return;
  
  try {
    Swal.fire({
      title: 'Загрузка фото...',
      text: 'Подождите...',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });
    
    // Используем Cloudinary для хранения
    const url = await uploadToCloudinary(file);
    
    // Сохраняем URL
    extraPhotoUrls = extraPhotoUrls.filter(p => p.fieldId !== fieldId);
    extraPhotoUrls.push({ fieldId, url });
    
    updateExtraPhotosPreview();
    Swal.close();
    
    Swal.fire({
      icon: 'success',
      title: 'Фото загружено!',
      toast: true,
      position: 'bottom',
      timer: 2000,
      showConfirmButton: false
    });
    
  } catch (error) {
    console.error('Ошибка загрузки фото:', error);
    Swal.fire('Ошибка', 'Не удалось загрузить фото: ' + error.message, 'error');
  }
}

// Обработка URL дополнительного фото
function handleExtraPhotoUrl(input, fieldId) {
  const url = input.value.trim();
  if (!url) {
    extraPhotoUrls = extraPhotoUrls.filter(p => p.fieldId !== fieldId);
    updateExtraPhotosPreview();
    return;
  }
  
  // Проверяем, что URL — это изображение
  extraPhotoUrls = extraPhotoUrls.filter(p => p.fieldId !== fieldId);
  extraPhotoUrls.push({ fieldId, url });
  updateExtraPhotosPreview();
}

// Удаление поля дополнительного фото
function removeExtraPhotoField(fieldId) {
  const field = document.getElementById(`extraPhotoField_${fieldId}`);
  if (field) field.remove();
  
  extraPhotoUrls = extraPhotoUrls.filter(p => p.fieldId !== fieldId);
  updateExtraPhotosPreview();
}

// Обновление превью дополнительных фото
function updateExtraPhotosPreview() {
  const preview = document.getElementById('extraPhotosPreview');
  if (!preview) return;
  
  preview.innerHTML = extraPhotoUrls.map(p => `
    <img src="${p.url}" alt="Фото" style="width:60px; height:60px; object-fit:cover; border-radius:6px; border:2px solid #2196f3;">
  `).join('');
}




    

// Временное хранилище для нового фото при редактировании
window.newExtraPhotoForEdit = null;

// Добавить новое фото в редактор
async function addNewExtraPhotoToEdit() {
  const fileInput = document.getElementById('newExtraPhotoFile');
  const urlInput = document.getElementById('newExtraPhotoUrl');
  const container = document.getElementById('editExtraPhotosContainer');
  
  let newUrl = '';
  
  if (fileInput.files && fileInput.files[0]) {
    // Загружаем файл на Cloudinary
    try {
      Swal.showLoading();
      newUrl = await uploadToCloudinary(fileInput.files[0]);
      Swal.hideLoading();
    } catch (error) {
      console.error('Ошибка загрузки:', error);
      Swal.fire('Ошибка', 'Не удалось загрузить фото', 'error');
      return;
    }
  } else if (urlInput.value.trim()) {
    newUrl = urlInput.value.trim();
  }
  
  if (!newUrl) return;
  
  // Считаем текущее количество фото
  const currentCount = container.querySelectorAll('[id^="editExtraPhoto_"]').length;
  const idx = Date.now(); // Уникальный ID
  
  // Удаляем текст "Дополнительных фото нет" если он есть
  const noPhotosText = container.querySelector('p');
  if (noPhotosText) noPhotosText.remove();
  
  // Добавляем новое фото
  const photoDiv = document.createElement('div');
  photoDiv.style.cssText = 'display:flex; gap:8px; align-items:center; margin-bottom:8px;';
  photoDiv.id = `editExtraPhoto_${idx}`;
  photoDiv.innerHTML = `
    <img src="${newUrl}" style="width:50px; height:50px; object-fit:cover; border-radius:6px;">
    <input type="text" value="${newUrl}" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:12px;" id="editExtraPhotoUrl_${idx}">
    <button type="button" onclick="document.getElementById('editExtraPhoto_${idx}').remove()" style="background:#dc3545; color:white; border:none; width:30px; height:30px; border-radius:6px; cursor:pointer;">✕</button>
  `;
  
  container.appendChild(photoDiv);
  
  // Очищаем поля ввода
  fileInput.value = '';
  urlInput.value = '';
}

// Инициализация корзины
const cart = JSON.parse(localStorage.getItem('cart')) || [];

const productTable = document.getElementById('productTable');
const search = document.getElementById('search');
const sort = document.getElementById('sort');
const cartList = document.getElementById('cartList');
const totalSum = document.getElementById('totalSum');


// Автозаполнение данных пользователя из localStorage
const userData = JSON.parse(localStorage.getItem('userData') || '{}');
if (userData.name) document.getElementById('name').value = userData.name;
if (userData.phone) document.getElementById('phone').value = userData.phone;
if (userData.address) document.getElementById('address').value = userData.address;
if (userData.driverName) document.getElementById('driverName').value = userData.driverName;
if (userData.driverPhone) document.getElementById('driverPhone').value = userData.driverPhone;

// Функция фильтрации по категориям
function filterByCategory(category, btn) {
  currentCategory = category;
  
  // Обновляем активную кнопку
  const buttons = document.querySelectorAll('.category-btn');
  buttons.forEach(b => b.classList.remove('active'));
  
  // Если передана кнопка напрямую - используем её
  // Иначе ищем кнопку по data-category
  if (btn && btn.classList) {
    btn.classList.add('active');
  } else if (typeof event !== 'undefined' && event && event.target) {
    event.target.classList.add('active');
  } else {
    // Ищем кнопку по категории
    const targetBtn = document.querySelector(`.category-btn[data-category="${category}"]`);
    if (targetBtn) targetBtn.classList.add('active');
  }
  
  // Перерисовываем товары
  renderProducts();
  
  // Принудительно прокручиваем страницу на самый верх
  setTimeout(() => {
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
    window.scrollTo(0, 0);
  }, 50);
}




// Инициализация корзины и привязки при загрузке страницы

document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing...');
  
  // ===== БЛОКИРОВКА ЗУМА НА iOS =====
  // Блокируем зум только вне модальных окон для лучшей работы форм
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  
  if (isIOS) {
    // Блокируем только pinch-to-zoom жесты, не трогаем input
    document.addEventListener('gesturestart', function(e) {
      // Не блокируем внутри модальных окон
      if (e.target.closest('#addProductWindow') || e.target.closest('.swal2-container')) return;
      e.preventDefault();
    }, { passive: false });
    
    document.addEventListener('gesturechange', function(e) {
      if (e.target.closest('#addProductWindow') || e.target.closest('.swal2-container')) return;
      e.preventDefault();
    }, { passive: false });
    
    document.addEventListener('gestureend', function(e) {
      if (e.target.closest('#addProductWindow') || e.target.closest('.swal2-container')) return;
      e.preventDefault();
    }, { passive: false });
  }
  // ===== КОНЕЦ БЛОКИРОВКИ ЗУМА =====
  
  // Автозаполнение поля "Кто порекомендовал"
  const referredByInput = document.getElementById('referredBy');
  if (referredByInput) {
    try {
      const savedReferredBy = localStorage.getItem('savedReferredBy');
      if (savedReferredBy && !getCurrentPartner()) {
        // Заполняем только если нет партнера из URL
        referredByInput.value = savedReferredBy;
        referredByInput.style.borderColor = '#28a745';
        referredByInput.style.background = '#f0fff4';
      }
    } catch(e) {}
  }

  try {
    loadProducts().then(() => {
      renderProducts(); // Отображаем товары после загрузки
      loadSellerCategories(); // Загружаем категории продавцов
      updateCart(); // Обновляем корзину ПОСЛЕ загрузки товаров
      updateFavoritesCount(); // Обновляем счётчик избранного
      
      // Проверяем сохранённого продавца (после загрузки товаров)
      if (typeof checkSavedSeller === 'function') checkSavedSeller();
      
      // Инициализируем калькулятор прибыли
      if (typeof setupProfitCalculator === 'function') setupProfitCalculator();
      
      // Заполняем форму заказа данными авторизованного клиента
      if (typeof fillOrderFormWithCustomerData === 'function') fillOrderFormWithCustomerData();
    });
    
    // Если уже был вход как админ (например, после обновления), показать панель
    if (isAdmin) {
      const adminPanel = document.getElementById('adminPanel');
      if (adminPanel) adminPanel.style.display = '';
    }
    
    // Обработчик кнопки выхода из профиля
    const logoutBtn = document.getElementById('logoutUser');
    if (logoutBtn) {
      console.log('Кнопка выхода найдена, привязываем обработчик');
      logoutBtn.addEventListener('click', function() {
        console.log('Клик по кнопке выхода');
        isAdmin = false;
        
        // Безопасная работа с элементами - проверяем существование
        const adminAddProduct = document.getElementById('adminAddProduct');
        if (adminAddProduct) adminAddProduct.style.display = 'none';
        
        const adminAuth = document.getElementById('adminAuth');
        if (adminAuth) adminAuth.style.display = 'block';
        
        const managementHeader = document.getElementById('managementHeader');
        if (managementHeader) managementHeader.style.display = 'none';
        
        const adminPassword = document.getElementById('adminPassword');
        if (adminPassword) adminPassword.value = '';
        
        localStorage.removeItem('userData');
        
        const nameField = document.getElementById('name');
        if (nameField) nameField.value = '';
        
        const phoneField = document.getElementById('phone');
        if (phoneField) phoneField.value = '';
        
        const addressField = document.getElementById('address');
        if (addressField) addressField.value = '';
        
        Swal.fire('Вы вышли из профиля');
        renderProducts();
        
        // Скрываем админ-панель
        const adminPanel = document.getElementById('adminPanel');
        if (adminPanel) adminPanel.style.display = 'none';
      });
    } else {
      console.log('Кнопка выхода НЕ найдена');
    }
  } catch (error) {
    console.error('Error during initialization:', error);
    Swal.fire('Ошибка', 'Ошибка при загрузке страницы: ' + error.message, 'error');
  }
});

document.getElementById('submitOrder').onclick = async () => {
  const submitBtn = document.getElementById('submitOrder');
  const name = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const address = document.getElementById('address').value.trim();
  let driverName = document.getElementById('driverName').value.trim();
  let driverPhone = document.getElementById('driverPhone').value.trim();
  const referredBy = document.getElementById('referredBy').value.trim();
  
  // Проверяем сохранённые данные водителя
  const savedUserData = JSON.parse(localStorage.getItem('userData') || '{}');
  const savedDriverName = savedUserData.driverName || '';
  const savedDriverPhone = savedUserData.driverPhone || '';
  
  // Если есть сохранённый водитель и текущие поля пустые или совпадают - спрашиваем подтверждение
  if (savedDriverName || savedDriverPhone) {
    const result = await Swal.fire({
      title: '🚗 Данные водителя',
      html: `
        <div style="text-align:left; padding:10px 0;">
          <p style="margin-bottom:15px; color:#666;">Подтвердите или измените данные водителя:</p>
          <div style="margin-bottom:12px;">
            <label style="display:block; margin-bottom:5px; font-weight:600; color:#333;">Имя водителя:</label>
            <input type="text" id="swal-driver-name" value="${driverName || savedDriverName}" placeholder="Имя водителя" style="width:100%; padding:12px; border:2px solid #17a2b8; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          <div style="margin-bottom:12px;">
            <label style="display:block; margin-bottom:5px; font-weight:600; color:#333;">Телефон водителя:</label>
            <input type="tel" id="swal-driver-phone" value="${driverPhone || savedDriverPhone}" placeholder="Номер водителя" style="width:100%; padding:12px; border:2px solid #17a2b8; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: '✅ Подтвердить и заказать',
      cancelButtonText: '❌ Отмена',
      confirmButtonColor: '#28a745',
      cancelButtonColor: '#6c757d',
      preConfirm: () => {
        return {
          driverName: document.getElementById('swal-driver-name').value.trim(),
          driverPhone: document.getElementById('swal-driver-phone').value.trim()
        };
      }
    });
    
    if (!result.isConfirmed) {
      return; // Отмена заказа
    }
    
    // Обновляем данные водителя из диалога
    driverName = result.value.driverName;
    driverPhone = result.value.driverPhone;
    
    // Обновляем поля формы
    document.getElementById('driverName').value = driverName;
    document.getElementById('driverPhone').value = driverPhone;
  }

  // Анти-спам при 429/Quota exceeded
  try {
    const cooldownUntil = parseInt(localStorage.getItem('firestoreCooldownUntil') || '0', 10) || 0;
    if (Date.now() < cooldownUntil) {
      const sec = Math.ceil((cooldownUntil - Date.now()) / 1000);
      Swal.fire('Подождите', `Слишком много запросов. Повторите через ${sec} сек.`, 'warning');
      return;
    }
  } catch (e) {}

  if (!name || !phone || !address || cart.length === 0) {
    Swal.fire('Ошибка', 'Заполните все поля и добавьте товары', 'warning');
    return;
  }

  // Блокируем кнопку
  submitBtn.disabled = true;
  submitBtn.style.opacity = '0.5';
  submitBtn.style.cursor = 'not-allowed';
  const originalText = submitBtn.textContent;
  submitBtn.textContent = 'Проверка товаров...';

  try {
    // ВАЖНО: Проверяем все товары в корзине - существуют ли они и не заблокированы ли
    const validCart = [];
    const blockedItems = [];
    const deletedItems = [];
    const outOfStockItems = [];
    
    for (const cartItem of cart) {
      const product = products.find(p => p.id === cartItem.id);
      
      if (!product) {
        // Товар удалён из базы
        deletedItems.push(cartItem.title);
      } else if (product.blocked) {
        // Товар заблокирован
        blockedItems.push(cartItem.title);
      } else if (typeof product.stock === 'number' && isFinite(product.stock)) {
        const stock = Math.max(0, Math.floor(product.stock));
        if (stock <= 0) {
          outOfStockItems.push(`${cartItem.title} (нет в наличии)`);
        } else if ((cartItem.qty || 0) > stock) {
          outOfStockItems.push(`${cartItem.title} (доступно ${stock} шт)`);
        } else {
          // Товар валидный, обновляем данные из базы
          validCart.push({
            ...cartItem,
            title: product.title, // Берём актуальное название
            price: product.price, // Берём актуальную цену
            costPrice: product.costPrice || 0, // Берём актуальную себестоимость
            sellerId: product.sellerId || cartItem.sellerId || null, // ID продавца
            sellerName: product.sellerName || cartItem.sellerName || null
          });
        }
      } else {
        // Товар валидный, обновляем данные из базы
        validCart.push({
          ...cartItem,
          title: product.title, // Берём актуальное название
          price: product.price, // Берём актуальную цену
          costPrice: product.costPrice || 0, // Берём актуальную себестоимость
          sellerId: product.sellerId || cartItem.sellerId || null, // ID продавца
          sellerName: product.sellerName || cartItem.sellerName || null
        });
      }
    }
    
    // Если есть проблемные товары, показываем предупреждение
    if (blockedItems.length > 0 || deletedItems.length > 0 || outOfStockItems.length > 0) {
      let warningText = '';
      
      if (blockedItems.length > 0) {
        warningText += '<div style="color:#dc3545; margin:10px 0;"><strong>❌ Заблокированные товары (недоступны):</strong><br>' + blockedItems.join('<br>') + '</div>';
      }
      
      if (deletedItems.length > 0) {
        warningText += '<div style="color:#dc3545; margin:10px 0;"><strong>🗑️ Удалённые товары:</strong><br>' + deletedItems.join('<br>') + '</div>';
      }

      if (outOfStockItems.length > 0) {
        warningText += '<div style="color:#dc3545; margin:10px 0;"><strong>📦 Недостаточно остатка:</strong><br>' + outOfStockItems.join('<br>') + '</div>';
      }
      
      if (validCart.length === 0) {
        // Все товары проблемные
        Swal.fire({
          icon: 'error',
          title: 'Невозможно оформить заказ',
          html: warningText + '<br><strong>Все товары в корзине недоступны. Корзина будет очищена.</strong>',
          confirmButtonText: 'Понятно'
        });
        
        // Очищаем корзину
        cart.length = 0;
        updateCart();
        localStorage.removeItem('cart');
        
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.style.cursor = 'pointer';
        submitBtn.textContent = originalText;
        return;
      }
      
      // Есть валидные товары, предлагаем продолжить без проблемных
      const result = await Swal.fire({
        icon: 'warning',
        title: 'Внимание!',
        html: warningText + '<br><strong style="color:#28a745;">✓ Доступные товары (' + validCart.length + ' шт) можно заказать.</strong><br><br>Продолжить оформление заказа только с доступными товарами?',
        showCancelButton: true,
        confirmButtonText: 'Да, продолжить',
        cancelButtonText: 'Отмена',
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d'
      });
      
      if (!result.isConfirmed) {
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.style.cursor = 'pointer';
        submitBtn.textContent = originalText;
        return;
      }
      
      // Обновляем корзину - удаляем проблемные товары
      cart.length = 0;
      cart.push(...validCart);
      updateCart();
    }
    
    submitBtn.textContent = 'Отправка...';
    
    const items = cart.map(i => {
      const product = products.find(p => p.id === i.id);
      const unitLabel = (product && product.isPack) ? 'пачка' : 'шт';
      const packInfo = (product && product.isPack && product.packQty) ? ` (~${product.packQty} шт/пачка)` : '';
      const variantInfo = i.variant ? ` [${i.variant}]` : '';
      return `${i.title}${variantInfo}${packInfo} — ${i.qty} ${unitLabel} × ${i.price} сом = ${i.qty * i.price} сом`;
    }).join('\n');
    const total = cart.reduce((sum, item) => sum + item.qty * item.price, 0);
    const currentTime = new Date().toLocaleString();

    // Получаем партнера из URL (если есть) или из поля формы
    let partner = getCurrentPartner();
    if (!partner && referredBy) {
      partner = referredBy; // Если клиент сам указал партнера
    }
    
    // Проверяем, есть ли этот клиент в базе привязок к агентам
    if (!partner && phone) {
      try {
        const clientAgentDoc = await db.collection('clientAgents').doc(phone).get();
        if (clientAgentDoc.exists) {
          const clientAgentData = clientAgentDoc.data();
          partner = clientAgentData.agentName;
          console.log('📌 Клиент привязан к агенту:', partner);
        }
      } catch(e) {
        console.log('Не удалось проверить привязку клиента к агенту:', e);
      }
    }

    // Сохраняем партнера если клиент указал
    if (referredBy) {
      try {
        localStorage.setItem('savedReferredBy', referredBy);
      } catch(e) {}
    }

    // Списание остатков + сохранение заказа (БЕЗ чтений, чтобы не ловить 429 batchGet)
    // Важно: без чтений Firestore мы не можем гарантировать 100% защиту от "ухода в минус"
    // при одновременных заказах. Для идеальной защиты нужен сервер (Cloud Function) или правила.
    submitBtn.textContent = 'Отправка в базу...';

    const orderRef = db.collection('orders').doc();
    const batch = db.batch();

    for (const item of cart) {
      const localProduct = products.find(p => p.id === item.id);
      const hasLocalStock = localProduct && typeof localProduct.stock === 'number' && isFinite(localProduct.stock);
      if (!hasLocalStock) continue;

      const need = Math.max(0, Math.floor(item.qty || 0));
      if (need <= 0) {
        throw new Error(`Некорректное количество: ${item.title}`);
      }

      // Предварительная проверка по локальному кэшу
      const localStock = Math.max(0, Math.floor(localProduct.stock));
      if (localStock < need) {
        throw new Error(`Недостаточно остатка для товара: ${localProduct.title || item.title}. Доступно ${localStock} шт`);
      }

      const productRef = db.collection('products').doc(item.id);
      batch.update(productRef, { stock: firebase.firestore.FieldValue.increment(-need) });
    }

    batch.set(orderRef, {
      name,
      phone,
      address,
      driverName: driverName || null,
      driverPhone: driverPhone || null,
      items: cart.map(item => ({
        id: item.id,
        title: item.title,
        qty: item.qty,
        price: item.price,
        costPrice: item.costPrice || 0,
        sellerId: item.sellerId || null, // ID продавца для уведомлений
        sellerName: item.sellerName || null,
        variant: item.variant || null // Выбранный вариант (цвет, размер и т.д.)
      })),
      total,
      timestamp: Date.now(),
      time: currentTime,
      status: 'Новый',
      partner: partner || null,
      referredBy: referredBy || null
    });

    await batch.commit();

    const driverInfo = (driverName || driverPhone) ? `\nВодитель: ${driverName || '-'}\nТел. водителя: ${driverPhone || '-'}` : '';
    const msg = `Новый заказ:\nИмя: ${name}\nТелефон: ${phone}\nАдрес: ${address}${driverInfo}\nТовары:\n${items}\n\nИтого: ${total} сом`;

    // СРАЗУ показываем успех клиенту
    Swal.fire('Успех!', 'Ваш заказ принят и отправляется!', 'success');
    
    // Автоматическая регистрация/вход после первого заказа
    if (typeof autoRegisterAfterOrder === 'function') {
      autoRegisterAfterOrder(name, phone, address);
    }
    
    // Обновляем статистику клиента если он авторизован
    if (typeof updateCustomerStats === 'function') {
      updateCustomerStats(total);
    }
    
    // Сохраняем заказ в историю
    saveOrderToHistory({
      name,
      phone,
      address,
      driverName: driverName || null,
      driverPhone: driverPhone || null,
      items: [...cart],
      total,
      timestamp: Date.now(),
      time: currentTime,
      status: 'Новый'
    });
    
    // Разблокируем кнопку после показа успеха
    submitBtn.disabled = false;
    submitBtn.style.opacity = '1';
    submitBtn.style.cursor = 'pointer';
    submitBtn.textContent = originalText;
    
    // Копируем данные для фоновой отправки
    const orderData = {
      name: name,
      phone: phone,
      address: address,
      driverName: driverName,
      driverPhone: driverPhone,
      cart: [...cart],
      total: total,
      currentTime: currentTime
    };
    
    // Очищаем корзину сразу
    cart.length = 0;
    updateCart();
    localStorage.removeItem('cart');

    // НЕ делаем loadProducts() здесь, чтобы не ловить 429.
    // Обновляем остатки локально и перерисовываем UI.
    try {
      for (const orderedItem of orderData.cart) {
        const p = products.find(x => x.id === orderedItem.id);
        if (!p) continue;
        if (typeof p.stock === 'number' && isFinite(p.stock)) {
          const nextStock = Math.max(0, Math.floor(p.stock) - Math.max(0, Math.floor(orderedItem.qty || 0)));
          p.stock = nextStock;
        }
      }
      renderProducts();
      updateCart();
    } catch (e) {}
    
    // Сохраняем данные пользователя (включая водителя)
    localStorage.setItem('userData', JSON.stringify({
      name,
      phone,
      address,
      driverName,
      driverPhone
    }));

    // НЕ очищаем основные поля клиента - оставляем для повторных заказов
    // document.getElementById('name').value = '';
    // document.getElementById('phone').value = '';
    // document.getElementById('address').value = '';
    
    // НЕ очищаем поля водителя - теперь они тоже сохраняются
    // document.getElementById('driverName').value = '';
    // document.getElementById('driverPhone').value = '';
    
    // Отправка файлов в фоновом режиме (без await)
    // 1. Excel файл
    sendOrderAsExcelFile(orderData.name, orderData.phone, orderData.address, orderData.driverName, orderData.driverPhone, orderData.cart, orderData.total, orderData.currentTime)
      .then(() => console.log('Excel файл отправлен успешно'))
      .catch(err => console.error('Ошибка отправки Excel:', err));
    
    // 2. PDF для печати (без фото)
    sendOrderAsExcel(orderData.name, orderData.phone, orderData.address, orderData.driverName, orderData.driverPhone, orderData.cart, orderData.total, orderData.currentTime)
      .then(() => console.log('PDF для печати отправлен успешно'))
      .catch(err => console.error('Ошибка отправки PDF для печати:', err));
    
    // 3. PDF с фото
    sendOrderAsPDF(orderData.name, orderData.phone, orderData.address, orderData.driverName, orderData.driverPhone, orderData.cart, orderData.total, orderData.currentTime)
      .then(() => console.log('PDF с фото отправлен успешно'))
      .catch(err => console.error('Ошибка отправки PDF с фото:', err));
    
    // Отправляем РАЗДЕЛЬНОЕ уведомление админу с группировкой по продавцам
    // sendSeparatedOrderToAdmin(orderData.name, orderData.phone, orderData.address, orderData.driverName, orderData.driverPhone, orderData.cart, orderData.total, orderData.currentTime)
    //   .then(() => console.log('Раздельное уведомление отправлено'))
    //   .catch(err => console.error('Ошибка отправки раздельного уведомления:', err));

  } catch (error) {
    console.error('Error submitting order:', error);
    Swal.fire('Ошибка', error && error.message ? error.message : 'Не удалось отправить заказ. Попробуйте позже.', 'error');

    // Если уперлись в лимит/429 — ставим кулдаун, чтобы не спамить Firestore
    try {
      const msg = (error && error.message) ? String(error.message) : '';
      const code = (error && error.code) ? String(error.code) : '';
      const isQuota = code.includes('resource-exhausted') || msg.toLowerCase().includes('quota') || msg.includes('429') || msg.toLowerCase().includes('too many requests');
      if (isQuota) {
        const ms = 45 * 1000;
        localStorage.setItem('firestoreCooldownUntil', String(Date.now() + ms));
      }
    } catch (e) {}
    // Не делаем loadProducts() при ошибке, чтобы не усугублять 429.
    // UI и корзина остаются как есть; пользователь может повторить позже.
    
    // Разблокируем кнопку при ошибке
    submitBtn.disabled = false;
    submitBtn.style.opacity = '1';
    submitBtn.style.cursor = 'pointer';
    submitBtn.textContent = originalText;
  }
};


    
    
// На iPhone/медленных устройствах полный renderProducts на каждый символ сильно тормозит ввод.
// Поэтому делаем debounce с увеличенной задержкой для iOS.
let _renderProductsInputTimer = null;
let _isComposing = false; // Флаг для iOS автокоррекции
const _isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
const _debounceDelay = _isIOS ? 400 : 150; // Больше задержка для iOS

// УЛЬТРА-ОПТИМИЗАЦИЯ для iOS - максимально быстрый ввод
if (_isIOS) {
  document.addEventListener('DOMContentLoaded', function() {
    // Добавляем мета-тег для отключения зума на input
    const metaViewport = document.querySelector('meta[name="viewport"]');
    if (metaViewport) {
      metaViewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover');
    }
    
    // Стили для ультра-быстрого режима
    const style = document.createElement('style');
    style.id = 'ios-ultra-fast-styles';
    style.textContent = `
      /* ПОЛНОЕ ОТКЛЮЧЕНИЕ ВСЕХ ЭФФЕКТОВ на iOS */
      #addProductWindow *,
      .admin-product-input {
        transition: none !important;
        animation: none !important;
        -webkit-transition: none !important;
        -webkit-animation: none !important;
        box-shadow: none !important;
        text-shadow: none !important;
        filter: none !important;
        -webkit-filter: none !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
      }
      
      /* Простые стили для input без эффектов */
      #addProductWindow input,
      #addProductWindow textarea,
      #addProductWindow select {
        border: 1px solid #ddd !important;
        background: #fff !important;
        -webkit-appearance: none !important;
        border-radius: 6px !important;
      }
      
      #addProductWindow input:focus,
      #addProductWindow textarea:focus,
      #addProductWindow select:focus {
        border-color: #007bff !important;
        outline: none !important;
        background: #fff !important;
      }
      
      /* Отключаем прокрутку с инерцией - она тоже тормозит */
      #addProductWindow > div {
        -webkit-overflow-scrolling: auto !important;
        overflow-scrolling: auto !important;
      }
    `;
    document.head.appendChild(style);
    
    // При открытии формы - сразу отключаем все автофункции iOS
    const addProductWindow = document.getElementById('addProductWindow');
    if (addProductWindow) {
      // Один раз при загрузке отключаем автокоррекцию для всех полей
      const allInputs = addProductWindow.querySelectorAll('input, textarea, select');
      allInputs.forEach(function(input) {
        input.setAttribute('autocomplete', 'off');
        input.setAttribute('autocorrect', 'off');
        input.setAttribute('autocapitalize', 'off');
        input.setAttribute('spellcheck', 'false');
        input.setAttribute('data-gramm', 'false');
        input.setAttribute('data-gramm_editor', 'false');
      });
    }
  });
}

function scheduleRenderProducts() {
  if (_isComposing) return; // Не рендерим во время автокоррекции
  clearTimeout(_renderProductsInputTimer);
  _renderProductsInputTimer = setTimeout(() => {
    renderProducts();
  }, _debounceDelay);
}

// Обработка composition events для iOS
search.addEventListener('compositionstart', () => { _isComposing = true; });
search.addEventListener('compositionend', () => { _isComposing = false; scheduleRenderProducts(); });

search.oninput = scheduleRenderProducts;
sort.onchange = renderProducts;

// === ОПТИМИЗАЦИЯ: Debounced renderProducts ===
function renderProductsDebounced() {
  if (_renderProductsTimer) {
    clearTimeout(_renderProductsTimer);
  }
  _renderProductsPending = true;
  _renderProductsTimer = setTimeout(() => {
    _renderProductsPending = false;
    _renderProductsTimer = null;
    renderProductsCore();
  }, 100); // Ждём 100мс перед рендером
}

// Оригинальная функция
function renderProducts() {
  // Если уже запланирован рендер, не делаем сразу
  if (_renderProductsPending) return;
  renderProductsDebounced();
}

// Функция для получения переводов и синонимов поискового запроса
function getSearchTranslations(query) {
  const translations = [];
  
  // Приводим запрос к нижнему регистру для поиска в словаре
  const lowerQuery = query.toLowerCase();
  
  // Словарь популярных переводов (русский ↔ английский)
  const dictionary = {
    // Упаковка и расходники
    'стрейч': ['stretch', 'стреч', 'пленка', 'film'],
    'стреч': ['stretch', 'стрейч', 'пленка', 'film'],
    'stretch': ['стрейч', 'стреч', 'пленка'],
    'пленка': ['film', 'wrap', 'стрейч', 'стреч', 'плёнка'],
    'плёнка': ['film', 'wrap', 'пленка', 'стрейч'],
    'фольга': ['foil', 'tin', 'алюминиевая'],
    'foil': ['фольга', 'алюминиевая'],
    'скотч': ['tape', 'лента', 'adhesive'],
    'tape': ['скотч', 'лента'],
    'пакет': ['bag', 'package'],
    'bag': ['пакет', 'мешок'],
    
    // Инструменты
    'нож': ['knife', 'резак'],
    'knife': ['нож', 'резак'],
    'ножницы': ['scissors', 'ножнички'],
    'scissors': ['ножницы'],
    'молоток': ['hammer'],
    'hammer': ['молоток'],
    'отвертка': ['screwdriver'],
    'screwdriver': ['отвертка', 'отвёртка'],
    
    // Кухонные принадлежности
    'терка': ['grater', 'тёрка'],
    'тёрка': ['grater', 'терка'],
    'grater': ['терка', 'тёрка'],
    'открывалка': ['opener'],
    'opener': ['открывалка'],
    'чесалка': ['peeler'],
    'peeler': ['чесалка', 'овощечистка'],
    
    // Уборка
    'губка': ['sponge', 'мочалка'],
    'sponge': ['губка', 'мочалка'],
    'тряпка': ['cloth', 'салфетка'],
    'cloth': ['тряпка', 'салфетка'],
    'метла': ['broom', 'веник'],
    'broom': ['метла', 'веник'],
    'щетка': ['brush', 'щётка'],
    'brush': ['щетка', 'щётка'],
    
    // Насекомые
    'мухобойка': ['swatter', 'fly', 'мухабой'],
    'мухабой': ['мухобойка', 'swatter'],
    'swatter': ['мухобойка', 'мухабой'],
    'липучка': ['от мух', 'ловушка'],
    
    // Посуда
    'тарелка': ['plate', 'dish'],
    'plate': ['тарелка', 'блюдо'],
    'стакан': ['glass', 'cup'],
    'glass': ['стакан', 'стеклянный'],
    'ложка': ['spoon'],
    'spoon': ['ложка'],
    'вилка': ['fork'],
    'fork': ['вилка'],
    
    // Цвета
    'красный': ['red'],
    'red': ['красный'],
    'синий': ['blue'],
    'blue': ['синий', 'голубой'],
    'зеленый': ['green'],
    'green': ['зеленый', 'зелёный'],
    'желтый': ['yellow'],
    'yellow': ['желтый', 'жёлтый'],
    'черный': ['black'],
    'black': ['черный', 'чёрный'],
    'белый': ['white'],
    'white': ['белый'],
    'серый': ['gray', 'grey'],
    'gray': ['серый'],
    'grey': ['серый']
  };
  
  // Ищем переводы для каждого слова в запросе
  const words = lowerQuery.split(/\s+/);
  for (let word of words) {
    if (dictionary[word]) {
      translations.push(...dictionary[word]);
    }
  }
  
  // Также проверяем весь запрос целиком
  if (dictionary[lowerQuery]) {
    translations.push(...dictionary[lowerQuery]);
  }
  
  return [...new Set(translations)]; // Удаляем дубликаты
}

renderProducts();

function showPreview(src) {
  document.getElementById('previewImg').src = src;
  document.getElementById('previewBlock').style.display = 'block';
  lockPageScroll();
}



// Глобальный наблюдатель для изображений (чтобы не создавать новые каждый раз)
let globalImageObserver = null;

// Функция отображения товаров (ядро)
function renderProductsCore() {
  // Сохраняем список открытых деталей товаров перед перерисовкой
  const openDetails = [];
  document.querySelectorAll('[id^="product-details-"]').forEach(detail => {
    if (detail.style.display !== 'none') {
      openDetails.push(detail.id);
    }
  });
  
  // Рендер карточек в стиле AliExpress
  const container = document.getElementById('productTable');
  
  // ВАЖНО: Очищаем старые обработчики событий перед очисткой контейнера
  if (globalImageObserver) {
    globalImageObserver.disconnect();
  }
  
  // Очищаем контейнер
  container.innerHTML = '';
  
  // ОПТИМИЗАЦИЯ: Используем DocumentFragment для пакетного добавления
  const fragment = document.createDocumentFragment();
  
  let filtered = isEditorMode ? products : products.filter(p => !p.blocked);
  
  // Продавец видит только свои товары
  if (userRole === 'seller' && currentSeller) {
    filtered = filtered.filter(p => p.sellerId === currentSeller.id);
  }
  
  // Корейский менеджер видит только корейские товары, часы и электронику
  if (userRole === 'korean') {
    filtered = filtered.filter(p => p.category && (p.category.toLowerCase() === 'корейские' || p.category.toLowerCase() === 'часы' || p.category.toLowerCase() === 'электроника'));
  }
  
  // Менеджер бытовых техник видит только бытовые техники
  if (userRole === 'appliances') {
    filtered = filtered.filter(p => p.category && p.category.toLowerCase() === 'бытовые');
  }
  
  // Фильтрация по категории (работает одинаково для всех)
  if (currentCategory === 'все') {
    // В разделе "Все товары" показываем товары с категорией "все" или без категории
    filtered = filtered.filter(p => !p.category || p.category.toLowerCase() === 'все');
  } else {
    // В других разделах показываем товары только выбранной категории
    filtered = filtered.filter(p => p.category && p.category.toLowerCase() === currentCategory.toLowerCase());
  }
  
  // Поиск по тексту с автоматическим переводом
  const q = (search && search.value) ? search.value.toLowerCase().trim() : '';
  let list = q ? filtered.filter(p => {
    const title = (p.title || '').toLowerCase();
    const desc = (p.description || '').toLowerCase();
    const searchText = title + ' ' + desc;
    
    // Прямое совпадение
    if (searchText.includes(q)) return true;
    
    // Автоматический перевод через словарь синонимов
    const translations = getSearchTranslations(q);
    for (let translation of translations) {
      if (searchText.includes(translation)) return true;
    }
    
    return false;
  }) : filtered;
  
  // Фильтр по цене
  const priceMinEl = document.getElementById('priceMin');
  const priceMaxEl = document.getElementById('priceMax');
  const priceMin = priceMinEl ? parseFloat(priceMinEl.value) : NaN;
  const priceMax = priceMaxEl ? parseFloat(priceMaxEl.value) : NaN;
  
  if (!isNaN(priceMin)) {
    list = list.filter(p => (p.price || 0) >= priceMin);
  }
  if (!isNaN(priceMax)) {
    list = list.filter(p => (p.price || 0) <= priceMax);
  }
  
  // Фильтр по наличию
  const stockFilterEl = document.getElementById('stockFilter');
  const stockFilter = stockFilterEl ? stockFilterEl.value : 'all';
  
  if (stockFilter === 'instock') {
    list = list.filter(p => {
      const stock = typeof p.stock === 'number' ? p.stock : null;
      return stock === null || stock > 0;
    });
  } else if (stockFilter === 'outofstock') {
    list = list.filter(p => {
      const stock = typeof p.stock === 'number' ? p.stock : null;
      return stock !== null && stock <= 0;
    });
  }
  
  // Сортировка
  const sortEl = document.getElementById('sort');
  const sortVal = sortEl ? sortEl.value : '';
  
  if (sortVal === 'asc') {
    list.sort((a, b) => (a.price || 0) - (b.price || 0));
  } else if (sortVal === 'desc') {
    list.sort((a, b) => (b.price || 0) - (a.price || 0));
  } else if (sortVal === 'name_asc') {
    list.sort((a, b) => (a.title || '').localeCompare(b.title || '', 'ru'));
  } else if (sortVal === 'name_desc') {
    list.sort((a, b) => (b.title || '').localeCompare(a.title || '', 'ru'));
  } else if (sortVal === 'new') {
    list.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
  }
  
  // Сохраняем количество результатов для информационного блока
  lastSearchResults = list.length;

  list.forEach((p, idx) => {
    const card = document.createElement('div');
    card.className = 'product-card';
    card.setAttribute('data-product-id', p.id);

    const hasStock = typeof p.stock === 'number' && isFinite(p.stock);
    const stock = hasStock ? Math.max(0, Math.floor(p.stock)) : null;
    const outOfStock = stock !== null && stock <= 0;
    // Для товаров-пачек показываем "пачка" вместо "шт"
    const unitLabel = p.isPack ? 'пачка' : 'шт';
    // Улучшенная информация о пачке и коробке
    let packInfoHtml = '';
    if (p.showPackInfo && p.packQty) {
      packInfoHtml = `
        <div style="background:#f3e5f5;border-radius:6px;padding:6px 8px;margin:4px 0;font-size:11px;">
          <div style="color:#7b1fa2;font-weight:700;">📦 1 пачка = ${p.packQty} шт</div>
        </div>
      `;
    }
    const stockHtml = stock !== null
      ? `<div class="card-stock ${outOfStock ? 'out' : ''}">Остаток: ${outOfStock ? 'Нет' : stock} ${unitLabel}</div>`
      : '';
    const blockedBadgeHtml = (p.blocked || outOfStock) ? `<div class="blocked-badge">🚫</div>` : '';
    // Добавляем значок пачки
    const packBadgeHtml = p.isPack ? `<div class="pack-badge">ПАЧКА</div>` : '';
    // Добавляем значок галереи если есть дополнительные фото
    const hasExtraImages = p.extraImages && Array.isArray(p.extraImages) && p.extraImages.length > 0;
    const galleryBadgeHtml = hasExtraImages ? `<div class="product-gallery-badge" onclick="event.stopPropagation(); showProductGallery('${p.id}')">📷 +${p.extraImages.length}</div>` : '';
    // Добавляем кнопку избранного (сердечко) - только для обычных пользователей
    const heartIcon = isFavorite(p.id) 
      ? '<svg viewBox="0 0 24 24" width="24" height="24" fill="#e91e63" stroke="none"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>'
      : '<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#333" stroke-width="2"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>';
    const favoriteHtml = !isAdmin ? `<button class="favorite-btn ${isFavorite(p.id) ? 'active' : ''}" data-product-id="${p.id}" onclick="event.stopPropagation(); toggleFavorite('${p.id}', this)">${heartIcon}</button>` : '';
    const buyDisabledAttr = outOfStock ? 'disabled' : '';
    const qtyDisabledAttr = outOfStock ? 'disabled' : '';
    const buyLabel = outOfStock ? 'Нет в наличии' : 'Купить';

    card.innerHTML = `
        <div class="card-image" style="position:relative;">
        ${blockedBadgeHtml}
        ${packBadgeHtml}
        ${galleryBadgeHtml}
        ${favoriteHtml}
        ${p.createdAt && (Date.now() - p.createdAt) < 4 * 24 * 60 * 60 * 1000 ? `<div class="new-badge">NEW</div>` : ''}
        ${isEditorMode ? `<div style="position:absolute;top:5px;left:5px;background:rgba(0,123,255,0.9);color:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:bold;z-index:1;">#${idx + 1}</div>` : ''}
        <img loading="lazy" src="${p.image || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23ddd" width="200" height="200"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="18"%3EНет фото%3C/text%3E%3C/svg%3E'}" alt="${p.title || ''}" onclick="openProductImage('${p.id}')" style="cursor:pointer;" onload="this.classList.add('loaded')" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22%3E%3Crect fill=%22%23ddd%22 width=%22200%22 height=%22200%22/%3E%3Ctext fill=%22%23999%22 x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2218%22%3EНет фото%3C/text%3E%3C/svg%3E';this.classList.add('loaded')" />
      </div>
      <div class="card-body"
        ${isEditorMode ? `
          <!-- Компактная карточка для режима редактора -->
          <div style="font-weight:600; color:#333; font-size:14px; margin-bottom:6px;">${p.title||'Товар'}</div>
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px; flex-wrap:wrap;">
            <span style="font-size:16px; font-weight:700; color:#e53935;">${p.price||0} сом</span>
          </div>
          <div style="font-size:12px; color:#666; margin-bottom:8px;">
            ${stock !== null ? `📦 Остаток: ${stock}` : '📦 Без лимита'} ${p.isPack ? '| 📦 Пачка' : ''}
          </div>
          <button onclick="openEditProductModal('${p.id}')" style="width:100%; background:linear-gradient(135deg,#007bff,#0056b3); color:white; border:none; padding:12px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">✏️ Редактировать</button>
        ` : `
          <div class="card-title"><div>${p.title||''}</div></div>
          ${packInfoHtml}
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <div class="card-price">${(p.price || '0')} сом${p.isPack ? ' / пачка' : ''}</div>
            ${p.oldPrice ? `<div class="card-oldprice">${p.oldPrice} сом</div>` : ''}
          </div>
          ${p.showPricePerUnit && p.isPack && p.packQty ? `<div style="font-size:12px;color:#7b1fa2;background:#f3e5f5;padding:4px 8px;border-radius:4px;margin-top:3px;">💰 1 шт = <span style="font-weight:700;color:#e53935;">${((p.price || 0) / (p.packQty || 1)).toFixed(2)}</span> сом${p.optPrice ? ` | Опт: <span style="font-weight:700;color:#007bff;">${((p.optPrice || 0) / (p.packQty || 1)).toFixed(2)}</span> сом/шт` : ''}</div>` : ''}
          <div class="card-opt-info" data-opt-id="${p.id}" style="font-size:12px;color:#007bff;margin-top:2px;">
            ${p.optPrice && p.optQty ? `Опт: ${p.optPrice} сом/${p.isPack ? 'пачка' : 'шт'} при ${p.optQty} ${p.isPack ? 'пачек' : 'шт'}` : ''}
          </div>
          ${stockHtml}
          ${(p.category === 'корейские' || p.category === 'часы' || p.category === 'электроника') && p.description ? `
            <div style="display:flex; flex-direction:column; margin-top:6px;">
              <button onclick="showProductDetailModal('${p.id}')" style="width:100%; padding:8px; background:linear-gradient(135deg, #ff9800, #f57c00); color:white; border:none; border-radius:6px 6px 0 0; cursor:pointer; font-size:13px; font-weight:500; margin:0;">📝 Описание товара</button>
              ${(boxPurchaseMode || (p.isPack && p.useQtyButtons)) ? `
                <div class="pack-controls" style="background:#f8f9fa; padding:12px; border-radius:0 0 6px 6px;">
                  <button class="pack-btn" onclick="decrementPack('${p.id}')" ${outOfStock ? 'disabled' : ''}>−</button>
                  <div class="pack-qty-display" id="pack-qty-${p.id}" style="width:90px;text-align:center;font-size:18px;font-weight:700;border:2px solid #4caf50;border-radius:8px;padding:10px 5px;background:#e8f5e9;display:inline-block;min-height:24px;color:#2e7d32;">0 шт</div>
                  <button class="pack-btn" onclick="incrementPack('${p.id}', this)" ${outOfStock ? 'disabled' : ''}>+</button>
                </div>
                <div class="box-mode-hint" style="font-size:11px;color:#2e7d32;background:#e8f5e9;padding:6px;border-radius:4px;text-align:center;margin-top:4px;font-weight:600;">📦 +1 нажатие = ${p.unitsPerBox || 72} шт (коробка)</div>
              ` : (p.useQtyButtons && !p.isPack ? `
                <div class="pack-controls" style="background:#f8f9fa; padding:12px; border-radius:0 0 6px 6px;">
                  <button class="pack-btn" onclick="decrementQty('${p.id}')" ${outOfStock ? 'disabled' : ''}>−</button>
                  <div contenteditable="true" class="pack-qty-display" id="qty-display-${p.id}" style="width:70px;text-align:center;font-size:18px;font-weight:700;border:2px solid #90caf9;border-radius:8px;padding:10px 5px;background:#fff;display:inline-block;min-height:24px;" ${outOfStock ? 'contenteditable="false"' : ''}>0</div>
                  <button class="pack-btn" onclick="incrementQty('${p.id}', this)" ${outOfStock ? 'disabled' : ''}>+</button>
                </div>
                <button onclick="applyQtyInput('${p.id}')" style="width:100%;margin-top:4px;padding:8px;background:#1565c0;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;">✔ Применить</button>
                ${p.minQty > 1 ? `<div style="font-size:10px;color:#1565c0;background:#e3f2fd;padding:4px 6px;border-radius:0 0 6px 6px;text-align:center;">💡 Каждое нажатие + добавляет ${p.minQty} шт</div>` : ''}
              ` : `
                <div style="display:flex; gap:0; margin:0; padding:0;">
                  <input type="text" inputmode="numeric" value="${p.minQty||1}" class="card-qty-input" data-product-id="${p.id}" style="text-align:center; font-size:16px; border-radius:0 0 0 6px; margin:0; flex:1;" oninput="updateCardPrice(this, '${p.id}'); this.dataset.lastValue=this.value;" onfocus="this.dataset.lastValue=this.value; this.select();" placeholder="${p.isPack ? 'пачек' : 'шт'}" ${qtyDisabledAttr} />
                  <button onclick="addToCartById('${p.id}', this)" style="background:linear-gradient(90deg,#ff7a00,#ff3b00); color:white; border:none; padding:8px 12px; border-radius:0 0 6px 0; cursor:pointer; margin:0; flex:1;" ${buyDisabledAttr}>${buyLabel}</button>
                </div>
              `)}
            </div>
          ` : `
          ${(boxPurchaseMode || (p.isPack && p.useQtyButtons)) ? `
            <div class="pack-controls" style="margin-top:6px;">
              <button class="pack-btn" onclick="decrementPack('${p.id}')" ${outOfStock ? 'disabled' : ''}>−</button>
              <div class="pack-qty-display" id="pack-qty-${p.id}" style="width:90px;text-align:center;font-size:18px;font-weight:700;border:2px solid #4caf50;border-radius:8px;padding:10px 5px;background:#e8f5e9;display:inline-block;min-height:24px;color:#2e7d32;">0 шт</div>
              <button class="pack-btn" onclick="incrementPack('${p.id}', this)" ${outOfStock ? 'disabled' : ''}>+</button>
            </div>
            <div class="box-mode-hint" style="font-size:11px;color:#2e7d32;background:#e8f5e9;padding:6px;border-radius:4px;text-align:center;margin-top:4px;font-weight:600;">📦 +1 нажатие = ${p.unitsPerBox || 72} шт (коробка)</div></div>
          ` : (p.useQtyButtons && !p.isPack ? `
            <div class="pack-controls" style="margin-top:6px;">
              <button class="pack-btn" onclick="decrementQty('${p.id}')" ${outOfStock ? 'disabled' : ''}>−</button>
              <div contenteditable="true" class="pack-qty-display" id="qty-display-${p.id}" style="width:70px;text-align:center;font-size:18px;font-weight:700;border:2px solid #90caf9;border-radius:8px;padding:10px 5px;background:#fff;display:inline-block;min-height:24px;" ${outOfStock ? 'contenteditable="false"' : ''}>0</div>
              <button class="pack-btn" onclick="incrementQty('${p.id}', this)" ${outOfStock ? 'disabled' : ''}>+</button>
            </div>
            <button onclick="applyQtyInput('${p.id}')" style="width:100%;margin-top:4px;padding:8px;background:#1565c0;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;">✔ Применить</button>
            ${p.minQty > 1 ? `<div style="font-size:10px;color:#1565c0;background:#e3f2fd;padding:4px 6px;border-radius:4px;text-align:center;margin-top:4px;">💡 Каждое нажатие + добавляет ${p.minQty} шт</div>` : ''}
          ` : `
            <div class="card-actions" style="margin-top:6px;">
              <input type="text" inputmode="numeric" value="${p.minQty||1}" class="card-qty-input" data-product-id="${p.id}" style="text-align:center; font-size:16px;" oninput="updateCardPrice(this, '${p.id}'); this.dataset.lastValue=this.value;" onfocus="this.dataset.lastValue=this.value; this.select();" placeholder="${p.isPack ? 'пачек' : 'шт'}" ${qtyDisabledAttr} />
              <button onclick="addToCartById('${p.id}', this)" ${buyDisabledAttr}>${buyLabel}</button>
            </div>
          `)}
          `}
        `}
      </div>
    `;

    fragment.appendChild(card);
    // Непосредственно обновляем цену на карточке в зависимости от текущего значения поля количества
    try {
      const qtyInput = card.querySelector('.card-qty-input');
      if (qtyInput) updateCardPriceNow(qtyInput, p.id);
    } catch (e) {
      console.error('updateCardPrice init error', e);
    }
  });

  // ОПТИМИЗАЦИЯ: Одно обновление DOM вместо множества
  // (контейнер уже очищен в начале функции)
  container.appendChild(fragment);
  
  // Улучшенная ленивая загрузка изображений
  // ВАЖНО: Используем ОДИН глобальный наблюдатель вместо создания нового каждый раз
  if ('IntersectionObserver' in window) {
    // Создаем наблюдатель только если его еще нет
    if (!globalImageObserver) {
      globalImageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            if (!img.classList.contains('loaded')) {
              // Изображение уже загружается браузером благодаря loading="lazy"
              // Просто добавляем класс для плавного появления
              if (img.complete) {
                img.classList.add('loaded');
              }
            }
            observer.unobserve(img);
          }
        });
      }, {
        rootMargin: '50px' // Начинаем загрузку за 50px до появления в зоне видимости
      });
    }
    
    // Наблюдаем за всеми изображениями товаров
    container.querySelectorAll('.card-image img').forEach(img => {
      globalImageObserver.observe(img);
    });
  }

  // Восстанавливаем открытые детали после перерисовки
  openDetails.forEach(detailId => {
    const detail = document.getElementById(detailId);
    if (detail) {
      detail.style.display = 'block';
      // Обновляем текст кнопки
      const productId = detailId.replace('product-details-', '');
      const card = document.querySelector(`[data-product-id="${productId}"]`);
      if (card) {
        const btn = card.querySelector('button[onclick^="toggleProductDetails"]');
        if (btn) btn.textContent = '▲ Скрыть';
      }
    }
  });

  // Инициализируем отображение количества для товаров-пачек и с кнопками +/-
  products.forEach(p => {
    if (p.isPack) {
      updatePackDisplay(p.id);
    }
    if (p.useQtyButtons) {
      updateQtyDisplay(p.id);
    }
  });
}

// === МОДАЛЬНОЕ ОКНО РЕДАКТИРОВАНИЯ ТОВАРА ===
let currentEditProductId = null;

function openEditProductModal(productId) {
  const p = products.find(pr => pr.id === productId);
  if (!p) return;
  
  currentEditProductId = productId;
  const modal = document.getElementById('editProductModal');
  const content = document.getElementById('editProductContent');
  
  content.innerHTML = `
    <!-- Фото товара -->
    <div style="text-align:center; margin-bottom:15px;">
      <img loading="eager" src="${p.image || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="150" height="150"%3E%3Crect fill="%23ddd" width="150" height="150"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle"%3EНет фото%3C/text%3E%3C/svg%3E'}" style="width:120px; height:120px; object-fit:cover; border-radius:10px; border:2px solid #ddd;">
      <div style="margin-top:8px;">
        <button onclick="changeProductImage('${p.id}')" style="background:#007bff; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-size:13px;">📷 Изменить фото</button>
      </div>
    </div>
    
    <!-- Название -->
    <div style="margin-bottom:12px;">
      <label style="font-size:12px; color:#666; display:block; margin-bottom:4px;">📝 Название</label>
      <input type="text" id="editTitle" value="${p.title||''}" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; box-sizing:border-box;">
    </div>
    
    <!-- Категория -->
    <div style="margin-bottom:12px;">
      <label style="font-size:12px; color:#666; display:block; margin-bottom:4px;">📁 Категория</label>
      <select id="editCategory" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; box-sizing:border-box;">
        ${generateCategoryOptions(p.category)}
      </select>
    </div>
    
    <!-- Описание (для корейских/часов/электроники) -->
    <div style="margin-bottom:12px;">
      <label style="font-size:12px; color:#666; display:block; margin-bottom:4px;">📄 Описание</label>
      <textarea id="editDescription" rows="3" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; box-sizing:border-box; resize:vertical;">${p.description||''}</textarea>
    </div>
    
    <!-- Цены -->
    <div style="display:flex; gap:10px; margin-bottom:12px;">
      <div style="flex:1;">
        <label style="font-size:12px; color:#666; display:block; margin-bottom:4px;">💵 Закупка</label>
        <input type="number" id="editCostPrice" value="${p.costPrice||0}" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; box-sizing:border-box;" step="0.01">
      </div>
      <div style="flex:1;">
        <label style="font-size:12px; color:#666; display:block; margin-bottom:4px;">💰 Продажа</label>
        <input type="number" id="editPrice" value="${p.price||0}" style="width:100%; padding:10px; border:1px solid #e53935; border-radius:8px; font-size:16px; font-weight:700; color:#e53935; box-sizing:border-box;">
      </div>
    </div>
    
    <!-- Остаток -->
    <div style="margin-bottom:12px;">
      <label style="font-size:12px; color:#666; display:block; margin-bottom:4px;">📦 Остаток (пусто = без лимита)</label>
      <input type="number" id="editStock" value="${p.stock === 0 ? 0 : (p.stock || '')}" placeholder="Без лимита" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; box-sizing:border-box;" min="0">
    </div>
    
    <!-- Мин. покупка -->
    <div style="background:#fff3e0; border:1px solid #ffb74d; border-radius:8px; padding:12px; margin-bottom:12px;">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <div>
          <label style="font-size:12px; color:#e65100; display:block; margin-bottom:4px;">🛒 Мин. покупка</label>
          <input type="number" id="editMinQty" value="${p.minQty||1}" min="1" style="width:80px; padding:8px; border:1px solid #ffb74d; border-radius:6px; font-size:14px;">
        </div>
        <label style="display:flex; align-items:center; gap:6px; cursor:pointer; margin-top:15px;">
          <input type="checkbox" id="editUseQtyButtons" ${p.useQtyButtons ? 'checked' : ''} style="width:18px; height:18px;">
          <span style="font-size:13px; color:#1565c0;">🔢 Кнопки +/-</span>
        </label>
        <label style="display:flex; align-items:center; gap:6px; cursor:pointer; margin-top:15px;">
          <input type="checkbox" id="editRoundQty" ${p.roundQty ? 'checked' : ''} style="width:18px; height:18px;">
          <span style="font-size:13px; color:#ff5722;">🔄 Округлять</span>
        </label>
      </div>
    </div>
    
    <!-- Штук в коробке (отдельно) -->
    <div style="background:#e8f5e9; border:2px solid #4caf50; border-radius:8px; padding:12px; margin-bottom:12px;">
      <div style="display:flex; align-items:center; gap:10px;">
        <label style="font-size:13px; color:#2e7d32; font-weight:700;">📦 Штук в коробке:</label>
        <input type="number" id="editUnitsPerBox" value="${p.unitsPerBox||72}" min="1" style="width:100px; padding:10px; border:2px solid #4caf50; border-radius:6px; background:#fff; font-size:16px; font-weight:700; text-align:center;">
      </div>
      <div style="font-size:11px; color:#666; margin-top:6px;">Используется для режима покупки по коробкам</div>
    </div>
    
    <!-- Настройки пачки -->
    <div style="background:#f3e5f5; border:1px solid #ce93d8; border-radius:8px; padding:12px; margin-bottom:12px;">
      <label style="display:flex; align-items:center; gap:8px; cursor:pointer; margin-bottom:10px;">
        <input type="checkbox" id="editIsPack" ${p.isPack ? 'checked' : ''} style="width:18px; height:18px;">
        <span style="font-size:14px; color:#7b1fa2; font-weight:600;">📦 Товар продаётся пачками</span>
      </label>
      <div id="packSettings" style="display:${p.isPack ? 'block' : 'none'};">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <div style="flex:1; min-width:100px;">
            <label style="font-size:11px; color:#7b1fa2;">Штук в пачке</label>
            <input type="number" id="editPackQty" value="${p.packQty||6}" min="1" style="width:100%; padding:8px; border:1px solid #ce93d8; border-radius:6px;">
          </div>
          <div style="flex:1; min-width:100px;">
            <label style="font-size:11px; color:#e65100;">Пачек в коробке</label>
            <input type="number" id="editPacksPerBox" value="${p.packsPerBox||20}" min="1" style="width:100%; padding:8px; border:1px solid #ffb74d; border-radius:6px; background:#fff3e0;">
          </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
          <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
            <input type="checkbox" id="editShowPricePerUnit" ${p.showPricePerUnit ? 'checked' : ''} style="width:16px; height:16px;">
            <span style="font-size:12px; color:#2e7d32;">💰 Цена/шт</span>
          </label>
          <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
            <input type="checkbox" id="editShowPackInfo" ${p.showPackInfo ? 'checked' : ''} style="width:16px; height:16px;">
            <span style="font-size:12px; color:#7b1fa2;">📦 Пачка=шт</span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- Варианты товара -->
    <div style="background:#e3f2fd; border:2px solid #2196f3; border-radius:8px; padding:12px; margin-bottom:12px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <span style="font-weight:600; color:#1565c0;">🎨 Варианты товара</span>
        <span style="font-size:12px; color:#666;">${(p.variants && p.variants.length) || 0} шт</span>
      </div>
      <div id="editVariantListContainer" style="max-height:200px; overflow-y:auto; margin-bottom:10px;">
        ${p.variants && p.variants.length > 0 ? p.variants.map((v, i) => `
          <div style="display:flex; align-items:center; gap:8px; padding:8px; background:#fff; border-radius:6px; margin-bottom:6px; border:1px solid #e0e0e0;">
            <img src="${v.image || p.image || 'data:image/svg+xml,%3Csvg xmlns=\"http://www.w3.org/2000/svg\" width=\"40\" height=\"40\"%3E%3Crect fill=\"%23ddd\" width=\"40\" height=\"40\"/%3E%3C/svg%3E'}" style="width:40px; height:40px; object-fit:cover; border-radius:4px;">
            <div style="flex:1; min-width:0;">
              <div style="font-weight:600; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${v.name || 'Вариант'}</div>
              <div style="font-size:11px; color:#666;">${v.price ? v.price + ' сом' : 'Цена товара'}</div>
            </div>
            <button onclick="removeVariantFromEdit(${i})" style="width:24px; height:24px; border:none; background:#ffebee; color:#c62828; border-radius:50%; cursor:pointer; font-size:12px;">✕</button>
          </div>
        `).join('') : '<div style="color:#888; font-size:12px; text-align:center; padding:8px;">Нет вариантов</div>'}
      </div>
      <div style="display:flex; flex-direction:column; gap:6px;">
        <input type="text" id="editVariantName" placeholder="Название варианта" style="width:100%; padding:8px; border:1px solid #90caf9; border-radius:6px; font-size:13px; box-sizing:border-box;">
        <input type="number" id="editVariantPrice" placeholder="Цена варианта" style="width:100%; padding:8px; border:1px solid #90caf9; border-radius:6px; font-size:13px; box-sizing:border-box;">
        <button type="button" onclick="addVariantToEdit()" style="width:100%; background:#2196f3; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600;">+ Добавить вариант</button>
      </div>
    </div>
    
    <!-- Доп. фото и Опт -->
    <div style="display:flex; gap:10px; margin-bottom:15px;">
      <button onclick="showEditExtraPhotosModal('${p.id}')" style="flex:1; background:#2196f3; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer; font-size:13px;">📷 Доп.фото (${(p.extraImages && p.extraImages.length) || 0})</button>
      <button onclick="showEditWholesaleModal('${p.id}')" style="flex:1; background:#17a2b8; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer; font-size:13px;">💎 Опт</button>
    </div>
    
    <!-- Действия -->
    <div style="display:flex; gap:8px; margin-bottom:15px;">
      <button onclick="showMoveProductModal('${p.id}')" style="flex:1; background:#28a745; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer; font-size:13px;">📍 Место</button>
      <button onclick="toggleProductBlock('${p.id}', ${p.blocked||false}); closeEditProductModal();" style="flex:1; background:${p.blocked?'#ffc107':'#6c757d'}; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer; font-size:13px;">${p.blocked?'Разблок':'Заблок'}</button>
      <button onclick="deleteProduct('${p.id}'); closeEditProductModal();" style="flex:1; background:#dc3545; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer; font-size:13px;">🗑️ Удалить</button>
    </div>
    
    <!-- Кнопка сохранения -->
    <button onclick="saveEditProductModal()" style="width:100%; background:linear-gradient(135deg,#28a745,#218838); color:white; border:none; padding:14px; border-radius:10px; cursor:pointer; font-size:16px; font-weight:700;">💾 Сохранить изменения</button>
  `;
  
  // Инициализируем варианты
  initEditModalVariants(productId);
  
  // Обработчик для показа/скрытия настроек пачки
  setTimeout(() => {
    const isPackCheckbox = document.getElementById('editIsPack');
    if (isPackCheckbox) {
      isPackCheckbox.onchange = function() {
        document.getElementById('packSettings').style.display = this.checked ? 'block' : 'none';
      };
    }
  }, 100);
  
  modal.style.display = 'block';
  lockPageScroll();
}

function closeEditProductModal() {
  document.getElementById('editProductModal').style.display = 'none';
  editModalVariants = []; // Очищаем варианты
  unlockPageScroll();
  currentEditProductId = null;
}

async function saveEditProductModal() {
  if (!currentEditProductId) return;
  
  const p = products.find(pr => pr.id === currentEditProductId);
  if (!p) return;
  
  // Собираем данные
  const title = document.getElementById('editTitle').value.trim();
  const category = document.getElementById('editCategory').value;
  const description = document.getElementById('editDescription').value.trim();
  const costPrice = parseFloat(document.getElementById('editCostPrice').value) || 0;
  const price = parseFloat(document.getElementById('editPrice').value) || 0;
  const stockVal = document.getElementById('editStock').value.trim();
  const stock = stockVal === '' ? null : parseInt(stockVal);
  const minQty = parseInt(document.getElementById('editMinQty').value) || 1;
  const useQtyButtons = document.getElementById('editUseQtyButtons').checked;
  const roundQty = document.getElementById('editRoundQty').checked;
  const isPack = document.getElementById('editIsPack').checked;
  const packQty = parseInt(document.getElementById('editPackQty').value) || 6;
  const packsPerBox = parseInt(document.getElementById('editPacksPerBox').value) || 20;
  const unitsPerBox = parseInt(document.getElementById('editUnitsPerBox').value) || 72;
  const showPricePerUnit = document.getElementById('editShowPricePerUnit').checked;
  const showPackInfo = document.getElementById('editShowPackInfo').checked;
  
  if (!title) {
    Swal.fire('Ошибка', 'Название не может быть пустым', 'error');
    return;
  }
  
  try {
    Swal.fire({ title: 'Сохранение...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
    
    // Обновляем локально
    p.title = title;
    p.category = category;
    p.description = description;
    p.costPrice = costPrice;
    p.price = price;
    if (stock === null) delete p.stock; else p.stock = stock;
    p.minQty = minQty;
    p.useQtyButtons = useQtyButtons;
    p.roundQty = roundQty;
    p.isPack = isPack;
    p.packQty = isPack ? packQty : null;
    p.packsPerBox = isPack ? packsPerBox : null;
    p.unitsPerBox = unitsPerBox;
    p.showPricePerUnit = showPricePerUnit;
    p.showPackInfo = showPackInfo;
    
    // Сохраняем в Firebase
    const updateData = {
      title, category, description, costPrice, price, minQty,
      useQtyButtons, roundQty, isPack, unitsPerBox, showPricePerUnit, showPackInfo,
      packQty: isPack ? packQty : null,
      packsPerBox: isPack ? packsPerBox : null,
      variants: editModalVariants.length > 0 ? editModalVariants : null
    };
    
    // Обновляем локально варианты
    if (editModalVariants.length > 0) {
      p.variants = [...editModalVariants];
    } else {
      delete p.variants;
    }
    
    if (stock === null) {
      updateData.stock = firebase.firestore.FieldValue.delete();
    } else {
      updateData.stock = stock;
    }
    
    // Если variants null, удаляем поле
    if (!updateData.variants) {
      updateData.variants = firebase.firestore.FieldValue.delete();
    }
    
    await db.collection('products').doc(currentEditProductId).update(updateData);
    
    Swal.close();
    closeEditProductModal();
    renderProducts();
    
    Swal.fire({
      icon: 'success',
      title: 'Сохранено!',
      timer: 1500,
      showConfirmButton: false,
      toast: true,
      position: 'bottom'
    });
    
  } catch (error) {
    console.error('Ошибка сохранения:', error);
    Swal.fire('Ошибка', 'Не удалось сохранить: ' + error.message, 'error');
  }
}

// Закрытие модального окна по клику на фон
document.getElementById('editProductModal')?.addEventListener('click', function(e) {
  if (e.target === this) closeEditProductModal();
});

// === Функции для работы с вариантами в модальном окне ===
let editModalVariants = []; // Временный массив вариантов при редактировании

function initEditModalVariants(productId) {
  const p = products.find(pr => pr.id === productId);
  editModalVariants = (p && p.variants) ? [...p.variants] : [];
}

function addVariantToEdit() {
  const nameInput = document.getElementById('editVariantName');
  const priceInput = document.getElementById('editVariantPrice');
  
  const name = nameInput ? nameInput.value.trim() : '';
  const price = priceInput ? parseFloat(priceInput.value) || 0 : 0;
  
  if (!name) {
    Swal.fire({ icon: 'warning', title: 'Введите название', timer: 1500, showConfirmButton: false, toast: true, position: 'bottom' });
    return;
  }
  
  // Проверяем дубликат
  if (editModalVariants.some(v => v.name === name)) {
    Swal.fire({ icon: 'warning', title: 'Такой вариант уже есть', timer: 1500, showConfirmButton: false, toast: true, position: 'bottom' });
    return;
  }
  
  editModalVariants.push({
    id: 'var_' + Date.now(),
    name: name,
    price: price || null,
    image: null
  });
  
  // Очищаем поля
  if (nameInput) nameInput.value = '';
  if (priceInput) priceInput.value = '';
  
  updateEditVariantList();
}

function removeVariantFromEdit(index) {
  editModalVariants.splice(index, 1);
  updateEditVariantList();
}

function updateEditVariantList() {
  const container = document.getElementById('editVariantListContainer');
  if (!container) return;
  
  const p = products.find(pr => pr.id === currentEditProductId);
  const defaultImage = p ? p.image : '';
  
  if (editModalVariants.length === 0) {
    container.innerHTML = '<div style="color:#888; font-size:12px; text-align:center; padding:8px;">Нет вариантов</div>';
    return;
  }
  
  container.innerHTML = editModalVariants.map((v, i) => `
    <div style="display:flex; align-items:center; gap:8px; padding:8px; background:#fff; border-radius:6px; margin-bottom:6px; border:1px solid #e0e0e0;">
      <div style="position:relative;">
        <img src="${v.image || defaultImage || 'data:image/svg+xml,%3Csvg xmlns=\"http://www.w3.org/2000/svg\" width=\"40\" height=\"40\"%3E%3Crect fill=\"%23ddd\" width=\"40\" height=\"40\"/%3E%3C/svg%3E'}" style="width:40px; height:40px; object-fit:cover; border-radius:4px;">
        <button onclick="uploadVariantPhotoEdit(${i})" style="position:absolute; bottom:-4px; right:-4px; width:18px; height:18px; border:none; background:#2196f3; color:white; border-radius:50%; cursor:pointer; font-size:8px;" title="Фото">📷</button>
      </div>
      <div style="flex:1; min-width:0;">
        <div style="font-weight:600; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${v.name || 'Вариант'}</div>
        <div style="font-size:11px; color:#666;">${v.price ? v.price + ' сом' : 'Цена товара'}</div>
      </div>
      <button onclick="removeVariantFromEdit(${i})" style="width:24px; height:24px; border:none; background:#ffebee; color:#c62828; border-radius:50%; cursor:pointer; font-size:12px;">✕</button>
    </div>
  `).join('');
}

async function uploadVariantPhotoEdit(index) {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      Swal.fire({ title: 'Загрузка фото...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
      
      let imageUrl;
      if (typeof uploadToCloudinary === 'function') {
        imageUrl = await uploadToCloudinary(file);
      } else {
        throw new Error('Функция загрузки не найдена');
      }
      
      if (editModalVariants[index]) {
        editModalVariants[index].image = imageUrl;
      }
      
      Swal.close();
      updateEditVariantList();
      
    } catch (error) {
      console.error('Ошибка загрузки:', error);
      Swal.fire({ icon: 'error', title: 'Ошибка', text: error.message, timer: 2000 });
    }
  };
  
  input.click();
}

// Обновляет отображаемую цену в карточке товара в реальном времени
// На iPhone частые oninput могут лагать, поэтому ограничиваем обновления 1 раз/кадр.
const _updateCardPricePending = new WeakMap();

function updateCardPrice(inputEl, productId) {
  try {
    if (!inputEl) return;

    const prev = _updateCardPricePending.get(inputEl);
    if (prev) {
      prev.productId = productId;
      return;
    }

    const state = { productId };
    _updateCardPricePending.set(inputEl, state);
    const raf = (typeof requestAnimationFrame === 'function')
      ? requestAnimationFrame
      : (cb) => setTimeout(cb, 16);

    raf(() => {
      _updateCardPricePending.delete(inputEl);
      updateCardPriceNow(inputEl, state.productId);
    });
  } catch (err) {
    console.error('updateCardPrice error', err);
  }
}

function updateCardPriceNow(inputEl, productId) {
  try {
    let qty = parseInt(inputEl.value, 10);
    // Если поле пустое или NaN - не трогаем, пусть пользователь вводит
    if (isNaN(qty) || inputEl.value === '') {
      return;
    }
    if (qty < 0) qty = 0;
    
    const product = products.find(p => p.id === productId) || {};
    const card = inputEl.closest && inputEl.closest('.product-card');
    if (!card) return;
    
    // Автоматическое округление НЕ делаем при вводе - только при покупке
    // Это позволяет пользователю свободно редактировать поле
    
    const priceEl = card.querySelector('.card-price');
    const basePrice = Math.round(product.price || 0);
    const optPrice = product.optPrice ? Math.round(product.optPrice) : null;
    const optQty = product.optQty || null;
    const optInfoEl = card.querySelector('.card-opt-info');
    // Определяем единицу измерения для товара
    const unitLabel = product.isPack ? 'пачек' : 'шт';
    
    // Удаляем информационный блок о количестве если он был
    let qtyInfoEl = card.querySelector('.qty-calculation-info');
    if (qtyInfoEl) {
      qtyInfoEl.remove();
    }

    if (optQty && optPrice && qty >= optQty) {
      if (priceEl) priceEl.textContent = optPrice + ' сом';
      let old = card.querySelector('.card-oldprice');
      if (!old) {
        const span = document.createElement('div');
        span.className = 'card-oldprice';
        span.textContent = basePrice + ' сом';
        span.style.marginLeft = '8px';
        span.style.fontSize = '13px';
        span.style.color = '#888';
        if (priceEl && priceEl.parentNode) priceEl.parentNode.appendChild(span);
      } else {
        old.textContent = basePrice + ' сом';
      }
      if (optInfoEl) {
        optInfoEl.textContent = `Оптовая цена: ${optPrice} сом (при ${optQty} ${unitLabel})`;
        optInfoEl.style.color = '#d32f2f';
        optInfoEl.style.fontWeight = '700';
      }
    } else {
      if (priceEl) priceEl.textContent = basePrice + ' сом';
      const old = card.querySelector('.card-oldprice');
      if (old && old.parentNode) old.parentNode.removeChild(old);
      if (optInfoEl) {
        if (optPrice && optQty) {
          optInfoEl.textContent = `Опт: ${optPrice} сом при ${optQty} ${unitLabel}`;
          optInfoEl.style.color = '#007bff';
          optInfoEl.style.fontWeight = 'normal';
        } else {
          optInfoEl.textContent = '';
        }
      }
    }
  } catch (err) {
    console.error('updateCardPriceNow error', err);
  }
}

// Галерея-превью: переменные для навигации
let _gallery = [];
let _galleryIndex = 0;
let _touchStartX = null;

function _galleryKeyHandler(e) {
  if (e.key === 'ArrowLeft') prevGallery();
  if (e.key === 'ArrowRight') nextGallery();
  if (e.key === 'Escape') closePreview();
}

function showGalleryIndex() {
  const item = _gallery[_galleryIndex] || { src: '', title: '' };
  const img = document.getElementById('previewImg');
  img.src = item.src;
  document.getElementById('previewCaption').textContent = item.title || '';
}

function prevGallery() {
  if (_gallery.length === 0) return;
  _galleryIndex = (_galleryIndex - 1 + _gallery.length) % _gallery.length;
  showGalleryIndex();
}

function nextGallery() {
  if (_gallery.length === 0) return;
  _galleryIndex = (_galleryIndex + 1) % _gallery.length;
  showGalleryIndex();
}

function closePreview() {
  const block = document.getElementById('previewBlock');
  block.style.display = 'none';
  unlockPageScroll();
  try {
    document.getElementById('prevPreview').onclick = null;
    document.getElementById('nextPreview').onclick = null;
    document.getElementById('previewImg').ontouchstart = null;
    document.getElementById('previewImg').ontouchend = null;
    document.removeEventListener('keydown', _galleryKeyHandler);
  } catch (e) {}
}

// Поддержка кнопки закрытия
document.getElementById('closePreview').onclick = function() { closePreview(); };
document.getElementById('previewBlock').onclick = function(e) {
  if (e.target === this) closePreview();
};



// Функция для перемещения товара на выбранную позицию
async function showMoveProductModal(productId) {
  const product = products.find(p => p.id === productId);
  
  if (!product) return;
  
  // Получаем категорию товара
  const productCategory = (product.category || 'все').toLowerCase();
  
  // Фильтруем товары только из той же категории
  const categoryProducts = products.filter(p => {
    const pCategory = (p.category || 'все').toLowerCase();
    return pCategory === productCategory;
  });
  
  // Находим текущую позицию в отфильтрованном списке
  const currentCategoryIndex = categoryProducts.findIndex(p => p.id === productId);
  
  // Создаем список опций для выбора позиции (только товары из этой категории)
  const options = {};
  categoryProducts.forEach((p, idx) => {
    options[idx] = `${idx + 1}. ${p.title}`;
  });
  
  const { value: newCategoryPosition } = await Swal.fire({
    title: 'Переместить товар',
    html: `
      <div style="text-align:left;margin-bottom:15px;">
        <strong>Товар:</strong> ${product.title}<br>
        <strong>Категория:</strong> ${product.category || 'Все товары'}<br>
        <strong>Текущая позиция:</strong> #${currentCategoryIndex + 1} (в категории)
      </div>
      <div style="text-align:left;">
        <strong>Выберите товар, ПОСЛЕ которого разместить:</strong>
      </div>
    `,
    input: 'select',
    inputOptions: options,
    inputPlaceholder: 'Выберите товар',
    showCancelButton: true,
    confirmButtonText: 'Переместить',
    cancelButtonText: 'Отмена',
    inputValidator: (value) => {
      if (value === undefined || value === null || value === '') {
        return 'Выберите позицию!';
      }
    }
  });
  
  if (newCategoryPosition !== undefined && newCategoryPosition !== null) {
    const selectedIndex = parseInt(newCategoryPosition);
    
    // Целевая позиция = ПОСЛЕ выбранного товара
    // Если выбранный товар на позиции 2, то перемещаемый товар станет на позицию 3
    let targetCategoryIndex = selectedIndex + 1;
    
    // Если перемещаемый товар был ДО выбранного, то после удаления индекс сместится
    if (currentCategoryIndex < selectedIndex) {
      targetCategoryIndex = selectedIndex; // После splice он будет на правильном месте
    }
    
    if (selectedIndex === currentCategoryIndex || targetCategoryIndex === currentCategoryIndex) {
      return Swal.fire('Внимание', 'Товар уже на этой позиции', 'info');
    }
    
    // Получаем ID товаров в правильном порядке
    const categoryIds = categoryProducts.map(p => p.id);
    
    // Перемещаем ID товара: сначала удаляем из старой позиции
    const [movedId] = categoryIds.splice(currentCategoryIndex, 1);
    
    // Вставляем ПОСЛЕ выбранного товара
    // Если текущий индекс был меньше выбранного, то после удаления индексы сместились
    const insertIndex = currentCategoryIndex < selectedIndex ? selectedIndex : selectedIndex + 1;
    categoryIds.splice(insertIndex, 0, movedId);
    
    // Создаем новый массив продуктов с обновленным порядком
    const updatedCategoryProducts = categoryIds.map(id => 
      categoryProducts.find(p => p.id === id)
    );
    
    // Обновляем order для товаров этой категории
    const batch = db.batch();
    
    // Находим глобальные индексы для товаров категории
    const categoryGlobalIndices = categoryProducts.map(cp => 
      products.findIndex(p => p.id === cp.id)
    ).sort((a, b) => a - b);
    
    // Обновляем order на основе новых позиций
    updatedCategoryProducts.forEach((p, localIdx) => {
      const newOrder = categoryGlobalIndices[localIdx];
      batch.update(db.collection('products').doc(p.id), { order: newOrder });
    });
    
    await batch.commit();
    
    // Перезагружаем товары
    await loadProducts();
    
    // Новая позиция товара
    const newPosition = insertIndex + 1;
    
    Swal.fire({
      title: 'Готово',
      text: `Товар перемещён с позиции #${currentCategoryIndex + 1} на #${newPosition} (после "${categoryProducts[selectedIndex].title}")`,
      icon: 'success',
      timer: 2000,
      showConfirmButton: false
    });
  }
}

// Функция удаления товара
async function deleteProduct(productId) {
  try {
    const result = await Swal.fire({
      title: 'Удалить товар?',
      text: "Это действие нельзя отменить!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Да, удалить!',
      cancelButtonText: 'Отмена'
    });

    if (result.isConfirmed) {
      await db.collection('products').doc(productId).delete();
      Swal.fire('Удалено!', 'Товар был успешно удален.', 'success');
      loadProducts();
    }
  } catch (error) {
    console.error('Error deleting product:', error);
    Swal.fire('Ошибка', 'Не удалось удалить товар', 'error');
  }
}

// Функции для редактирования оптовых цен
const editWholesaleModal = document.createElement('div');
editWholesaleModal.id = 'editWholesaleModal';
editWholesaleModal.style.cssText = `
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  z-index: 9500;
`;
editWholesaleModal.innerHTML = `
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
    <h3 style="margin:0 0 15px 0; color:#17a2b8;">💎 Оптовые цены</h3>
    <div style="margin-bottom: 15px;">
      <label style="font-size:13px; color:#666;">Оптовая цена (сом):</label>
      <input type="number" id="editOptPrice" style="width: 100%; margin-top: 5px; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; box-sizing:border-box;">
    </div>
    <div style="margin-bottom: 15px;">
      <label style="font-size:13px; color:#666;">Минимум для опта (шт):</label>
      <input type="number" id="editOptQty" style="width: 100%; margin-top: 5px; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; box-sizing:border-box;">
    </div>
    <div style="display: flex; gap:10px;">
      <button onclick="closeEditWholesaleModal()" style="flex:1; background:#6c757d; color:white; border:none; padding:12px; border-radius:8px; cursor:pointer; font-size:14px;">Отмена</button>
      <button onclick="saveWholesaleChanges()" style="flex:1; background:#28a745; color:white; border:none; padding:12px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">💾 Сохранить</button>
    </div>
  </div>
`;
document.body.appendChild(editWholesaleModal);

let currentEditingProductId = null;

function showEditWholesaleModal(productId) {
  const product = products.find(p => p.id === productId);
  if (!product) return;
  
  currentEditingProductId = productId;
  document.getElementById('editOptPrice').value = product.optPrice || '';
  document.getElementById('editOptQty').value = product.optQty || '';
  editWholesaleModal.style.display = 'block';
}

function closeEditWholesaleModal() {
  editWholesaleModal.style.display = 'none';
  currentEditingProductId = null;
}

async function saveWholesaleChanges() {
  if (!currentEditingProductId) return;
  
  try {
    const optPrice = document.getElementById('editOptPrice').value;
    const optQty = document.getElementById('editOptQty').value;
    
    await db.collection('products').doc(currentEditingProductId).update({
      optPrice: optPrice ? Number(optPrice) : null,
      optQty: optQty ? Number(optQty) : null
    });
    
    Swal.fire('Успех!', 'Оптовые цены обновлены', 'success');
    closeEditWholesaleModal();
    loadProducts();
  } catch (error) {
    console.error('Error updating wholesale prices:', error);
    Swal.fire('Ошибка', 'Не удалось обновить оптовые цены', 'error');
  }
}

// Обработчик клика вне модального окна
editWholesaleModal.onclick = function(e) {
  if (e.target === this) {
    closeEditWholesaleModal();
  }
};

</script>

<!-- Кнопки прокрутки вверх/вниз -->
<style>
  .scroll-nav-btn {
    display: none;
    position: fixed;
    right: 16px;
    z-index: 9400;
    width: 44px;
    height: 44px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    opacity: 0;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    font-size: 18px;
    font-weight: 600;
  }
  .scroll-nav-btn:active {
    transform: scale(0.92);
  }
  #scrollTopBtn {
    bottom: 105px;
    background: rgba(255, 255, 255, 0.9);
    color: #1a1a1a;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.12), 0 1px 3px rgba(0, 0, 0, 0.08);
  }
  #scrollTopBtn:hover {
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15), 0 2px 6px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
  }
  #scrollBottomBtn {
    bottom: 56px;
    background: rgba(255, 255, 255, 0.9);
    color: #1a1a1a;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.12), 0 1px 3px rgba(0, 0, 0, 0.08);
  }
  #scrollBottomBtn:hover {
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15), 0 2px 6px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
  }
  /* Тёмная тема для тёмного фона */
  @media (prefers-color-scheme: dark) {
    #scrollTopBtn, #scrollBottomBtn {
      background: rgba(40, 40, 40, 0.9);
      color: #fff;
    }
    #scrollTopBtn:hover, #scrollBottomBtn:hover {
      background: rgba(50, 50, 50, 1);
    }
  }
</style>
<button id="scrollTopBtn" class="scroll-nav-btn" onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>
</button>
<button id="scrollBottomBtn" class="scroll-nav-btn" onclick="window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
</button>

  <footer id="siteFooter" style="background: #003366; color: #fff; padding:14px 10px; text-align:center; margin-top:18px;">
    <div style="max-width:1200px; margin:0 auto; font-weight:700;">
      О нас: мы первый рук из китая — у нас низкие цены
    </div>
  </footer>

<script>
// --- Функция для показа/скрытия админ-панели ---
function toggleAdminPanel() {
  const panel = document.getElementById('adminPanel');
  if (panel.classList.contains('admin-panel-hidden')) {
    panel.classList.remove('admin-panel-hidden');
    document.getElementById('hideAdminPanelBtn').textContent = 'Скрыть панель';
  } else {
    panel.classList.add('admin-panel-hidden');
    document.getElementById('hideAdminPanelBtn').textContent = 'Показать панель';
  }
}
// Смена фото товара админом
// Кнопка корзины: прокрутка к корзине и обновление количества
const cartFloatBtn = document.getElementById('cartFloatBtn');
const cartFloatCount = document.getElementById('cartFloatCount');
const orderForm = document.querySelector('.order-form');

if (cartFloatBtn) {
  cartFloatBtn.onclick = function() {
    openCartPage();
  };
}

function updateCartFloatCount() {
  if (cartFloatCount) {
    // Показываем количество видов товаров (позиций)
    const totalPositions = cart.length;
    cartFloatCount.textContent = totalPositions;
    
    // Анимация при изменении
    cartFloatCount.style.transform = 'scale(1.2)';
    setTimeout(() => {
      cartFloatCount.style.transform = 'scale(1)';
    }, 200);
    
    // Скрываем счётчик если корзина пуста
    const btn = document.getElementById('cartFloatBtn');
    if (btn) {
      if (totalPositions === 0) {
        btn.style.opacity = '0.7';
      } else {
        btn.style.opacity = '1';
      }
    }
  }
}
// Вызовем при инициализации корзины
document.addEventListener('DOMContentLoaded', function() {
  updateCartFloatCount();
  
  // Переопределяем updateCart после загрузки всех модулей
  if (typeof updateCart === 'function') {
    const origUpdateCart = updateCart;
    window.updateCart = function() {
      origUpdateCart.apply(this, arguments);
      updateCartFloatCount();
    };
  }
});

   

// Функция для показа детальной информации о товаре (для корейских товаров и часов)
function showProductDetailModal(productId) {
  const product = products.find(p => p.id === productId);
  if (!product) return;
  
  Swal.fire({
    title: product.title || 'Товар',
    html: `
      <div style="text-align:center;">
        <img loading="eager" src="${product.image || ''}" alt="${product.title || ''}" style="max-width:100%; max-height:300px; border-radius:12px; margin-bottom:15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <div style="background:linear-gradient(135deg, #fff3e0, #ffe0b2); padding:15px; border-radius:10px; margin-top:10px;">
          <div style="font-size:24px; font-weight:bold; color:#e65100; margin-bottom:10px;">${product.price || 0} сом</div>
          <div style="font-size:15px; color:#5d4037; line-height:1.6; text-align:left;">${product.description || 'Описание отсутствует'}</div>
        </div>
      </div>
    `,
    width: 450,
    showCloseButton: true,
    showConfirmButton: false,
    background: '#fffbf0',
    customClass: {
      popup: 'korean-product-modal'
    }
  });
}

// Открыть окно жалобы
function openComplaintWindow() {
  // Закрываем профиль если открыт
  const profileModal = document.getElementById('profileFullscreenModal');
  if (profileModal) profileModal.remove();
  
  setTimeout(() => {
    document.getElementById('complaintWindow').style.display = 'flex';
    lockPageScroll(); // Блокируем скролл
    
    // Очищаем форму
    document.getElementById('complaintName').value = '';
    document.getElementById('complaintPhone').value = '';
    document.getElementById('complaintCategory').value = '';
    document.getElementById('complaintText').value = '';
  }, 300);
}

// Закрыть окно жалобы
function closeComplaintWindow() {
  document.getElementById('complaintWindow').style.display = 'none';
  unlockPageScroll(); // Разблокируем скролл
}

// Отправить жалобу в Telegram
async function sendComplaint() {
  const name = document.getElementById('complaintName').value.trim();
  const phone = document.getElementById('complaintPhone').value.trim();
  const category = document.getElementById('complaintCategory').value;
  const text = document.getElementById('complaintText').value.trim();
  
  // Валидация
  if (!name) {
    Swal.fire('Ошибка', 'Введите ваше имя', 'error');
    return;
  }
  
  if (!phone) {
    Swal.fire('Ошибка', 'Введите номер телефона', 'error');
    return;
  }
  
  if (!category) {
    Swal.fire('Ошибка', 'Выберите категорию жалобы', 'error');
    return;
  }
  
  if (!text) {
    Swal.fire('Ошибка', 'Опишите проблему', 'error');
    return;
  }
  
  const categoryNames = {
    'quality': '🔴 Качество товара',
    'delivery': '🚚 Проблемы с доставкой',
    'service': '👤 Обслуживание',
    'price': '💰 Неверная цена',
    'other': '📝 Другое'
  };
  
  const message = `⚠️ *ЖАЛОБА ОТ КЛИЕНТА*\n\n` +
    `👤 *Имя:* ${name}\n` +
    `📱 *Телефон:* ${phone}\n` +
    `📂 *Категория:* ${categoryNames[category]}\n\n` +
    `📝 *Описание проблемы:*\n${text}\n\n` +
    `🕐 *Дата:* ${new Date().toLocaleString('ru-RU')}`;
  
  try {
    Swal.fire({
      title: 'Отправка жалобы...',
      text: 'Пожалуйста, подождите',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });
    
    const response = await fetch('https://api.telegram.org/bot7599592948:AAGtc_dGAcJFVQOSYcKVY0W-7GegszY9n8E/sendMessage', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        chat_id: '5567924440',
        text: message,
        parse_mode: 'Markdown'
      })
    });
    
    const result = await response.json();
    
    if (result.ok) {
      closeComplaintWindow();
      Swal.fire({
        icon: 'success',
        title: 'Жалоба отправлена!',
        text: 'Мы рассмотрим вашу жалобу и свяжемся с вами в ближайшее время',
        confirmButtonText: 'Понятно'
      });
    } else {
      throw new Error('Ошибка отправки');
    }
    
  } catch (error) {
    console.error('Ошибка отправки жалобы:', error);
    Swal.fire({
      icon: 'error',
      title: 'Ошибка',
      text: 'Не удалось отправить жалобу. Попробуйте позже или свяжитесь с нами по телефону.'
    });
  }
}

// Функции окна предложения товара
function openSuggestionWindow() {
  // Закрываем профиль если открыт
  const profileModal = document.getElementById('profileFullscreenModal');
  if (profileModal) profileModal.remove();
  
  setTimeout(() => {
    document.getElementById('suggestionWindow').style.display = 'flex';
    lockPageScroll(); // Блокируем скролл
    
    // Очистка формы
    document.getElementById('suggestionName').value = '';
    document.getElementById('suggestionPhone').value = '';
    document.getElementById('suggestionProductName').value = '';
    document.getElementById('suggestionCurrentPrice').value = '';
    document.getElementById('suggestionPrice').value = '';
    document.getElementById('suggestionDescription').value = '';
    document.getElementById('suggestionPhoto').value = '';
  }, 300);
}

function closeSuggestionWindow() {
  document.getElementById('suggestionWindow').style.display = 'none';
  unlockPageScroll(); // Разблокируем скролл
}

async function sendSuggestion() {
  const name = document.getElementById('suggestionName').value.trim();
  const phone = document.getElementById('suggestionPhone').value.trim();
  const productName = document.getElementById('suggestionProductName').value.trim();
  const currentPrice = document.getElementById('suggestionCurrentPrice').value.trim();
  const price = document.getElementById('suggestionPrice').value.trim();
  const description = document.getElementById('suggestionDescription').value.trim();
  const photoInput = document.getElementById('suggestionPhoto');
  
  if (!name) {
    Swal.fire('Ошибка', 'Введите ваше имя', 'error');
    return;
  }
  
  if (!phone) {
    Swal.fire('Ошибка', 'Введите телефон', 'error');
    return;
  }
  
  if (!productName) {
    Swal.fire('Ошибка', 'Укажите название товара', 'error');
    return;
  }
  
  if (!description) {
    Swal.fire('Ошибка', 'Опишите товар подробнее', 'error');
    return;
  }
  
  try {
    // Показываем спиннер в окне
    document.getElementById('suggestionLoader').style.display = 'flex';
    document.getElementById('suggestionSubmitBtn').disabled = true;
    
    let message = `💡 *ПРЕДЛОЖЕНИЕ ТОВАРА*\n\n` +
      `👤 *Имя клиента:* ${name}\n` +
      `📱 *Телефон:* ${phone}\n` +
      `🏷️ *Название товара:* ${productName}\n` +
      `💵 *Текущая цена:* ${currentPrice ? currentPrice + ' сом' : 'не указана'}\n` +
      `💰 *Желаемая цена:* ${price ? price + ' сом' : 'не указана'}\n\n` +
      `📝 *Описание:*\n${description}\n\n` +
      `🕐 *Дата:* ${new Date().toLocaleString('ru-RU')}`;
    
    let result;
    
    // Если есть фото - отправляем напрямую в Telegram через sendPhoto с файлом
    if (photoInput.files && photoInput.files[0]) {
      console.log('Отправка фото в Telegram...');
      
      const telegramFormData = new FormData();
      telegramFormData.append('chat_id', '5567924440');
      telegramFormData.append('photo', photoInput.files[0]);
      telegramFormData.append('caption', message);
      
      const response = await fetch('https://api.telegram.org/bot7599592948:AAGtc_dGAcJFVQOSYcKVY0W-7GegszY9n8E/sendPhoto', {
        method: 'POST',
        body: telegramFormData
      });
      
      result = await response.json();
      console.log('Результат отправки с фото:', result);
    } else {
      // Если нет фото - отправляем обычное текстовое сообщение
      console.log('Отправка текстового сообщения...');
      
      const response = await fetch('https://api.telegram.org/bot7599592948:AAGtc_dGAcJFVQOSYcKVY0W-7GegszY9n8E/sendMessage', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          chat_id: '5567924440',
          text: message,
          parse_mode: 'Markdown'
        })
      });
      result = await response.json();
      console.log('Результат отправки текста:', result);
    }
    
    if (result.ok) {
      // Скрываем спиннер
      document.getElementById('suggestionLoader').style.display = 'none';
      document.getElementById('suggestionSubmitBtn').disabled = false;
      
      closeSuggestionWindow();
      Swal.fire({
        icon: 'success',
        title: 'Предложение отправлено!',
        text: 'Спасибо за ваше предложение! Мы рассмотрим его и постараемся добавить этот товар',
        confirmButtonText: 'Отлично'
      });
    } else {
      throw new Error('Ошибка отправки');
    }
    
  } catch (error) {
    // Скрываем спиннер при ошибке
    document.getElementById('suggestionLoader').style.display = 'none';
    document.getElementById('suggestionSubmitBtn').disabled = false;
    
    console.error('Ошибка отправки предложения:', error);
    Swal.fire({
      icon: 'error',
      title: 'Ошибка',
      text: 'Не удалось отправить предложение. Попробуйте позже или свяжитесь с нами по телефону.'
    });
  }
}

// Функции окна "Стать продавцом"



// Экранирование HTML для безопасности
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Показать поле ввода новой категории
function showNewCategoryInput() {
  document.getElementById('newCategoryInputDiv').style.display = 'block';
  document.getElementById('newCategory').disabled = true;
  document.getElementById('newCategoryInput').focus();
}

// Скрыть поле ввода новой категории
function hideNewCategoryInput() {
  document.getElementById('newCategoryInputDiv').style.display = 'none';
  document.getElementById('newCategory').disabled = false;
  document.getElementById('newCategoryInput').value = '';
}

// ==================== УПРАВЛЕНИЕ ПРОДАВЦАМИ (АДМИН) ====================


// Удалить категорию

// ==================== КОНЕЦ ПАРТНЕРСКИХ ЗАКАЗОВ ====================

// ====== Управление заказами: кеш + быстрый поиск (важно для iPhone) ======

// Обработка iOS composition для поиска заказов

// ===== ОБЪЕДИНЕНИЕ ЗАКАЗОВ КЛИЕНТОВ =====

// Открыть модальное окно объединения заказов

  // Группируем заказы по клиенту (имя + телефон) и дате

  // Фильтруем только группы с 2+ заказами
  
  // Показываем список групп для объединения

    // Загружаем все заказы

    // Пересчитываем общую сумму
  
    // Обновляем список заказов
   
 

// Открыть модальное окно для добавления товара в заказ

// Закрыть модальное окно

// Добавить выбранный товар в заказ

  
    // Товары с сеткой

// Открытие полноэкранного окна админского чата
function openAdminChatWindow() {
  const adminChatWindow = document.getElementById('adminChatWindow');
  adminChatWindow.style.display = 'flex';
  lockPageScroll(); // Блокируем скролл
  if (typeof loadAdminFullChat === 'function') loadAdminFullChat();
}

// Закрытие полноэкранного окна админского чата
function closeAdminChatWindow() {
  const adminChatWindow = document.getElementById('adminChatWindow');
  adminChatWindow.style.display = 'none';
  unlockPageScroll(); // Разблокируем скролл
}

// Загрузка чата в полноэкранное окно админа
async function loadAdminFullChat() {
  if (typeof db === 'undefined') {
    document.getElementById('adminFullChatMessages').innerHTML = '<div style="text-align:center; color:#999; padding:40px;">Firebase не подключен</div>';
    return;
  }
  
  try {
    // Загружаем список клиентов
    const clientsSnapshot = await db.collection('chatClients').get();
    
    const messagesDiv = document.getElementById('adminFullChatMessages');
    messagesDiv.innerHTML = `
      <div style="display:flex; height:100%; background:#f8f9fa;">
        <div id="fullClientsList" style="width:280px; border-right:2px solid #e0e0e0; overflow-y:auto; padding:16px; background:white;">
          <div style="font-weight:bold; margin-bottom:16px; color:#333; font-size:17px; padding:12px; background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius:10px; text-align:center;">
            📋 Клиенты (${clientsSnapshot.size})
          </div>
        </div>
        <div style="flex:1; display:flex; flex-direction:column;">
          <div id="fullChatHeader" style="padding:20px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; font-weight:bold; display:none;">
            <div style="font-size:20px;">Выберите клиента</div>
          </div>
          <div id="fullChatMessagesArea" style="flex:1; display:flex; flex-direction:column; padding:20px; overflow-y:auto; background:#f5f5f5; gap:12px;">
            <div style="text-align:center; color:#999; padding:60px; font-size:18px;">
              👈 Выберите клиента из списка слева
            </div>
          </div>
        </div>
      </div>
    `;
    
    const clientsList = document.getElementById('fullClientsList');
    
    if (clientsSnapshot.empty) {
      clientsList.innerHTML += '<div style="color:#999;  text-align:center; margin-top:60px; padding:30px; line-height:1.6;">Пока нет активных чатов.<br>Клиенты появятся здесь после первого сообщения.</div>';
      return;
    }
    
    // Собираем клиентов в массив и сортируем
    const clients = [];
    clientsSnapshot.forEach((doc) => {
      clients.push({ id: doc.id, data: doc.data() });
    });
    
    clients.sort((a, b) => {
      const timeA = a.data.lastActive ? a.data.lastActive.toDate().getTime() : 0;
      const timeB = b.data.lastActive ? b.data.lastActive.toDate().getTime() : 0;
      return timeB - timeA;
    });
    
    // Добавляем клиентов в список
    clients.forEach(({id, data: client}) => {
      const clientDiv = document.createElement('div');
      clientDiv.style.cssText = `
        padding:14px; margin-bottom:12px; background:${client.hasUnread ? '#fff9c4' : '#f8f9fa'}; 
        border-radius:12px; cursor:pointer; transition:all 0.2s; border:2px solid transparent;
      `;
      clientDiv.innerHTML = `
        <div style="font-weight:bold; color:#333; margin-bottom:6px; font-size:16px;">${client.name}</div>
        <div style="font-size:12px; color:#666;">
          ${client.lastActive ? new Date(client.lastActive.toDate()).toLocaleString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          }) : 'Давно'}
        </div>
        ${client.hasUnread ? '<div style="font-size:11px; color:#f57c00; font-weight:bold; margin-top:8px;">🔔 НОВОЕ СООБЩЕНИЕ</div>' : ''}
      `;
      
      clientDiv.onmouseover = () => clientDiv.style.borderColor = '#667eea';
      clientDiv.onmouseout = () => {
        if (selectedClientId !== id) clientDiv.style.borderColor = 'transparent';
      };
      
      clientDiv.onclick = () => loadFullClientMessages(id, client.name, clientDiv);
      clientsList.appendChild(clientDiv);
    });
    
  } catch (error) {
    console.error('Ошибка загрузки клиентов:', error);
    document.getElementById('adminFullChatMessages').innerHTML = '<div style="text-align:center; color:#dc3545; padding:40px;">Ошибка загрузки клиентов</div>';
  }
}

// Загрузка сообщений клиента в полноэкранном окне
async function loadFullClientMessages(clientId, clientName, clientDiv) {
  selectedClientId = clientId;
  selectedClientName = clientName;
  
  // Подсвечиваем выбранного клиента
  document.querySelectorAll('#fullClientsList > div').forEach(div => {
    if (div.style && div !== clientDiv) {
      div.style.borderColor = 'transparent';
      div.style.background = '#f8f9fa';
    }
  });
  if (clientDiv) {
    clientDiv.style.borderColor = '#667eea';
    clientDiv.style.background = '#e3f2fd';
  }
  
  // Убираем метку "новое"
  try {
    await db.collection('chatClients').doc(clientId).update({ hasUnread: false });
  } catch (error) {
    console.error('Ошибка обновления статуса:', error);
  }
  
  // Обновляем заголовок
  const chatHeader = document.getElementById('fullChatHeader');
  chatHeader.style.display = 'flex';
  chatHeader.style.justifyContent = 'space-between';
  chatHeader.style.alignItems = 'center';
  chatHeader.innerHTML = `
    <div>
      <div style="font-size:20px;">💬 Чат с ${clientName}</div>
      <div style="font-size:13px; opacity:0.9; margin-top:6px;">ID: ${clientId}</div>
    </div>
    <button onclick="changeClientNameByAdmin()" style="background:rgba(255,255,255,0.25); border:none; color:white; font-size:20px; cursor:pointer; padding:10px; border-radius:10px; min-width:50px; height:50px; display:flex; align-items:center; justify-content:center; transition:background 0.2s;" title="Изменить имя клиента" onmouseover="this.style.background='rgba(255,255,255,0.35)'" onmouseout="this.style.background='rgba(255,255,255,0.25)'">
      ✏️
    </button>
  `;
  
  try {
    const querySnapshot = await db.collection('chatMessages')
      .where('clientId', '==', clientId)
      .get();
    
    const chatArea = document.getElementById('fullChatMessagesArea');
    chatArea.innerHTML = '';
    
    if (querySnapshot.empty) {
      chatArea.innerHTML = `<div style="text-align:center; color:#999; padding:60px; font-size:16px;">Нет сообщений с ${clientName}</div>`;
      return;
    }
    
    const messages = [];
    querySnapshot.forEach((doc) => {
      const msg = doc.data();
      messages.push({
        text: msg.text,
        sender: msg.sender,
        timestamp: msg.timestamp.toDate()
      });
    });
    
    messages.sort((a, b) => a.timestamp - b.timestamp);
    
    messages.forEach(msg => {
      addAdminFullChatMessageToUI(msg.text, msg.sender, msg.timestamp);
    });
    
    chatArea.scrollTop = chatArea.scrollHeight;
    
    // Обновляем placeholder
    const inputField = document.getElementById('adminFullChatInput');
    if (inputField) {
      inputField.placeholder = `Ответить ${clientName}...`;
    }
    
    // Подписываемся на новые сообщения
    subscribeToAdminFullChatMessages(clientId);
    
  } catch (error) {
    console.error('Ошибка загрузки сообщений:', error);
    document.getElementById('fullChatMessagesArea').innerHTML = '<div style="text-align:center; color:#dc3545; padding:40px;">Ошибка загрузки сообщений</div>';
  }
}

// Добавление сообщения в UI полноэкранного админского чата
function addAdminFullChatMessageToUI(text, sender, timestamp) {
  const chatArea = document.getElementById('fullChatMessagesArea');
  if (!chatArea) return;
  
  const timeStr = timestamp.getHours().toString().padStart(2, '0') + ':' + timestamp.getMinutes().toString().padStart(2, '0');
  const dateStr = timestamp.toLocaleDateString('ru-RU');
  
  const messageDiv = document.createElement('div');
  messageDiv.style.cssText = 'display:flex;';
  
  const msgContent = document.createElement('div');
  
  if (sender === 'client') {
    msgContent.style.cssText = 'background:white; padding:14px; border-radius:14px 14px 14px 4px; max-width:70%; box-shadow:0 2px 6px rgba(0,0,0,0.1);';
    msgContent.innerHTML = `
      <div style="font-size:13px; color:#667eea; font-weight:bold; margin-bottom:6px;">👤 ${selectedClientName || 'Клиент'}</div>
      <div style="font-size:15px; color:#333;">${escapeHtml(text)}</div>
      <div style="font-size:11px; color:#999; margin-top:6px;">${dateStr} ${timeStr}</div>
    `;
  } else {
    messageDiv.style.justifyContent = 'flex-end';
    msgContent.style.cssText = 'background:#667eea; color:white; padding:14px; border-radius:14px 14px 4px 14px; max-width:70%; box-shadow:0 2px 6px rgba(0,0,0,0.15);';
    msgContent.innerHTML = `
      <div style="font-size:13px; font-weight:bold; margin-bottom:6px; opacity:0.9;">✅ Вы</div>
      <div style="font-size:15px;">${escapeHtml(text)}</div>
      <div style="font-size:11px; opacity:0.9; margin-top:6px; text-align:right;">${dateStr} ${timeStr}</div>
    `;
  }
  
  messageDiv.appendChild(msgContent);
  chatArea.appendChild(messageDiv);
}

// Отправка сообщения в полноэкранном окне
async function sendAdminFullChatMessage() {
  if (!selectedClientId) {
    Swal.fire('Ошибка', 'Сначала выберите клиента из списка слева', 'warning');
    return;
  }
  
  const input = document.getElementById('adminFullChatInput');
  const message = input.value.trim();
  
  if (!message) return;
  
  const now = new Date();
  
  try {
    addAdminFullChatMessageToUI(message, 'admin', now);
    
    await db.collection('chatMessages').add({
      text: message,
      sender: 'admin',
      clientId: selectedClientId,
      clientName: selectedClientName,
      timestamp: firebase.firestore.Timestamp.fromDate(now),
      read: false
    });
    
    input.value = '';
    
    const chatArea = document.getElementById('fullChatMessagesArea');
    chatArea.scrollTop = chatArea.scrollHeight;
    
  } catch (error) {
    console.error('Ошибка отправки:', error);
    Swal.fire('Ошибка', 'Не удалось отправить сообщение', 'error');
  }
}

// Изменение имени клиента админом
async function changeClientNameByAdmin() {
  if (!selectedClientId) {
    Swal.fire('Ошибка', 'Сначала выберите клиента', 'warning');
    return;
  }
  
  const { value: newName } = await Swal.fire({
    title: 'Изменить имя клиента',
    input: 'text',
    inputLabel: 'Введите новое имя для клиента',
    inputValue: selectedClientName || '',
    showCancelButton: true,
    confirmButtonText: 'Сохранить',
    cancelButtonText: 'Отмена',
    inputValidator: (value) => {
      if (!value) {
        return 'Пожалуйста, введите имя!';
      }
    }
  });
  
  if (newName && newName !== selectedClientName) {
    try {
      // Обновляем имя в базе данных
      await db.collection('chatClients').doc(selectedClientId).update({
        name: newName,
        lastActive: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Обновляем локальную переменную
      selectedClientName = newName;
      
      // Обновляем заголовок
      const chatHeader = document.getElementById('fullChatHeader');
      if (chatHeader) {
        chatHeader.querySelector('div > div:first-child').textContent = `💬 Чат с ${newName}`;
      }
      
      // Обновляем placeholder поля ввода
      const inputField = document.getElementById('adminFullChatInput');
      if (inputField) {
        inputField.placeholder = `Ответить ${newName}...`;
      }
      
      // Перезагружаем список клиентов чтобы отобразить новое имя
      await loadAdminFullChat();
      
      Swal.fire({
        icon: 'success',
        title: 'Имя изменено!',
        text: `Клиент теперь: ${newName}`,
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 2000
      });
      
    } catch (error) {
      console.error('Ошибка обновления имени:', error);
      Swal.fire('Ошибка', 'Не удалось обновить имя клиента', 'error');
    }
  }
}

// Подписка на новые сообщения в полноэкранном окне
function subscribeToAdminFullChatMessages(clientId) {
  if (typeof db === 'undefined') return;
  
  db.collection('chatMessages')
    .where('clientId', '==', clientId)
    .onSnapshot((snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === 'added') {
          const msg = change.doc.data();
          if (msg.sender === 'client' && msg.clientId === selectedClientId) {
            const chatArea = document.getElementById('fullChatMessagesArea');
            const existingMessages = chatArea.querySelectorAll('div');
            let isDuplicate = false;
            existingMessages.forEach(div => {
              if (div.textContent && div.textContent.includes(msg.text)) {
                isDuplicate = true;
              }
            });
            
            if (!isDuplicate) {
              addAdminFullChatMessageToUI(msg.text, msg.sender, msg.timestamp.toDate());
              chatArea.scrollTop = chatArea.scrollHeight;
            }
          }
        }
      });
    });
}

// Выход из режима администратора
function logoutAdmin() {
  isAdmin = false;
  userRole = 'guest';
  isEditorMode = false; // Выключаем режим редактора
  
  const managementHeader = document.getElementById('managementHeader');
  
  if (managementHeader) managementHeader.style.display = 'none';
  
  // Скрываем кнопку редактора товаров
  const editorBtnContainer = document.getElementById('editorBtnContainer');
  if (editorBtnContainer) editorBtnContainer.style.display = 'none';
  
  // Сбрасываем стиль кнопки редактора
  const editorModeBtn = document.getElementById('editorModeBtn');
  if (editorModeBtn) {
    editorModeBtn.style.background = 'linear-gradient(135deg,#6c757d,#495057)';
    editorModeBtn.innerHTML = '✏️ Редактор';
  }
  
  // Показываем все кнопки категорий обратно
  document.querySelectorAll('.category-btn').forEach(btn => {
    btn.style.display = 'block';
  });
  
  renderProducts();
  
  Swal.fire('Выход', 'Вы вышли из режима администратора', 'info');
}

// ==================== КОНЕЦ ФУНКЦИЙ БОКОВОГО МЕНЮ ====================
// ==================== ОТЧЕТ ПО ПРИБЫЛИ ====================
// ==================== КОНЕЦ ОТЧЕТА ПО ПРИБЫЛИ ====================
// ==================== АДМИН-ФУНКЦИИ ДЛЯ ЧАТА ====================
// Загрузка сообщений в админ-панел
// Переменная для хранения выбранного клиента админом
// ==================== КОНЕЦ АДМИН-ФУНКЦИЙ ЧАТА ====================
// ==================== КОНЕЦ ФУНКЦИЙ ЧАТА ====================
// ==================== ФУНКЦИИ РАСХОДОВ ====================
// Открыть окно добавления расхода
// ==================== КОНЕЦ ФУНКЦИЙ РАСХОДОВ ====================

// Функция переключения видимости других категорий
let otherCategoriesVisible = false;
function toggleOtherCategories() {
  const container = document.getElementById('otherCategoriesContainer');
  const btn = document.getElementById('otherCategoriesBtn');
  otherCategoriesVisible = !otherCategoriesVisible;
  if (otherCategoriesVisible) {
    container.style.display = '';
    container.classList.add('visible');
    btn.innerHTML = '📂 Скрыть категории ▲';
  } else {
    container.style.display = 'none';
    container.classList.remove('visible');
    btn.innerHTML = '📂 Другие категории ▼';
  }
}

// Скрипт для работы кнопок прокрутки вверх/вниз
// Две отдельные кнопки - вверх и вниз
(function() {
  const scrollTopBtn = document.getElementById('scrollTopBtn');
  const scrollBottomBtn = document.getElementById('scrollBottomBtn');
  let scrollTimeout;
  
  function updateScrollButtons() {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const scrollHeight = document.documentElement.scrollHeight;
    const clientHeight = document.documentElement.clientHeight;
    
    // Минимальная высота страницы для показа кнопок
    if (scrollHeight <= clientHeight + 300) {
      scrollTopBtn.style.display = 'none';
      scrollBottomBtn.style.display = 'none';
      return;
    }
    
    // Порог для определения краёв страницы
    const topThreshold = 200;
    const bottomThreshold = 200;
    const isAtTop = scrollTop < topThreshold;
    const isAtBottom = scrollTop + clientHeight >= scrollHeight - bottomThreshold;
    
    // Кнопка "ВВЕРХ" - показываем если не вверху
    if (!isAtTop) {
      scrollTopBtn.style.display = 'flex';
      scrollTopBtn.style.alignItems = 'center';
      scrollTopBtn.style.justifyContent = 'center';
      setTimeout(() => { scrollTopBtn.style.opacity = '1'; }, 10);
    } else {
      scrollTopBtn.style.opacity = '0';
      setTimeout(() => { scrollTopBtn.style.display = 'none'; }, 300);
    }
    
    // Кнопка "ВНИЗ" - показываем если не внизу
    if (!isAtBottom) {
      scrollBottomBtn.style.display = 'flex';
      scrollBottomBtn.style.alignItems = 'center';
      scrollBottomBtn.style.justifyContent = 'center';
      setTimeout(() => { scrollBottomBtn.style.opacity = '1'; }, 10);
    } else {
      scrollBottomBtn.style.opacity = '0';
      setTimeout(() => { scrollBottomBtn.style.display = 'none'; }, 300);
    }
  }
  
  // Слушаем прокрутку
  window.addEventListener('scroll', function() {
    if (scrollTimeout) clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(updateScrollButtons, 50);
  }, { passive: true });
  
  // Проверяем при загрузке
  setTimeout(updateScrollButtons, 500);
})();
// Debounce для поля названия товара удалён - был пустым и создавал лишнюю нагрузку
// ===== СИСТЕМА ОТСЛЕЖИВАНИЯ ЗАКАЗА ДЛЯ КЛИЕНТА =====
// ===== КОНЕЦ СИСТЕМЫ ОТСЛЕЖИВАНИЯ =====
// ===== СИСТЕМА АГЕНТОВ (2% комиссия) =====
// Текущий агент (хранится в localStorage)

// ============ ГЛОБАЛЬНАЯ ФУНКЦИЯ ГОЛОСОВОГО ПОИСКА ============

window.startVoiceSearch = function() {
  // Проверяем глобальную переменную recognition
  if (!window.recognition) {
    if (typeof window.initVoiceSearch === 'function') {
      window.initVoiceSearch();
    }
  }
  
  if (window.recognition) {
    if (window.isListening) {
      window.recognition.stop();
    } else {
      try {
        window.recognition.start();
      } catch (error) {
        console.error('Ошибка голосового поиска:', error);
      }
    }
  } else {
    Swal.fire({
      icon: 'warning',
      title: 'Не поддерживается',
      text: 'Ваш браузер не поддерживает голосовой поиск',
      timer: 3000
    });
  }
};

</script>

<!-- Подключение модулей JS -->
 <script src="js/filters.js"></script>
<script src="js/advanced-search.js"></script>
<script src="js/helpers.js"></script>
<script src="js/image-optimizer.js"></script>
<script src="js/upload.js"></script>
<script src="js/gallery.js"></script>
<script src="js/favorites.js"></script>
<script src="js/cart.js"></script>
<script src="js/variants.js?v=2"></script>
<script src="js/quantity.js?v=2"></script>
<script src="js/orders.js?v=2"></script>
<script src="js/customer-auth.js?v=2"></script>
<script src="js/chat.js?v=2"></script>
<script src="js/seller.js?v=2"></script>
<script src="js/admin-chat.js?v=2"></script>
<script src="js/order-tracking.js?v=2"></script>
<script src="js/partners.js?v=2"></script>
<script src="js/orders-management.js?v=2"></script>
<script src="js/profit-report.js?v=2"></script>
<script src="js/expenses.js?v=2"></script>
<script src="js/agents.js?v=2"></script>
<script src="js/bottom-nav.js?v=2"></script>

<!-- PWA установка приложения -->
<script>
let deferredPrompt;
const installPwaContainer = document.getElementById('installPwaContainer');
const installPwaBtn = document.getElementById('installPwaBtn');

// Ловим событие beforeinstallprompt
window.addEventListener('beforeinstallprompt', (e) => {
  console.log('💡 Доступна установка PWA');
  // Предотвращаем автоматический промпт браузера
  e.preventDefault();
  // Сохраняем событие для использования позже
  deferredPrompt = e;
  // Показываем кнопку установки
  if (installPwaContainer) {
    installPwaContainer.style.display = 'block';
  }
});

// Обработчик клика на кнопку установки
if (installPwaBtn) {
  installPwaBtn.addEventListener('click', async () => {
    if (!deferredPrompt) {
      console.log('❌ Промпт установки недоступен');
      return;
    }
    
    // Показываем стандартный промпт браузера
    deferredPrompt.prompt();
    
    // Ждём ответа пользователя
    const { outcome } = await deferredPrompt.userChoice;
    console.log(`👤 Пользователь ${outcome === 'accepted' ? 'установил' : 'отклонил'} установку`);
    
    if (outcome === 'accepted') {
      // Показываем успешное сообщение
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          icon: 'success',
          title: '🎉 Успешно!',
          text: 'Приложение Кербен установлено',
          timer: 2000,
          showConfirmButton: false
        });
      }
    }
    
    // Очищаем сохранённый промпт
    deferredPrompt = null;
    // Скрываем кнопку
    installPwaContainer.style.display = 'none';
  });
}

// Скрываем кнопку если приложение уже установлено
window.addEventListener('appinstalled', () => {
  console.log('✅ PWA приложение установлено');
  if (installPwaContainer) {
    installPwaContainer.style.display = 'none';
  }
  deferredPrompt = null;
  
  if (typeof Swal !== 'undefined') {
    Swal.fire({
      icon: 'success',
      title: '🎉 Готово!',
      text: 'Приложение Кербен добавлено на главный экран',
      timer: 2500,
      showConfirmButton: false
    });
  }
});

// Проверяем, запущено ли приложение в standalone режиме
if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
  console.log('📱 Приложение запущено в standalone режиме');
  // Скрываем кнопку установки если уже установлено
  if (installPwaContainer) {
    installPwaContainer.style.display = 'none';
  }
}
</script>

<!-- Service Worker для PWA и автообновления -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then((registration) => {
        console.log('✅ Service Worker зарегистрирован:', registration.scope);
        
        // Проверка обновлений каждые 30 минут (не влияет на производительность)
        setInterval(() => {
          registration.update();
        }, 30 * 60 * 1000);
        
        // Дополнительная проверка при возвращении на вкладку (без нагрузки)
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            registration.update();
          }
        });
        
        // Обработка обновлений
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // Новая версия доступна - обновляем автоматически!
              console.log('🔄 Найдена новая версия - автоматическое обновление...');
              
              // Активируем новый Service Worker и перезагружаем
              newWorker.postMessage({ action: 'skipWaiting' });
              
              // Небольшая задержка для плавности
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            }
          });
        });
      })
      .catch((error) => {
        console.error('❌ Ошибка регистрации Service Worker:', error);
      });
  });
  
  // Автоматическое обновление при активации нового SW (плавно и незаметно)
  let refreshing = false;
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    if (!refreshing) {
      refreshing = true;
      console.log('✨ Приложение обновлено - перезагрузка...');
      // Обновление происходит плавно
      window.location.reload();
    }
  });
}
</script>

</body>
</html>